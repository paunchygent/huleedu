---
id: "020.16-email-service-architecture"
type: "service"
created: 2025-08-24
last_updated: 2025-11-17
scope: "backend"
parent_rule: "020-architectural-mandates"
service_name: "email_service"
---
# 020.16: Email Service Architecture

## 1. Service Identity
- **Package**: `huleedu-email-service`
- **Type**: Kafka consumer + HTTP dev API (port 8082, metrics 9098)
- **Stack**: Python 3.11, Quart, PostgreSQL, aiosmtplib, Jinja2, aiokafka
- **Purpose**: Transactional email delivery with provider abstraction and template rendering

## 2. Core Architecture

### 2.1. Service Structure
```
services/email_service/
├── app.py                      # Quart app setup with Kafka consumer
├── kafka_consumer.py           # aiokafka consumer lifecycle
├── event_processor.py          # Event routing and processing
├── api/                        # HTTP endpoints
│   ├── health_routes.py        # /healthz, /metrics
│   └── dev_routes.py           # /v1/emails/dev/* (development only)
├── implementations/            # Service implementations
│   ├── provider_mock_impl.py   # Mock provider (testing/dev)
│   ├── provider_smtp_impl.py   # SMTP provider (Namecheap Private Email)
│   ├── template_renderer_impl.py # Jinja2 template engine
│   ├── repository_impl.py      # PostgreSQL persistence
│   └── outbox_manager.py       # Transactional outbox pattern
├── templates/                  # Jinja2 email templates
│   ├── verification.html.j2    # Email verification with token
│   ├── welcome.html.j2         # User welcome email
│   └── password_reset.html.j2  # Password reset with token
├── protocols.py                # EmailProvider, TemplateRenderer protocols
├── di.py                       # Dishka configuration
├── models_db.py                # SQLAlchemy models
└── config.py                   # Environment configuration
```

### 2.2. Core Responsibilities
- **Event Consumption**: Processes `NotificationEmailRequestedV1` from Identity Service
- **Template Rendering**: Jinja2 templates with variable substitution and subject extraction
- **Provider Abstraction**: Runtime switching between mock and SMTP providers
- **Transactional Delivery**: PostgreSQL persistence with outbox pattern for reliability
- **Development Support**: HTTP dev API for testing and template validation

## 3. Critical Design Decisions

### 3.1. Provider Pattern
- **Runtime Switching**: `EMAIL_EMAIL_PROVIDER=mock|smtp` environment variable
- **Mock Provider**: Deterministic testing with configurable failure rates
- **SMTP Provider**: Namecheap Private Email with TLS, connection pooling, retry logic
- **Protocol Abstraction**: `EmailProvider` protocol for clean separation

### 3.2. Template System
```python
# Subject extraction from HTML comments
<!-- subject: Reset your HuleEdu password -->

# Variable substitution with fallbacks
{{ user_name|default('there') }}
{{ expires_in|default('1 hour') }}
{{ current_year|default('2025') }}
```

### 3.3. Event-Driven Processing
- **Single Event Type**: Consumes only `NotificationEmailRequestedV1`
- **Idempotency**: Message ID based deduplication
- **Failure Handling**: Retry logic with exponential backoff
- **Success/Failure Events**: Publishes `EmailSentV1`/`EmailDeliveryFailedV1` via outbox

### 3.4. Transactional Outbox Pattern
- **Database First**: EmailRecord persisted before sending
- **Reliable Publishing**: Outbox ensures events are published even after failures
- **Correlation Tracking**: Full audit trail with correlation IDs

## 4. Integration Points

### 4.1. Upstream Services
- **Identity Service**: Via NotificationOrchestrator → `NotificationEmailRequestedV1`
- **Templates**: Local Jinja2 templates with authentication tokens and user data

### 4.2. Downstream Integrations
- **SMTP Provider**: Namecheap Private Email (mail.privateemail.com:587)
- **Event Publishing**: Success/failure events to Result Aggregator Service

### 4.3. Development Integration
- **HTTP Dev API**: Direct email testing bypassing Kafka
- **Template Validation**: Live template rendering with variable validation

## 5. Performance Requirements
- **Email Processing**: <2s per email including template rendering
- **Provider Switching**: Zero-downtime runtime switching
- **Template Rendering**: <100ms for complex templates
- **Outbox Processing**: <5s for event publishing

## 6. Production Patterns
- **MUST** use transactional outbox pattern for all event publishing
- **MUST** implement provider circuit breakers for SMTP failures
- **MUST** validate all template variables before rendering
- **MUST** sanitize email addresses and prevent injection attacks
- **MUST** implement retry logic with exponential backoff for SMTP failures
- **MUST** use structured error handling from huleedu_service_libs

## 7. Template Standards
- **Subject Extraction**: `<!-- subject: Title -->` HTML comments
- **Variable Fallbacks**: All variables must have sensible defaults
- **Token Security**: Authentication tokens passed via secure variables only
- **Link Construction**: Full URLs with HTTPS for all action links
