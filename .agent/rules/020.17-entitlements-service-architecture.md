---
id: "020.17-entitlements-service-architecture"
type: "service"
created: 2025-08-31
last_updated: 2025-11-17
scope: "backend"
parent_rule: "020-architectural-mandates"
service_name: "entitlements_service"
---
# 020.17: Entitlements Service Architecture

## Purpose
Authoritative credit accounting for HuleEdu. Attributes resource consumption to the correct subject using an org-first, user-fallback identity model.

## Core Responsibilities
- Consume `ResourceConsumptionV1` events and persist debit records.
- Attribute credits to `org_id` when present; otherwise attribute to `user_id`.
- Maintain counters and limits by organization and by user.
- Expose reporting and audit endpoints for platform operators.

## Identity Attribution (Org-First)
1. If `org_id` is present → attribute consumption to organization (primary key).
2. Else → attribute to `user_id` (fallback).
3. All records retain both fields (nullable `org_id`) for auditability.

## Event Integration
- Topic (example): `huleedu.metrics.resource.consumption.v1`
- Envelope: `EventEnvelope[ResourceConsumptionV1]`
- Required identity fields in payload or metadata:
  - `user_id: str` (required)
  - `org_id: str | None` (optional)
- Consumers MUST honor `envelope.metadata` for auxiliary identity when payload uses a thin contract.

## Data Model (Sketch)
- `consumption_records` table:
  - `id` (UUID PK), `event_id` (UUID, unique), `timestamp` (UTC)
  - `user_id` (str, not null)
  - `org_id` (str, null)
  - `resource_type` (enum), `units` (numeric), `source_service` (str)
  - `correlation_id` (UUID), `trace_id` (optional)

## Observability & SLAs
- Prometheus metrics: totals by `resource_type`, `org_id`/`user_id`, error rates.
- Tracing boundary: decode envelope headers first; include correlation IDs in logs.

## Configuration
- Environment-aware database URL, connection pool.
- Idempotency window for duplicate events (by `event_id`).
- Soft enforcement thresholds for rate limiting or alerting.

## Security
- Principle of least privilege for write paths.
- Read-only reporting endpoints gated by operator roles.

## Notes
- The service is write-optimized for event ingestion; reporting paths may use materialized views.
- Works in tandem with API Gateway org_id extraction and downstream services that propagate identity.

## HTTP APIs
- Bulk Credit Check: `POST /v1/entitlements/check-credits/bulk`
  - Request: `{ user_id: str, org_id?: str, requirements: { [metric]: int }, correlation_id?: str }`
  - Responses:
    - 200: Allowed with `{ allowed: true, required_credits, available_credits, per_metric, correlation_id }`
    - 402: Denied with `{ allowed: false, denial_reason: "insufficient_credits", required_credits, available_credits, per_metric, correlation_id }`
    - 429: Rate-limited with `{ allowed: false, denial_reason: "rate_limit_exceeded", required_credits, available_credits: 0, per_metric, correlation_id }`
  - Implementation: `services/entitlements_service/api/entitlements_routes.py`

- Consume Credits (post-usage): `POST /v1/entitlements/consume-credits`
  - Optimistic consumption; persisted with audit trail and outbox publication.

## Preflight Semantics
- Authority: Entitlements is the primary preflight authority; BOS computes requirements and calls bulk endpoint.
- Identity: Org-first selection; fallback to user. Per-metric rate limits are evaluated user-scoped before balances.
- Mapping: BOS internal preflight route (`/internal/v1/batches/{batch_id}/pipelines/{phase}/preflight`) mirrors 200/402/429 semantics and fields.
