---
id: 020.21-bff-teacher-service
type: service
created: '2025-12-08'
last_updated: '2025-12-08'
scope: backend
parent_rule: 020-architectural-mandates
service_name: bff_teacher_service
---

# 020.21: BFF Teacher Service Architecture

## 1. Service Identity

- **Package**: `huleedu-bff-teacher-service`
- **Folders**: `services/bff_teacher_service/`
- **Port**: 4101 (internal Docker)
- **Stack**: FastAPI, Uvicorn, Dishka, httpx
- **Purpose**: Backend-for-Frontend service for teacher-facing screens. Aggregates data from internal microservices and serves Vue 3 frontend static assets.

## 2. Core Responsibilities

### 2.1. API Composition

The BFF aggregates data from multiple backend services into screen-optimized responses:

- **Result Aggregator Service (RAS)**: Batch statuses, essay results, progress
- **Class Management Service (CMS)**: Class names, student associations
- **Content Service**: Essay content retrieval
- **File Service**: File metadata

### 2.2. Static Asset Serving

Serves pre-built Vue 3 frontend:

- `/assets/*` - Static CSS, JS bundles
- `/*` - SPA fallback (index.html)
- `/healthz` - Health check endpoint

### 2.3. Screen-Specific DTOs

Located in `dto/teacher_v1.py`:

- DTOs are view models optimized for frontend consumption
- Use `common_core.status_enums` for consistency with backend
- Do NOT duplicate common_core contracts

## 3. Directory Structure

```
services/bff_teacher_service/
├── app.py                  # FastAPI app (middleware, router registration)
├── config.py               # Pydantic settings
├── di.py                   # Dishka DI providers (future)
├── api/
│   └── v1/
│       └── teacher_routes.py   # Screen endpoints
├── dto/
│   └── teacher_v1.py           # View model DTOs
├── clients/                    # HTTP clients for backend services
│   ├── ras_client.py
│   └── cms_client.py
├── Dockerfile
└── tests/
```

## 4. API Gateway Integration

The API Gateway proxies `/bff/v1/teacher/*` requests to this service.

**Gateway configuration** (`services/api_gateway_service/config.py`):

```python
BFF_TEACHER_URL: str = Field(
    default="http://bff_teacher_service:4101",
    description="BFF Teacher Service base URL",
)
```

**Gateway router** (`services/api_gateway_service/routers/bff_teacher_routes.py`):

- Proxies all methods (GET, POST, PUT, DELETE)
- Injects identity headers: `X-User-ID`, `X-Correlation-ID`, `X-Org-ID`
- Route prefix: `/bff/v1/teacher`

## 5. Request Flow

```
Client → API Gateway (8080) → BFF Teacher (4101) → Backend Services
         ├── JWT validation                      ├── RAS (4003)
         ├── Rate limiting                       ├── CMS (5002)
         └── Identity injection                  └── Content (8001)
```

## 6. Implementation Patterns

### 6.1. API Routes

API routes must be registered BEFORE the SPA fallback route:

```python
# In app.py
app.include_router(teacher_router_v1, prefix="/bff/v1/teacher", tags=["Teacher API"])

# SPA fallback MUST come last
@app.get("/{full_path:path}", include_in_schema=False)
async def serve_spa(full_path: str): ...
```

### 6.2. Backend Service Calls

Use httpx with Dishka DI:

```python
@router.get("/dashboard")
async def get_dashboard(
    ras_client: FromDishka[RASClientProtocol],
    cms_client: FromDishka[CMSClientProtocol],
    user_id: str = Header(..., alias="X-User-ID"),
) -> TeacherDashboardResponseV1:
    # Parallel calls when independent
    batches, classes = await asyncio.gather(
        ras_client.get_batches_for_user(user_id),
        cms_client.get_classes_for_teacher(user_id),
    )
    ...
```

### 6.3. Error Handling

Use `huleedu_service_libs.error_handling.fastapi`:

```python
from huleedu_service_libs.error_handling.fastapi import register_error_handlers

register_error_handlers(app)
```

## 7. Configuration

Environment variables (prefix: `BFF_TEACHER_SERVICE_`):

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | 4101 | HTTP server port |
| `HOST` | 0.0.0.0 | HTTP server host |
| `STATIC_DIR` | /app/static | Frontend static files |
| `LOG_LEVEL` | INFO | Logging level |
| `CORS_ORIGINS` | localhost:5173,4173,3000 | Allowed CORS origins |

## 8. Related Documentation

- **ADR-0007**: BFF vs API Gateway Pattern
- **ADR-0023**: BFF Frontend Build Integration and Static Serving
- **Runbook**: `docs/operations/bff-and-frontend-development.md`
- **Implementation Plan**: `frontend/TASKS/integration/bff-service-implementation-plan.md`
