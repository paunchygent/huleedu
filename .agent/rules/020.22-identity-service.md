---
id: 020.22-identity-service
type: service
created: '2025-12-23'
last_updated: '2025-12-23'
scope: backend
parent_rule: 020-architectural-mandates
service_name: identity_service
---

# 020.22: Identity Service Architecture

## 1. Service Identity

- **Package**: `huleedu-identity-service`
- **Folders**: `services/identity_service/`
- **Port**: 7005 (internal Docker)
- **Stack**: Quart, Hypercorn, Dishka, SQLAlchemy (asyncpg), Alembic, Pydantic
- **Purpose**: Centralized identity and access management (IAM). Handles user registration, authentication, session management, and profile data persistence.

## 2. Core Responsibilities

### 2.1. Authentication & Authorization

- **User Registration**: Validates and creates new user accounts with Argon2id password hashing.
- **Login/Logout**: Authenticates users and manages refresh sessions.
- **Token Issuance**: Mints JWT access tokens (RS256 in prod, HS256 in dev) and refresh tokens.
- **Password Management**: Handles password resets and updates via secure email flows.
- **Email Verification**: Manages verification tokens and status.

### 2.2. User Management

- **User Persistence**: Stores user core identity data (email, password hash, roles).
- **Profile Management**: Manages user profiles (names, preferences) via `UserProfile`.
- **Session Tracking**: Tracks active refresh sessions in Redis and DB for revocation.

### 2.3. Event Publishing

Uses **Transactional Outbox Pattern** to publish domain events:

- `UserRegisteredV1`: New user signup.
- `LoginSucceededV1`: Successful user login.
- `EmailVerificationRequestedV1`: Trigger email to user.
- `PasswordResetRequestedV1`: Trigger reset link email.

## 3. Directory Structure

```
services/identity_service/
├── app.py                  # Quart app entry point
├── config.py               # Pydantic settings
├── di.py                   # Dishka DI providers
├── protocols.py            # Dependency interfaces
├── models_db.py            # SQLAlchemy ORM models
├── api/                    # HTTP Blueprints
│   ├── auth_routes.py          # Login/Logout/Refresh
│   ├── registration_routes.py  # Sign up
│   ├── profile_routes.py       # User profile operations
│   ├── verification_routes.py  # Email verification
│   └── ...
├── domain_handlers/        # Business logic (Transaction Script pattern)
│   ├── registration_handler.py
│   ├── authentication_handler.py
│   └── ...
├── implementations/        # Interface implementations
│   ├── user_repository_sqlalchemy_impl.py
│   ├── event_publisher_impl.py
│   └── ...
├── alembic/                # Database migrations
└── tests/
```

## 4. API Gateway Integration

The API Gateway routes auth-related requests to this service.

**Gateway configuration**:
- **Prefix**: `/auth` and `/identity`
- **Public Routes**: `/auth/login`, `/auth/register`, `/auth/refresh`, `/auth/verify-email`, `/auth/request-password-reset`
- **Protected Routes**: `/identity/me`, `/identity/profile`

## 5. Implementation Patterns

### 5.1. Domain Handlers

Business logic is encapsulated in `domain_handlers/`, not in routes. Routes delegate immediately to handlers.

```python
# services/identity_service/api/registration_routes.py
@bp.post("/register")
@inject
async def register(
    registration_handler: FromDishka[RegistrationHandler],
) -> tuple[Response, int]:
    # ... extraction ...
    result = await registration_handler.register_user(...)
    return jsonify(result.to_dict()), 201
```

### 5.2. Transactional Outbox

Events are published atomically with DB changes using `EventEnvelope` and the outbox table.

```python
# services/identity_service/implementations/event_publisher_impl.py
async def publish_user_registered(self, user: dict, correlation_id: str) -> None:
    # ... payload creation ...
    await self.outbox_manager.publish_to_outbox(
        aggregate_type="user",
        aggregate_id=user["id"],
        event_type=topic_name(ProcessingEvent.IDENTITY_USER_REGISTERED),
        data=envelope,
    )
```

### 5.3. Dependency Injection

Uses **Dishka** for DI, with strict separation of interface (`protocols.py`) and implementation (`implementations/`).

- **Scope.APP**: Settings, Kafka Producer, Password Hasher
- **Scope.REQUEST**: DB Session, Repositories, Domain Handlers

## 6. Configuration

Environment variables (prefix: `IDENTITY_SERVICE_`):

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | 7005 | HTTP server port |
| `DB_HOST` | identity_db | Postgres host |
| `DB_NAME` | huleedu_identity | Database name |
| `JWT_ACCESS_TOKEN_TTL_SECONDS` | 900 | Access token lifetime (15m) |
| `JWT_REFRESH_TOKEN_TTL_SECONDS` | 604800 | Refresh token lifetime (7d) |
| `JWT_ISSUER` | huleedu-identity-service | Token issuer claim |

## 7. Related Documentation

- **ADR-00XX**: Auth Strategy (JWT + Refresh Tokens)
- **Schema**: `services/identity_service/models_db.py`
- **Events**: `libs/common_core/src/common_core/identity_models.py`
