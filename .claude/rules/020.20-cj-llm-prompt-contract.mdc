---
description: Canonical map of where CJ prompt components and system prompt overrides live so agents can reference concrete files quickly.
globs:
  - "services/cj_assessment_service/**"
  - "services/llm_provider_service/**"
  - "scripts/cj_experiments_runners/eng5_np/**"
---

# 020.20: CJ → LLM Prompt Contract Reference

Use this rule whenever you need to locate or update the text that reaches Anthropic/OpenAI/etc. during ENG5 comparative judgement runs.

## Prompt Sections (CJ Assessment Service)
- **Student Assignment**: hydrated inside `event_processor.py: converted_request_data["student_prompt_text"]`, then rendered by `_build_comparison_prompt()` in `services/cj_assessment_service/cj_core_logic/pair_generation.py:278-305` as the `**Student Assignment:**` block.
- **Assessment Criteria**: comes from `assessment_instructions.instructions_text`, fetched in `_fetch_assessment_context()` (`pair_generation.py:195-255`) and emitted as `**Assessment Criteria:**` inside `_build_comparison_prompt()` (`pair_generation.py:301-304`).
- **Judge Instructions / Rubric**: copied from `processing_metadata["judge_rubric_text"]` or hydrated via Content Service in `_fetch_assessment_context()`; rendered in `_build_comparison_prompt()` (`pair_generation.py:304-312`).
- **Essays A/B**: instances of `EssayForComparison` (`services/cj_assessment_service/models_api.py:21-34`) whose `text_content` is appended under `**Essay A (ID: …)**` / `**Essay B (ID: …)**` in `_build_comparison_prompt()` (`pair_generation.py:312-320`).
- **Response Instructions**: the final paragraph inside `_build_comparison_prompt()` (`pair_generation.py:320-327`) describes the JSON contract (winner/justification/confidence) that must be honored by downstream providers.

## System Prompt Hierarchy
The system prompt follows a three-tier hierarchy:

1. **Event-Level Override (Highest Priority)**: Explicit override via `llm_config_overrides.system_prompt_override` in Kafka events
2. **CJ Assessment Default (Middle Priority)**: Canonical CJ prompt from `services/cj_assessment_service/config.py:194-210` (SYSTEM_PROMPT)
3. **LLM Provider Fallback (Lowest Priority)**: Minimal generic prompt (unreachable for CJ workflows)

### CJ Assessment Default System Prompt
- **Location**: `services/cj_assessment_service/config.py:194-210`
- **Content**: Impartial Comparative Judgement assessor role with neutrality constraints, rubric adherence, 50-word justification limit, 0-5 confidence scale, and tool schema requirements
- **Applied**: Automatically used by all CJ workflows unless explicitly overridden via event
- **Injection Points**:
  - `services/cj_assessment_service/cj_core_logic/comparison_processing.py:106` (main batch entry)
  - `services/cj_assessment_service/cj_core_logic/comparison_processing.py:242` (iteration processing)
  - `services/cj_assessment_service/cj_core_logic/batch_processor.py:249` (alternative entry)

### ENG5 Runner Override Behavior
- **With `--cj-system-prompt` (default)**: ENG5 custom prompt from `scripts/cj_experiments_runners/eng5_np/system_prompt.py` overrides CJ default
- **With `--no-cj-system-prompt`**: Falls back to CJ Assessment default (NOT LLM Provider minimal)
- **Integration**: ENG5 runner builds `LLMConfigOverrides` in `scripts/cj_experiments_runners/eng5_np/cli.py:431-437`, flowing through event schema `libs/common_core/src/common_core/events/cj_assessment_events.py:78-108`

### LLM Provider Fallback
- **Location**: `services/llm_provider_service/implementations/anthropic_provider_impl.py:112-115` (and other providers)
- **Content**: "You are an LLM comparison engine. Follow the caller-supplied instructions..."
- **Status**: Unreachable for CJ workflows (CJ always provides a prompt)

## ENG5 Runner Overrides
- The ENG5 runner builds `LLMConfigOverrides` in `scripts/cj_experiments_runners/eng5_np/cli.py:208-244`, covering provider/model/temperature/max-tokens plus the `--cj-system-prompt` flag that injects the canonical CJ system prompt (sourced from `scripts/cj_experiments_runners/eng5_np/system_prompt.py`).
- All runner-emitted overrides flow through the shared event schema `libs/common_core/src/common_core/events/cj_assessment_events.py:78-101` (look here before changing contract fields).

Keep this map in mind before editing prompts, adding metadata, or questioning “which file owns the system prompt?”—the locations above are the single sources of truth referenced by Anthropic during production comparisons.
