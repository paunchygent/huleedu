---
description: Defines the Essay Lifecycle Service (ELS). Manages individual essay state via a Kafka worker and HTTP API. Uses three-tier repository pattern for persistence and coordinates with the Batch Orchestrator Service.
globs: 
alwaysApply: false
---
# 020.5: Essay Lifecycle Service Architecture

**STATUS**: ✅ **OPERATIONAL** - Service tested and confirmed working (Jan 2025)
- **Health Endpoint**: `/healthz` returns HTTP 200 with service status
- **Metrics Endpoint**: `/metrics` returns Prometheus metrics with request counters and duration histograms
- **Container**: Running successfully on port 6001 with proper health checks

## 1. Service Identity
- **Package**: `huleedu-essay-lifecycle-service`  
- **HTTP Port**: 6000 (API), **Metrics Port**: 6001
- **Stack**: Quart, aiokafka, Hypercorn
- **Purpose**: Essay slot assignment, state management, and command processing

## 2. Dual Architecture Pattern

### 2.1. HTTP API (`app.py`)
- **GET /healthz**: Service health
- **GET /metrics**: Prometheus metrics
- **Future**: Essay status queries, manual state transitions

### 2.2. Kafka Worker (`worker_main.py`)  
- **Consumer**: Batch coordination events
- **Producer**: Essay lifecycle state updates
- **Topics**: `huleedu.batch.coordination.*`

## 3. Core Components

### 3.1. Assignment Architecture
- **Service Flow**: BOS → ELS ← File Service (unchanged)
- **Events**: `BatchEssaysRegistered` → slot creation, `EssayContentProvisionedV1` → assignment
- **Pattern**: Option B single-statement PostgreSQL assignment
- **Implementation**: `assignment_sql.assign_via_essay_states_immediate_commit()`
- **Transaction**: Immediate commit for MVCC visibility
- **Inventory**: `essay_states` table only (status IN ('UPLOADED', 'READY_FOR_PROCESSING'))
- **DI**: `NoopSlotOperations` placeholder satisfies `SlotOperationsProtocol`

### 3.2. Command Processing
- **`batch_command_handlers.py`**: BOS command routing and event handlers
- **`implementations/batch_command_handler_impl.py`**: Command processing logic
- **`implementations/service_request_dispatcher.py`**: ELS → specialized service dispatch
- **Phase 1 Behavior**: Stateless event routing without essay state updates
- **Phase 2+ Behavior**: Normal command processing with essay state updates

## 4. Event Integration

### 4.1. Consumed Events
- `BATCH_ESSAYS_REGISTERED`: BOS slot registration
- `ESSAY_CONTENT_PROVISIONED`: File Service content provisioning
- `BATCH_SERVICE_STUDENT_MATCHING_INITIATE_COMMAND`: Phase 1 student matching (stateless routing)
- `STUDENT_ASSOCIATIONS_CONFIRMED`: Phase 1 completion (stateless routing)
- `BATCH_SPELLCHECK_INITIATE_COMMAND`: Phase 2+ spellcheck commands

### 4.2. Published Events  
- `BATCH_CONTENT_PROVISIONING_COMPLETED`: Content readiness notification
- `BATCH_STUDENT_MATCHING_REQUESTED`: Phase 1 NLP requests (stateless)
- `BATCH_ESSAYS_READY`: Complete batch readiness after Phase 1
- `ESSAY_LIFECYCLE_SPELLCHECK_REQUEST`: Phase 2+ spellcheck requests

## 5. Configuration

**Environment Variables**:
- `HTTP_PORT` (default: 6000), `METRICS_PORT` (default: 6001)
- `KAFKA_BOOTSTRAP_SERVERS`, `KAFKA_CONSUMER_GROUP_ID`
- `USE_MOCK_REPOSITORY` (default: true for testing)
- `LOG_LEVEL`, `KAFKA_*` consumer settings

## 6. Repository Pattern

**Three-Tier Architecture**:
- **MockEssayRepository**: Fast in-memory testing implementation
- **PostgreSQLEssayRepository**: Production database implementation
- **Docker Environment**: End-to-end testing with full database

**Schema**: PostgreSQL tables managed via Alembic migrations

## 7. Dependencies

**Core**: quart, hypercorn, aiokafka, asyncpg, sqlalchemy
**HuleEdu**: huleedu-common-core, huleedu-service-libs
**DI**: dishka, quart-dishka

## 8. Deployment

**Docker**: Multi-stage with HTTP API and Kafka worker
**Commands**: `pdm run start-http`, `pdm run start-worker`, `pdm run dev`
**Health**: HTTP healthz endpoint and Kafka consumer health

## 9. Error Handling

**HuleEduError Integration**: All error scenarios use factory functions (`raise_resource_not_found()`, `raise_processing_error()`, `raise_kafka_publish_error()`) with structured error codes and correlation ID propagation for distributed tracing.

**Structured Error Handling**: ErrorDetail model with timestamp, service, operation, correlation_id fields. OpenTelemetry integration automatically records exceptions in spans for distributed coordination debugging.

**Contract Testing Infrastructure**: 14 comprehensive error contract tests validate ErrorDetail serialization, HuleEduError wrapping, correlation ID preservation, and cross-service propagation patterns.

**Error Testing Utilities**: `services/essay_lifecycle_service/tests/conftest.py` provides `assert_huleedu_error()`, `expect_huleedu_error()`, and correlation validation utilities following Rule 070 protocol-based testing patterns.

## 10. Production Implementation Standards

### 10.1. Mandatory Production Patterns
- **MUST** implement graceful shutdown with proper async resource cleanup
- **MUST** use DI-managed `aiohttp.ClientSession` with configured timeouts
- **MUST** use manual Kafka commits with error boundaries (no auto-commit)
- **MUST** implement `/healthz` with consistent JSON response format
- **MUST** fail fast on startup errors with `logger.critical()` and `raise`

## 11. Monitoring

**Metrics**: HTTP requests, Kafka processing, database operations
**Logging**: Correlation ID tracking, state change audit trail
**Health**: Repository connectivity, Kafka consumer lag

## 11. Future Evolution

**Planned**: REST API for essay queries, manual state overrides, batch analytics
**Events**: Fine-grained essay state change events for downstream services
