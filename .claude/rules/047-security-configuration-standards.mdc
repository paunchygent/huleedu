---
description: Security configuration patterns for HuleEdu services
globs: 
alwaysApply: false
---
# 047: Security Configuration Standards

## 1. Purpose
Security configuration patterns and standards for HuleEdu microservices, covering JWT tokens, secrets management, and environment-aware security controls.

Model service: `@identity_service/`

**Related Rules**:
- [040-service-implementation-guidelines.mdc](mdc:040-service-implementation-guidelines.mdc) - Core service patterns
- [043-service-configuration-and-logging.mdc](mdc:043-service-configuration-and-logging.mdc) - Configuration management

## 2. SecureServiceSettings Base Class

### 2.1. Inheritance Pattern
```python
# config.py - MUST inherit from SecureServiceSettings
from huleedu_service_libs.config import SecureServiceSettings
from pydantic import Field, SecretStr
from pydantic_settings import SettingsConfigDict

class Settings(SecureServiceSettings):
    model_config = SettingsConfigDict(env_prefix="SERVICE_", extra="ignore")
    
    # Service identity
    SERVICE_NAME: str = "service_name"
    SERVICE_VERSION: str = "0.1.0"
    
    # Security-specific fields here
```

### 2.2. Environment Detection Methods
```python
# Available from SecureServiceSettings base class
settings.is_production()  # Environment.PRODUCTION
settings.is_development() # Environment.DEVELOPMENT  
settings.is_staging()     # Environment.STAGING
settings.is_testing()     # Environment.TESTING
settings.requires_security() # Production or Staging
```

## 3. JWT Configuration Patterns

### 3.1. Development vs Production JWT
```python
# JWT configuration with environment-aware defaults
JWT_DEV_SECRET: SecretStr = Field(
    default=SecretStr("dev-secret-change-me"),
    description="JWT signing secret for development environment"
)
JWT_ACCESS_TOKEN_EXPIRES_SECONDS: int = 3600

# RS256 for production (preferred)
JWT_RS256_PRIVATE_KEY_PATH: SecretStr | None = Field(
    default=None, 
    description="Path to RS256 private key for production JWT signing"
)
JWT_RS256_PUBLIC_JWKS_KID: str | None = None

def get_jwt_secret(self) -> SecretStr:
    """Get environment-appropriate JWT secret."""
    if self.is_production() and self.JWT_RS256_PRIVATE_KEY_PATH:
        return self.JWT_RS256_PRIVATE_KEY_PATH
    return self.JWT_DEV_SECRET
```

### 3.2. Token Expiration Standards
- **Access Tokens**: 3600 seconds (1 hour) default
- **Refresh Tokens**: 24x access token duration (24 hours default)
- **Verification Tokens**: Service-specific, typically 24-48 hours
- **Reset Tokens**: Short-lived, typically 1-4 hours

## 4. Secrets Management

### 4.1. SecretStr Usage
```python
# MUST use SecretStr for all sensitive configuration
API_KEY: SecretStr = Field(default=SecretStr(""), description="External API key")
DATABASE_PASSWORD: SecretStr = Field(validation_alias="HULEEDU_DB_PASSWORD")

# Access secret values only when needed
api_key = settings.API_KEY.get_secret_value()
```

### 4.2. Secure String Representations
```python
# SecureServiceSettings automatically provides secure __str__ and __repr__
def __str__(self) -> str:
    return (
        f"{self.__class__.__name__}("
        f"service={self.SERVICE_NAME}, "
        f"environment={self.ENVIRONMENT.value}, "
        f"secrets=***MASKED***)"
    )

def __repr__(self) -> str:
    return self.__str__()
```

## 5. Database Security Patterns

### 5.1. Environment-Aware Database URLs
```python
@property
def database_url(self) -> str:
    """Environment-aware database connection."""
    import os
    
    # Container/Production override
    env_url = os.getenv("SERVICE_DATABASE_URL")
    if env_url:
        return env_url
    
    if self.is_production():
        # Production credentials
        creds = self.get_production_database_credentials()
        return f"postgresql+asyncpg://{creds['user']}:{creds['password']}@{creds['host']}:{creds['port']}/huleedu_{service_name}"
    else:
        # Development: localhost with per-service port
        creds = self.get_shared_database_credentials()
        return f"postgresql+asyncpg://{creds['db_user']}:{creds['db_password']}@localhost:{service_port}/huleedu_{service_name}"

def get_database_url_masked(self) -> str:
    """Return database URL with masked password for logging."""
    return self.database_url_masked(self.database_url)
```

### 5.2. Credential Helpers
```python
# Available from SecureServiceSettings
creds = settings.get_shared_database_credentials()  # Development
prod_creds = settings.get_production_database_credentials()  # Production only

# Returns dict with validated credentials or raises ValueError
```

## 6. Environment Variable Patterns

### 6.1. Service-Specific Prefixes
```python
# Use service-specific environment variable prefixes
model_config = SettingsConfigDict(env_prefix="IDENTITY_", extra="ignore")

# Results in: IDENTITY_JWT_DEV_SECRET, IDENTITY_LOG_LEVEL, etc.
```

### 6.2. Shared Environment Variables
```python
# Some variables are shared across services (no prefix override)
ENVIRONMENT: Environment = Field(validation_alias="ENVIRONMENT")
DB_PASSWORD: SecretStr = Field(validation_alias="HULEEDU_DB_PASSWORD")
INTERNAL_API_KEY: SecretStr = Field(validation_alias="HULEEDU_INTERNAL_API_KEY")
```

## 7. Security Configuration Checklist

### 7.1. Development Environment
- [ ] Default development secrets that are obviously insecure
- [ ] Local database connections with standard ports
- [ ] Relaxed security controls for development ease
- [ ] Dev-only endpoints properly guarded

### 7.2. Production Environment  
- [ ] RS256 JWT signing with proper key rotation capability
- [ ] Strong secret generation and external secret management
- [ ] Secure database connections with encrypted transport
- [ ] All dev-only features disabled
- [ ] Proper CORS, CSRF, and security header configuration

## 8. Security Anti-Patterns

### 8.1. FORBIDDEN Patterns
- **Hardcoded secrets** in source code
- **Plain text passwords** in configuration files
- **Logging sensitive data** (use masked representations)
- **Exposing internal endpoints** in production
- **Using development secrets** in production

### 8.2. Secret Handling Best Practices
```python
# GOOD: Use SecretStr and access only when needed
password = settings.DATABASE_PASSWORD.get_secret_value()
connection = create_connection(password)

# BAD: Storing secrets as plain strings
DATABASE_PASSWORD: str = "plaintext-password"  # FORBIDDEN

# GOOD: Masked logging
logger.info(f"Connecting to {settings.get_database_url_masked()}")

# BAD: Logging sensitive URLs
logger.info(f"Connecting to {settings.database_url}")  # Contains password
```

## 9. Token Validation Standards

### 9.1. JWT Validation Requirements
- **Signature verification** (RS256 in production, HS256 in development)
- **Expiration checks** with proper clock skew tolerance
- **Issuer validation** to prevent token reuse across services
- **Audience validation** for service-specific tokens

### 9.2. Token Storage Security
- **HTTP-only cookies** for web applications
- **Secure flag** in production (HTTPS only)
- **SameSite=Strict** for CSRF protection
- **Short-lived access tokens** with refresh token rotation

## 10. Implementation Examples

### 10.1. Complete Security Configuration
```python
from huleedu_service_libs.config import SecureServiceSettings
from common_core.config_enums import Environment
from pydantic import Field, SecretStr

class Settings(SecureServiceSettings):
    model_config = SettingsConfigDict(env_prefix="EMAIL_", extra="ignore")
    
    SERVICE_NAME: str = "email_service"
    
    # API Keys
    SMTP_PASSWORD: SecretStr = Field(default=SecretStr(""))
    DEV_TOKEN: SecretStr = Field(default=SecretStr(""))
    
    # Environment-specific behavior
    def get_smtp_config(self) -> dict:
        if self.is_production():
            return {
                "host": "mail.privateemail.com",
                "port": 587,
                "username": "no-reply@yourdomain.com",
                "password": self.SMTP_PASSWORD.get_secret_value(),
                "use_tls": True
            }
        else:
            return {"host": "localhost", "port": 1025}  # Development SMTP
```