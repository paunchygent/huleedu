---
description: Distributed tracing patterns with Jaeger and OpenTelemetry
globs: 
alwaysApply: false
---
# 071.2: Jaeger Tracing Patterns

## 1. Service Integration

### 1.1. Framework-Specific Imports
```python
# Quart services
from huleedu_service_libs import init_tracing
from huleedu_service_libs.middleware.frameworks.quart_middleware import setup_tracing_middleware

# FastAPI services
from huleedu_service_libs import init_tracing  
from huleedu_service_libs.middleware.frameworks.fastapi_middleware import setup_tracing_middleware
```

### 1.2. Initialization Pattern
```python
# In startup_setup.py
app.tracer = init_tracing("service_name")
setup_tracing_middleware(app, app.tracer)
```

## 2. Environment Configuration
```yaml
# Required for all services
OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
OTEL_SERVICE_NAME: ${service_name}
OTEL_TRACES_EXPORTER: otlp
OTEL_METRICS_EXPORTER: none
```

## 3. Trace Propagation Patterns

### 3.1. HTTP Propagation
```python
# Automatic via middleware
# Headers: traceparent, tracestate
# Response includes: X-Trace-ID, X-Span-ID
```

### 3.2. Event System Propagation
```python
# Publishing
from huleedu_service_libs.observability import inject_trace_context
metadata = {}
inject_trace_context(metadata)
envelope = EventEnvelope(..., metadata=metadata)

# Consuming
from huleedu_service_libs.observability import extract_trace_context
context = extract_trace_context(envelope.metadata or {})
```

## 4. Custom Instrumentation

### 4.1. Operation Tracing
```python
from huleedu_service_libs.observability import trace_operation

with trace_operation(tracer, "operation_name", {"key": "value"}):
    # Critical path code
```

### 4.2. Span Attributes
```python
# Business context (good)
span.set_attribute("batch_id", batch_id)
span.set_attribute("essay_count", count)

# PII (forbidden)
# Never: user_email, user_name, content
```

## 5. Debugging Workflow
1. Make request â†’ Get `X-Trace-ID` from response
2. Jaeger UI: <http://localhost:16686>
3. Search by trace ID or service name
4. Analyze service dependencies and timing

## 6. Infrastructure
```yaml
# observability/docker-compose.observability.yml
jaeger:
  image: jaegertracing/all-in-one:1.50
  ports:
    - "16686:16686"  # UI
    - "4317:4317"    # OTLP gRPC
  environment:
    - COLLECTOR_OTLP_ENABLED=true
```
