---
id: "071.4-grafana-loki-patterns"
type: "observability"
created: 2025-09-01
last_updated: 2025-11-20
scope: "all"
parent_rule: "071-observability-index"
---

# 071.4: Grafana & Loki Patterns

## 1. Dashboard Structure

### 1.1. Standard Panels
```json
// Every dashboard MUST have
{
  "title": "Service Health",
  "panels": [
    "Service Uptime %",
    "Error Rate by Status Code", 
    "Response Time P95",
    "Request Rate"
  ]
}
```

### 1.2. Time Range Standards
- Default: Last 1 hour
- Options: 1h, 6h, 24h, 7d
- Refresh: 30s for operational, 5m for analytics

## 2. Loki Integration

### 2.1. Log Query Patterns (Updated 2025-11-19)
```logql
# Service logs (basic retrieval)
{service="batch_orchestrator"}
{service="content_service"}

# Filter by log level (indexed label)
{level="error"}
{service="batch_orchestrator", level="error"}

# JSON field extraction (use | json filter for high-cardinality fields)
{service="batch_orchestrator"} | json | correlation_id="abc-123"
{service="essay_lifecycle"} | json | batch_id="xyz"
{service="content_service"} | json | event="Content Service startup completed successfully"

# Correlation ID trace across services (most common debugging pattern)
{service=~".*"} | json | correlation_id="<correlation-id>"

# Error investigation with JSON context
{level="error"} | json | correlation_id!=""
```

**CRITICAL**:
- `correlation_id` is NOT a label (removed 2025-11-19 for cardinality reduction)
- Use `{service="..."} | json | correlation_id="..."` pattern
- Never use `{correlation_id="..."}` directly

### 2.2. Label Strategy (Validated 2025-11-19: 25 Streams)
```yaml
# Promoted labels (LOW cardinality only - indexed for fast queries)
- service        # ~15-20 services (SAFE)
- level          # 5 values: debug, info, warning, error, critical (SAFE)
- container      # Docker container names (SAFE - auto-promoted by Promtail)

# Keep in JSON body only (HIGH cardinality - use | json filter)
- correlation_id  # UUID per request (NEVER promote to label)
- logger_name     # ~50-100 Python loggers (too many for label)
- event           # Log message content (unbounded)
- event_id        # UUID per event (NEVER promote to label)
- user_id         # Unbounded (NEVER promote to label)
- batch_id        # Unbounded (NEVER promote to label)
- request_id      # UUID per request (NEVER promote to label)
```

**Rule**: If a field has >100 unique values/day, it MUST stay in JSON body only.

**Validation**: Current configuration maintains 25 streams total. Promoting high-cardinality fields like `correlation_id` or `logger_name` to labels would create millions of streams and cause Loki performance collapse.

### 2.3. Programmatic Access for LLM Agents

LLM agents and automation scripts use `logcli` for programmatic log access:

**Primary Use Cases**:
- Export log chunks for LLM analysis (`--output=jsonl` → jq filtering → feed to LLM)
- Real-time batch job monitoring (`--tail` for ENG5 runner)
- Automated log queries in debugging workflows

**Configuration**:
```bash
export LOKI_ADDR=http://localhost:3100
```

**Full Documentation**: See `docs/operations/01-grafana-playbook.md` → "Programmatic Log Access with logcli"

**Key Pattern** (LLM log export):
```bash
# Export structured logs for LLM analysis
logcli query '{service="cj_assessment_service", level="error"}' \
  --from="2025-11-19T10:00:00Z" --to="2025-11-19T20:00:00Z" \
  --limit=500 --output=jsonl > logs.jsonl

# Filter and format for LLM
jq -r 'select(.batch_id == "33") | [.timestamp, .event, .message] | @tsv' \
  < logs.jsonl > for_llm.txt
```

## 3. Dashboard Categories

### 3.1. System Overview
- Location: `HuleEdu_System_Health_Overview.json`
- Purpose: Cross-service health at a glance
- Refresh: 30 seconds

### 3.2. Service Deep Dive
- Pattern: `HuleEdu_<Service>_Deep_Dive.json`
- Purpose: Single service detailed metrics
- Includes: Business metrics + operational metrics

### 3.3. Troubleshooting
- Pattern: `HuleEdu_Troubleshooting_<Scenario>.json`
- Purpose: Correlate logs, metrics, traces
- Features: Trace ID lookup, error aggregation

## 4. Grafana Datasources

### 4.1. Configuration
```yaml
# Auto-provisioned via docker
datasources:
  - name: Prometheus
    type: prometheus
    url: http://prometheus:9090
  - name: Loki
    type: loki  
    url: http://loki:3100
  - name: Jaeger
    type: jaeger
    url: http://jaeger:16686
```

### 4.2. Mixed Queries
```sql
# Correlate metrics with logs
metric: rate(http_requests_total[5m])
logs: {service="$service"} |= "ERROR"
```

## 5. Best Practices

### 5.1. Performance
- Avoid regex in high-frequency panels
- Use recording rules for complex calculations
- Limit log queries to specific time ranges

### 5.2. Organization
- Use folders: System, Services, Troubleshooting
- Version control dashboard JSON
- Document panel purposes in descriptions
