---
description: Defines the API Gateway Service. The primary client entry point. Handles JWT auth, proxies requests to downstream services, and provides secure API access.
globs: 
alwaysApply: false
---
# 020.10: API Gateway Service Architecture

## 1. Service Identity
- **Package**: `huleedu-api-gateway-service`
- **Folders**: `services/api_gateway_service/`
- **Port**: 8080 (client-facing and internal Docker)
- **Stack**: FastAPI, Uvicorn, Dishka, `python-jose` & `PyJWT` (for JWT), `slowapi` (for rate limiting)
- **Purpose**: Secure, client-facing entry point for the HuleEdu platform. Handles API requests, authentication, and routing to internal services.

## 2. Core Architectural Patterns

The gateway acts as a mediator and Anti-Corruption Layer, implementing three distinct patterns for backend interaction.

### 2.1. Command Publishing
For asynchronous operations, the gateway publishes commands to Kafka and returns `202 Accepted`.
- **File**: `routers/batch_routes.py`
- **Endpoint**: `POST /v1/batches/{batch_id}/pipelines`
- **Logic**:
    1. Validates `batch_id` consistency between URL path and request body.
    2. Constructs a formal `ClientBatchPipelineRequestV1` event from `common_core`.
    3. Wraps the event in a standard `EventEnvelope`.
    4. Injects tracing context into `envelope.metadata`.
    5. If `org_id` is present in the JWT (see 3.1), records it in `envelope.metadata["org_id"]` to support org-first attribution without changing the client command contract.
    6. Publishes to the `huleedu.commands.batch.pipeline.v1` Kafka topic via the injected `KafkaBus`.

### 2.2. Request Proxying
For synchronous CRUD operations, the gateway proxies requests to the appropriate internal service.
- **File Proxy (`routers/file_routes.py`)**:
    - **Endpoint**: `POST /v1/files/batch`
    - **Logic**: Handles `multipart/form-data`. Injects identity headers and forwards the request to the `file_service`.
      - Always forwards: `X-User-ID`, `X-Correlation-ID`
      - Conditionally forwards: `X-Org-ID` when JWT contains `org_id`

- **Batch Registration Proxy (`routers/batch_routes.py`)**:
    - **Endpoint**: `POST /v1/batches/register`
    - **Logic**:
      1. Accepts client-facing registration model (no identity fields).
      2. Injects `user_id` and optional `org_id` from JWT via DI.
      3. Constructs shared `BatchRegistrationRequestV1` (from `common_core.api_models`).
      4. Proxies to BOS `POST {BOS_URL}/v1/batches/register` with `X-Correlation-ID`.
      5. Returns BOS status and body verbatim (JSON), preserving error details.
    - **Configuration**: `BOS_URL` defines the internal BOS base URL.
- **Class Management Proxy (`routers/class_routes.py`)**:
    - **Endpoint**: `ANY /v1/classes/{path:path}`
    - **Logic**: A generic, streaming proxy. Captures all methods and paths under `/v1/classes/` and streams the request and response to/from the `class_management_service`.
      - Always forwards: `X-User-ID`, `X-Correlation-ID`
      - Conditionally forwards: `X-Org-ID` when JWT contains `org_id`

### 2.3. Query with Status Mapping
For data retrieval, the gateway queries internal services and maps internal status representations to client-facing statuses.
- **File**: `routers/status_routes.py`
- **Endpoint**: `GET /v1/batches/{batch_id}/status`
- **Logic**:
    1.  Queries the `result_aggregator_service` for batch status.
    2.  **Status Mapping**: Maps internal `BatchStatus` (12 values) to client `BatchClientStatus` (7 semantic values) via `map_to_client_status()` function.
    3.  **Status Values**: `pending_content`, `ready`, `processing`, `completed_successfully`, `completed_with_failures`, `failed`, `cancelled`
    4.  **Ownership Enforcement**: Validates that the `user_id` in the downstream service's response payload matches the JWT's `sub` claim.
    5.  **Consistency Guarantee**: REST API returns identical status values as WebSocket notifications.

## 3. Security Implementation

### 3.1. JWT Authentication
- **File**: `app/auth_provider.py`
- **Mechanism**: Request-scope providers extract and validate JWT once per request.
- **Providers**:
    - `provide_user_id(token) -> str`: Validates signature/alg, enforces `exp`, returns `sub`.
    - `provide_org_id(token) -> str | None`: Same validation as above; extracts org identity from configurable claim names.
- **Configuration**:
    - `JWT_ORG_ID_CLAIM_NAMES` (default: `["org_id", "org", "organization_id"]`): Ordered claim names to resolve `org_id`.
    - `JWT_SECRET_KEY`, `JWT_ALGORITHM`: Standard signature validation settings.

## 4. Configuration

- `BOS_URL`: Internal base URL for Batch Orchestrator Service (default `http://batch_orchestrator_service:5000`).

## 5. Architectural Mandates

- API Gateway is the single client-facing entry point for batch registration.
- BOS does not perform JWT validation; identity is injected at the edge by AGW.
- Inter-service registration contract is centralized in `common_core` to avoid drift.

### 3.2. Rate Limiting
- **File**: `app/rate_limiter.py`
- **Mechanism**: Uses `slowapi`. The key is dynamically set to the authenticated `user_id` (from request state) or falls back to the client's IP address.
- **Configuration**: Limits are applied directly to routes via the `@limiter.limit(...)` decorator (e.g., `10/minute`).
