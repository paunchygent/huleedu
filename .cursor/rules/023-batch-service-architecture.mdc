---
description: Defines the architecture and implementation details of the HuleEdu Batch Service
globs: 
alwaysApply: false
---
# 023: Batch Service Architecture

## 1. Service Identity
- **Package**: `huleedu-batch-service`
- **Port**: 5000 (HTTP API)
- **Stack**: Quart, aiokafka, aiohttp, Hypercorn
- **Purpose**: Orchestrates essay processing workflows

## 2. API Endpoints

#### POST /v1/trigger-spellcheck
- **Request**: `{"text": "Essay content..."}`
- **Response**: `{"message": "Spellcheck triggered", "essay_id": "uuid", "correlation_id": "uuid"}`
- **Status**: 202 (accepted), 400 (bad request), 500 (server error)

#### GET /healthz
- **Response**: `{"status": "ok"}`

**Future**: `POST /v1/batch/{batch_id}/initiate-spellcheck`, `GET /v1/batch/{batch_id}/status`, `POST /v1/batch`

## 3. Event Publishing

- **Topic**: `essay.spellcheck.requested.v1`
- **Event Type**: `huleedu.essay.spellcheck.requested.v1`
- **Data Model**: `SpellcheckRequestedDataV1`

**Flow**: HTTP request → Store content → Generate IDs → Create event → Publish → Return response

## 4. Integration Points

- **Content Service**: HTTP REST API via aiohttp.ClientSession
- **Kafka**: KafkaBus wrapper around AIOKafkaProducer

## 5. Configuration

**Environment Variables**:
- `PORT` (default: 5000), `HOST` (default: "0.0.0.0")
- `KAFKA_BOOTSTRAP_SERVERS` (default: "kafka:9092")
- `CONTENT_SERVICE_URL` (default: "http://content_service:8000/v1/content")
- `LOG_LEVEL` (default: INFO)

**Dependencies**: quart, hypercorn, aiokafka, aiohttp, huleedu-common-core, huleedu-service-libs

## 6. Data Models

**Request**: `{"text": "Essay content..."}`

**Published Event**: `SpellcheckRequestedDataV1` with entity_ref, system_metadata, text_storage_id

## 7. Error Handling

**Scenarios**: Content Service unavailable (500), Kafka unavailable (500), Invalid request (400)
**Response**: `{"error": "description", "details": "additional details"}`

## 8. Deployment

**Docker**: `python:3.11-slim` base, PDM package manager, `hypercorn app:app -c hypercorn_config.py`
**Commands**: `pdm run start` (production), `pdm run dev` (development)

## 9. Monitoring

**Logging**: `huleedu_service_libs.logging_utils` with correlation IDs, INFO/ERROR levels
**Future Metrics**: HTTP rate/latency, event publishing success, Content Service calls

## 10. Security

**Current**: No authentication (MVP)
**Future**: API auth, input validation, rate limiting

## 11. Future Evolution

**Planned**: Batch management, advanced status tracking, multi-pipeline orchestration, database integration
**Architectural Notes**: Essay Lifecycle Service (ELS) is implemented as a separate microservice for essay state management and batch coordination
