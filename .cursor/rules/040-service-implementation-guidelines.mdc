---
description: Read before all work on web framework, I/O, API etc
globs: 
alwaysApply: false
---
# 040: Service Implementation Guidelines

## 1. Purpose
High-level, cross-cutting principles and stack requirements for HuleEdu microservice development.

**Related Rules**:
- [041-http-service-blueprint.mdc](mdc:041-http-service-blueprint.mdc) - HTTP service architecture patterns
- [042-async-patterns-and-di.mdc](mdc:042-async-patterns-and-di.mdc) - Async patterns, protocols, and DI
- [043-service-configuration-and-logging.mdc](mdc:043-service-configuration-and-logging.mdc) - Configuration and logging standards

## 2. Core Stack
- **Framework**: Quart for async HTTP services, direct `asyncio` and `aiokafka` for worker services.
- **Dependencies**: PDM exclusively (`pyproject.toml`, `pdm.lock`)
- **Programming**: `async/await` for all I/O operations
- **Protocols**: `typing.Protocol` for behavioral contracts and dependency abstraction
- **Dependency Injection**: Dishka framework with clean architecture patterns
- **Metrics**: Prometheus with standardized `/metrics` endpoints

## 3. Service Types Overview

### 3.1. HTTP Services (Quart-based)
- **MUST** follow Blueprint pattern architecture → See [041-http-service-blueprint.mdc](mdc:041-http-service-blueprint.mdc)
- **MUST** implement standardized `/healthz` and `/metrics` endpoints
- **MUST** use Dishka DI with `quart-dishka` integration

### 3.2. Worker Services (Kafka-based)
- **MUST** follow event processor pattern → See [042-async-patterns-and-di.mdc](mdc:042-async-patterns-and-di.mdc)
- **Structure**: `worker_main.py`, `event_processor.py`, `core_logic.py`, `protocols.py`
- **MUST** use Dishka DI with manual container scoping

## 4. Cross-Cutting Concerns

### 4.1. Protocols and Dependency Injection
- **MUST** define behavioral contracts using `typing.Protocol` → See [042-async-patterns-and-di.mdc](mdc:042-async-patterns-and-di.mdc)
- Business logic **MUST** depend on protocols, not concrete implementations
- **MUST** use Dishka DI framework with appropriate scoping

### 4.2. Metrics and Monitoring
- **MUST** expose Prometheus metrics via `/metrics` endpoint
- **MUST** use centralized metrics collection patterns
- **MUST** implement service-specific health validation logic

### 4.3. State Management
- Each service owns its primary entities' state
- State changes **MUST** be communicated via events
- Follow state transition logic from Architectural Design Blueprint

### 4.4. Configuration Management
- **MUST** use `pydantic-settings` with standardized patterns → See [043-service-configuration-and-logging.mdc](mdc:043-service-configuration-and-logging.mdc)
- **FORBIDDEN**: Hardcoded sensitive information
- **MUST** use environment variables with service-specific prefixes

### 4.5. Logging Standards
- **MUST** use `huleedu_service_libs.logging_utils` → See [043-service-configuration-and-logging.mdc](mdc:043-service-configuration-and-logging.mdc)
- **MANDATORY**: Correlation IDs for all operation chains
- **FORBIDDEN**: Standard library `logging` module in services

## 5. Implementation Checklist
Before implementing any service, ensure you have reviewed:
- [ ] This overview for core stack requirements
- [ ] [041-http-service-blueprint.mdc](mdc:041-http-service-blueprint.mdc) for HTTP service patterns
- [ ] [042-async-patterns-and-di.mdc](mdc:042-async-patterns-and-di.mdc) for async patterns and DI
- [ ] [043-service-configuration-and-logging.mdc](mdc:043-service-configuration-and-logging.mdc) for config and logging
