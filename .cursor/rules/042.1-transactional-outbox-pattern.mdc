---
description: Transactional Outbox Pattern as fallback for Kafka failures
globs: 
alwaysApply: false
---
# 042.1: Transactional Outbox Pattern (Hybrid Approach)

## 1. Core Principle
**Standard Pattern**: All services (BOS, File Service, ELS) use Kafka-first with outbox fallback.  
**ELS Enhancement**: Adds dual Redis publishing for real-time UI updates and session-aware publishing for Unit of Work atomicity.

## 2. Implementation Requirements

### 2.1. Database Schema
```python
from huleedu_service_libs.outbox import EventOutbox
# Requires event_outbox table with ix_event_outbox_unpublished index
```

### 2.2. Event Publisher Pattern
```python
async def publish_event(self, event_data, correlation_id, session=None):
    # 1. Try Kafka first (primary path - 99.9% of events)
    try:
        await self.kafka_bus.publish(topic, envelope, key)
        return  # Success - no outbox needed
    except Exception:
        # 2. Fallback to outbox when Kafka unavailable
        await self._publish_to_outbox(event_data, session=session)
        await self._notify_relay_worker()  # Redis wake-up
    
    # 3. ELS ONLY: Dual Redis publishing for real-time UI
    await self._publish_to_redis_for_realtime(event_data)
```

### 2.3. Session-Aware Publishing (ELS Enhancement)
```python
# Unit of Work pattern with atomic guarantees
async with session_factory() as session:
    async with session.begin():
        await repository.update_entities(data, session=session)
        # Publish within same transaction for atomicity
        await event_publisher.publish_event(
            event_data=data, 
            correlation_id=correlation_id,
            session=session  # Share transaction
        )
```

## 3. Event Relay Worker
- **Wake-up**: Redis BLPOP on `outbox:wake:{service_name}` for instant processing
- **Polling**: Adaptive intervals (0.1s → 5s) based on ENVIRONMENT  
- **Batch**: Up to 100 events per batch with exponential backoff retry

## 4. Required Patterns

✅ **STANDARD**: Kafka-first, outbox fallback, Redis worker wake-up
✅ **ELS ENHANCED**: + Dual Redis publishing + Session-aware publishing  
❌ **FORBIDDEN**: Always using outbox (should try Kafka first)  
❌ **FORBIDDEN**: Ignoring session parameter when provided

## 5. Metrics to Monitor
- **kafka_publish_success_rate**: >99.9%
- **outbox_fallback_rate**: <0.1% 
- **outbox_processing_delay**: <100ms
- **redis_notification_success_rate**: ELS dual publishing