---
description: 
globs: 
alwaysApply: true
---
===
# 070: Testing and Quality Assurance

## 1. Testing Pyramid
- **Unit Tests**: Individual components in isolation (high coverage)
- **Contract Tests**: **CRITICAL** - Verify Pydantic contracts between services
- **Integration Tests**: Limited scope component interactions
- **E2E Tests**: Major user flows (use sparingly)

## 2. Core Rules
- **Runner**: `pdm run pytest`
- **Naming**: `test_*.py` files, `test_*` functions
- **Isolation**: Tests must be independent
- **FORBIDDEN**: Mixing abstraction levels in same test

## 3. Testing Patterns

### 3.1. Dependency Injection
```python
async def process_function(
    core_data, external_dependencies,
    injectable_func_1: Callable, injectable_func_2: Callable,
) -> bool:
```

### 3.2. Async Context Manager Mocking
```python
@asynccontextmanager
async def mock_http_context_manager(mock_response: AsyncMock) -> Any:
    yield mock_response
```

## 4. Execution Rules
- **Command**: `pdm run pytest` (always use PDM)
- **Debug**: `pdm run pytest -s` for print statements
- **FORBIDDEN**: Simplifying tests to make them pass - fix underlying issues

## 5. Anti-Patterns
- **FORBIDDEN**: `try/except pass` blocks hiding model rebuilding failures
- **FORBIDDEN**: Mocking at wrong abstraction levels
- **FORBIDDEN**: Using `AsyncMock()` directly for async context managers

See [051-pydantic-v2-standards.mdc](mdc:051-pydantic-v2-standards.mdc) Section 8.2 for Pydantic testing patterns.

---
**Fix underlying issues, don't simplify tests.**
===
