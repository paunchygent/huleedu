---
description: Core observability patterns and principles for HuleEdu services
globs: 
alwaysApply: false
---
# 071: Observability Core Patterns

## 1. Philosophy
- **Business Insights First**: Metrics answer operational questions
- **Correlation Over Collection**: Better to correlate than collect more
- **Actionable Alerts**: Must have clear resolution steps

## 2. Standard Patterns

### 2.1. Service Identification
```python
# Every service MUST expose standard labels
service_name: str  # e.g., "batch_orchestrator_service"
service_version: str  # from SERVICE_VERSION env var
environment: str  # "development", "production"
```

### 2.2. Correlation Pattern
```python
# All operations MUST propagate correlation_id
correlation_id: UUID  # In logs, metrics labels, traces
```

### 2.3. Structured Logging
```python
# Use service library logger
from huleedu_service_libs.logging_utils import create_service_logger
logger = create_service_logger("service.module")

# Log with context
logger.info("Operation completed", extra={
    "correlation_id": str(correlation_id),
    "batch_id": batch_id,
    "duration_ms": duration
})
```

## 3. Integration Requirements

### 3.1. Every Service MUST
- Expose `/metrics` endpoint (Prometheus format)
- Expose `/healthz` endpoint with dependency checks
- Use structured JSON logging with correlation_id
- Include correlation_id in all telemetry
- Register with Prometheus service discovery

### 3.2. HuleEdu Observability Stack URLs

**External Access (from host machine):**
- **Grafana Dashboard**: http://localhost:3000 (admin/admin)
- **Prometheus Metrics**: http://localhost:9091
- **Alertmanager**: http://localhost:9094/ (note trailing slash)
- **Jaeger Tracing**: http://localhost:16686
- **Loki Logs**: http://localhost:3100 ✅ WORKING

**Internal Container Access (for Grafana data sources):**
- **Prometheus**: `http://prometheus:9090`
- **Loki**: `http://loki:3100` ✅ CONFIRMED WORKING
- **Alertmanager**: `http://alertmanager:9093`
- **Jaeger**: `http://jaeger:16686`

### 3.3. Infrastructure Monitoring Endpoints

| Component | External URL | Metrics |
|-----------|--------------|----------|
| Kafka Exporter | http://localhost:9308 | /metrics |
| PostgreSQL Exporter | http://localhost:9187 | /metrics |
| Redis Exporter | http://localhost:9121 | /metrics |
| Node Exporter | http://localhost:9100 | /metrics |

### 3.2. Observability Stack Location
- Configuration: `observability/docker-compose.observability.yml`
- Dashboards: `observability/grafana/dashboards/`
- Alerts: `observability/prometheus/rules/`

## 4. Naming Conventions

### 4.1. Metrics
- Service-specific: `<service_prefix>_<metric>_<unit>`
- Business metrics: `huleedu_<metric>_<unit>`
- Infrastructure: `<descriptive_name>_<unit>`

### 4.2. Dashboards
- System overview: `HuleEdu_System_Health_Overview.json`
- Service specific: `HuleEdu_<Service>_Deep_Dive.json`
- Troubleshooting: `HuleEdu_Troubleshooting_<Scenario>.json`