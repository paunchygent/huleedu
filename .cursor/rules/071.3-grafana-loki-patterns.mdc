---
description: Grafana dashboards and Loki log aggregation patterns
globs: 
alwaysApply: false
---
# 071.3: Grafana & Loki Patterns

## 1. Dashboard Structure

### 1.1. Standard Panels
```json
// Every dashboard MUST have
{
  "title": "Service Health",
  "panels": [
    "Service Uptime %",
    "Error Rate by Status Code", 
    "Response Time P95",
    "Request Rate"
  ]
}
```

### 1.2. Time Range Standards
- Default: Last 1 hour
- Options: 1h, 6h, 24h, 7d
- Refresh: 30s for operational, 5m for analytics

## 2. Loki Integration

### 2.1. Log Query Patterns
```logql
# Service logs with correlation
{service="batch_orchestrator"} |= "correlation_id" |= "abc-123"

# Error investigation
{service=~".*"} |= "ERROR" |= "storage_reference"

# JSON field extraction
{service="essay_lifecycle"} | json | batch_id="xyz"
```

### 2.2. Label Strategy
```yaml
# Promoted labels (fast queries)
- service
- level (INFO, ERROR, etc)
- environment

# Keep in message (avoid high cardinality)
- correlation_id
- user_id
- request details
```

## 3. Dashboard Categories

### 3.1. System Overview
- Location: `HuleEdu_System_Health_Overview.json`
- Purpose: Cross-service health at a glance
- Refresh: 30 seconds

### 3.2. Service Deep Dive
- Pattern: `HuleEdu_<Service>_Deep_Dive.json`
- Purpose: Single service detailed metrics
- Includes: Business metrics + operational metrics

### 3.3. Troubleshooting
- Pattern: `HuleEdu_Troubleshooting_<Scenario>.json`
- Purpose: Correlate logs, metrics, traces
- Features: Trace ID lookup, error aggregation

## 4. Grafana Datasources

### 4.1. Configuration
```yaml
# Auto-provisioned via docker
datasources:
  - name: Prometheus
    type: prometheus
    url: http://prometheus:9090
  - name: Loki
    type: loki  
    url: http://loki:3100
  - name: Jaeger
    type: jaeger
    url: http://jaeger:16686
```

### 4.2. Mixed Queries
```sql
# Correlate metrics with logs
metric: rate(http_requests_total[5m])
logs: {service="$service"} |= "ERROR"
```

## 5. Best Practices

### 5.1. Performance
- Avoid regex in high-frequency panels
- Use recording rules for complex calculations
- Limit log queries to specific time ranges

### 5.2. Organization
- Use folders: System, Services, Troubleshooting
- Version control dashboard JSON
- Document panel purposes in descriptions