---
description: Database migration standards for HuleEdu microservices
globs: 
alwaysApply: true
---
# 085: Database Migration Standards

## 1. Pre-Migration Analysis (MANDATORY)

**Before ANY migration, MUST check state:**
```bash
cd services/<service> && ../../.venv/bin/alembic current
docker exec huleedu_<service>_db psql -U ${HULEEDU_DB_USER} -d <db> -c "\dt"
```

## 2. State Scenarios

**Schema exists, no tracking:** `../../.venv/bin/alembic stamp <revision>` then `../../.venv/bin/alembic upgrade head`
**Clean state:** Direct `../../.venv/bin/alembic upgrade head`

## 3. Migration Commands (REQUIRED)

**Use monorepo venv directly from service directory:**
```bash
cd services/<service>
../../.venv/bin/alembic upgrade head
../../.venv/bin/alembic current
../../.venv/bin/alembic stamp <revision>
../../.venv/bin/alembic revision --autogenerate -m "description"
```

## 4. Prohibited Practices

**FORBIDDEN:**
- PDM service-specific commands (`pdm run -p services/<service>`)
- Service-specific venv usage
- PYTHONPATH hacks
- Manual SQL schema changes
- Applying migrations without state analysis
- Absolute imports in alembic/env.py

## 5. Post-Migration Verification

**MUST verify after migration:**
```bash
cd services/<service> && ../../.venv/bin/alembic current
docker exec huleedu_<service>_db psql -U ${HULEEDU_DB_USER} -d <db> -c "\d <table>"
```

---
**Understand state before changing. Use established tools.**