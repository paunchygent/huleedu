---
description: MUST be read before ANY testing task: create, edit, or run tasks
globs: 
alwaysApply: false
---
# 110.3: Testing Mode

## 1. Core Principles
- **MUST** follow [070-testing-and-quality-assurance.mdc](mdc:070-testing-and-quality-assurance.mdc)
- **MUST** use the root-aware runner: `pdm run pytest-root <path-or-nodeid>`
- **Alt (any dir)**: `pyp <path-or-nodeid>` after `source scripts/dev-aliases.sh`, or `pdmr pytest-root <path-or-nodeid>`
- **FORBIDDEN**: Fixing tests to make them pass - fix underlying code issues

## 2. Test Priorities
- Prioritize unit and contract tests
- Update contract tests when Pydantic models change
- Write meaningful tests based on requirements, not coverage

## 3. Mocking Boundaries
- **MUST** mock only external boundaries: protocols, HTTP clients, databases
- **FORBIDDEN**: Mocking internal business logic (core_logic.run_workflow = AsyncMock)
- **FORBIDDEN**: Using pytest.importorskip to mock same-service functions

## 4. Debugging
- Add `-s` to the standard runner for debug output, e.g. `pdm run pytest-root -s <path>`
- Analyze test failures and correlate with code changes
- Fix application code, not tests

## 5. Patterns
- Follow [070-testing-and-quality-assurance.mdc](mdc:070-testing-and-quality-assurance.mdc) Sections 3.9-3.11
- Follow [051-pydantic-v2-standards.mdc](mdc:051-pydantic-v2-standards.mdc) Section 8.2

## 6. Enum Usage in Tests **MANDATORY**

### 6.1. Test Data Requirements
**ALL tests MUST use enum objects for status-related parameters:**

- **REQUIRED**: Pass `BatchStatus` enums to batch-related methods
- **REQUIRED**: Pass `EssayStatus` enums to essay-related methods
- **FORBIDDEN**: String literals for status values in test method calls

**Examples:**
```python
# ✅ CORRECT - Use enum objects in tests
from common_core.enums import BatchStatus

async def test_pipeline_completion():
    await pipeline_coordinator.handle_phase_concluded(
        batch_id="test-batch",
        phase_status=BatchStatus.COMPLETED_SUCCESSFULLY
    )

# ❌ FORBIDDEN - String literals in tests
async def test_pipeline_completion():
    await pipeline_coordinator.handle_phase_concluded(
        batch_id="test-batch", 
        phase_status="completed_successfully"  # Wrong!
    )
```

### 6.2. Boundary Testing Pattern
**When testing serialization boundaries:**

- Test string-to-enum conversion at API endpoints
- Test enum-to-string conversion for event publishing
- Internal business logic tests MUST use enum objects

### 6.3. Mock Assertions
**Mock verification MUST use enum objects:**

```python
# ✅ CORRECT
mock_service.update_status.assert_called_with(
    essay_id="test",
    status=EssayStatus.SPELLCHECKED_SUCCESS
)
```

## 7. Integration Testing Standards

### 7.1. Database Integration Testing
- **MUST** use testcontainers for database integration tests when testing repository implementations
- **REQUIRED**: Real database instances over in-memory alternatives for production parity

### 7.2. Test Isolation
- **MUST** ensure test containers clean up automatically
- **PATTERN**: Use pytest fixture scopes appropriately

## 8. AI Agent Testing Coordination

### 8.1. Agent Behavior Expectations

#### Test Creation Agents (test-engineer)
- **Compliance**: Strict adherence to Rules 075 and 075.1 methodologies
- **Pattern Following**: Use established protocol-based mocking from existing test files
- **DI Principles**: AsyncMock(spec=Protocol) only, zero @patch usage
- **Domain Context**: Swedish character support, HuleEdu education patterns
- **Error Handling**: Structured HuleEduError patterns, behavioral testing focus

#### Architecture Review Agents (lead-architect-planner)  
- **Mandatory Execution**: After each Rule 075.1 batch regardless of test results
- **Analysis Scope**: Test quality, implementation validation, root cause identification
- **Quality Gates**: Verify Rule 075 compliance, DI patterns, Swedish locale support
- **Bug Classification**: Distinguish test creation issues from implementation bugs

### 8.2. User Collaboration Pattern
- **Transparency**: Report all validation results (pass/fail status, quality issues)
- **Issue Resolution**: Present architect analysis before proposing fixes
- **Progress Communication**: Use TodoWrite for visible progress tracking
- **Implementation Priority**: Fix code bugs before test modifications

### 8.3. Common AI Pitfalls - Avoidance Protocol
- **Never**: Use @patch decorators in test files
- **Never**: Test implementation details over business behavior  
- **Never**: Assume test failures are test issues without architect analysis
- **Always**: Validate DI compliance after test creation
- **Always**: Include Swedish character testing in domain-specific tests
- **Always**: Launch architect review regardless of apparent test success

### 8.4. Quality Assurance Behavior
- **Batch Validation**: Execute complete quality gate sequence per Rule 075.1
- **Type Safety**: Verify zero type errors before batch completion
- **Pattern Consistency**: Follow exact patterns from existing codebase test files
- **Implementation Feedback**: Report discovered code bugs to user for resolution priority

## 9. Debugging and Error Analysis

### 9.1. Test Failure Analysis
- **MUST** run tests with `-s` flag during debugging to see print output
- **REQUIRED**: Read actual error messages completely before attempting fixes
- **FORBIDDEN**: Simplifying tests to make them pass without fixing root cause

### 9.2. Web Research Integration
- **SHOULD** research known issues for complex errors (SQLAlchemy, async, etc.)
- **PATTERN**: Include reference links in comments for documented solutions
- **EXAMPLE**: Document GitHub issues and Stack Overflow solutions

```python
# Reference: https://github.com/googleapis/python-bigquery-sqlalchemy/issues/844
class StatusEnum(str, enum.Enum):  # str inheritance required for SQLAlchemy
    PENDING = "pending"
```
