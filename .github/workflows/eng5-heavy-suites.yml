name: ENG5 Heavy CJ/ENG5 Suites

on:
  # Heavy suites: manual trigger or release tags only (no nightly runs for solo dev)
  workflow_dispatch:
  push:
    tags:
      - 'v*'  # Release tags (v1.0.0, v2.0.0-rc1, etc.)

jobs:
  eng5-cj-docker-regular-and-small-net:
    name: ENG5 CJ Docker Semantics (regular + small-net)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    # Note: env vars are generated in .env file, not GitHub Actions env block
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PDM and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pdm
          pdm install --dev

      - name: Generate CI .env
        run: |
          cat > .env << 'EOF'
          # CI-generated for ENG5 heavy suites
          LLM_PROVIDER_SERVICE_USE_MOCK_LLM=true
          LLM_PROVIDER_SERVICE_MOCK_MODE=cj_generic_batch
          LLM_PROVIDER_SERVICE_QUEUE_PROCESSING_MODE=serial_bundle
          LLM_PROVIDER_SERVICE_BATCH_API_MODE=disabled
          LLM_PROVIDER_SERVICE_MOCK_PROVIDER_SEED=42
          LLM_PROVIDER_SERVICE_ALLOW_MOCK_PROVIDER=true
          CJ_ASSESSMENT_SERVICE_LLM_BATCHING_MODE=serial_bundle
          CJ_ASSESSMENT_SERVICE_ENABLE_LLM_BATCHING_METADATA_HINTS=true
          CJ_ASSESSMENT_SERVICE_PAIR_GENERATION_SEED=42
          CJ_ASSESSMENT_SERVICE_MAX_PAIRWISE_COMPARISONS=288
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "Generated .env contents:"
          cat .env

      - name: Run ENG5 CJ docker suite (regular + small-net)
        run: |
          pdm run eng5-cj-docker-suite regular
          pdm run eng5-cj-docker-suite small-net

  eng5-profile-parity-suite:
    name: ENG5 Mock Profile Parity Suite
    runs-on: ubuntu-latest
    timeout-minutes: 90
    # Note: env vars are generated per-profile in .env file
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PDM and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pdm
          pdm install --dev

      - name: Run CJ generic mock profile parity
        run: |
          cat > .env << 'EOF'
          LLM_PROVIDER_SERVICE_USE_MOCK_LLM=true
          LLM_PROVIDER_SERVICE_MOCK_MODE=cj_generic_batch
          LLM_PROVIDER_SERVICE_QUEUE_PROCESSING_MODE=serial_bundle
          LLM_PROVIDER_SERVICE_BATCH_API_MODE=disabled
          LLM_PROVIDER_SERVICE_MOCK_PROVIDER_SEED=42
          LLM_PROVIDER_SERVICE_ALLOW_MOCK_PROVIDER=true
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "Generated .env for cj-generic:" && cat .env
          pdm run llm-mock-profile cj-generic

      - name: Run ENG5 anchor mock profile parity
        run: |
          cat > .env << 'EOF'
          LLM_PROVIDER_SERVICE_USE_MOCK_LLM=true
          LLM_PROVIDER_SERVICE_MOCK_MODE=eng5_anchor_gpt51_low
          LLM_PROVIDER_SERVICE_QUEUE_PROCESSING_MODE=serial_bundle
          LLM_PROVIDER_SERVICE_BATCH_API_MODE=disabled
          LLM_PROVIDER_SERVICE_MOCK_PROVIDER_SEED=42
          LLM_PROVIDER_SERVICE_ALLOW_MOCK_PROVIDER=true
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "Generated .env for eng5-anchor:" && cat .env
          pdm run llm-mock-profile eng5-anchor

      - name: Run ENG5 LOWER5 mock profile parity
        run: |
          cat > .env << 'EOF'
          LLM_PROVIDER_SERVICE_USE_MOCK_LLM=true
          LLM_PROVIDER_SERVICE_MOCK_MODE=eng5_lower5_gpt51_low
          LLM_PROVIDER_SERVICE_QUEUE_PROCESSING_MODE=serial_bundle
          LLM_PROVIDER_SERVICE_BATCH_API_MODE=disabled
          LLM_PROVIDER_SERVICE_MOCK_PROVIDER_SEED=42
          LLM_PROVIDER_SERVICE_ALLOW_MOCK_PROVIDER=true
          EOF
          sed -i 's/^[[:space:]]*//' .env
          echo "Generated .env for eng5-lower5:" && cat .env
          pdm run llm-mock-profile eng5-lower5

