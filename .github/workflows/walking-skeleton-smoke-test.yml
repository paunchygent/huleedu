name: Walking Skeleton Smoke Test

on:
  push:
    branches: [ none ]      # Auto-run on pushes to main 
  pull_request:
    branches: [ none ]      # Auto-run on PRs to main
  workflow_dispatch:        # Manual trigger anytime

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20     # Increased for additional services
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Start HuleEdu Services
        run: |
          echo "Starting HuleEdu walking skeleton services..."
          docker compose down --remove-orphans
          docker compose up -d
          echo "Services starting, waiting for health checks..."
        
      - name: Wait for Services to be Healthy
        run: |
          echo "Waiting for essential services to be healthy..."
          max_retries=30
          retry_interval=10
          
          # Define the list of CRITICAL services that MUST be healthy
          essential_services=(
            "huleedu_batch_orchestrator_service" 
            "huleedu_content_service" 
            "huleedu_essay_lifecycle_api" 
            "huleedu_file_service" 
            "huleedu_spell_checker_service"
            "huleedu_cj_assessment_service"
            "huleedu_kafka"
          )
          
          for ((i=1; i<=max_retries; i++)); do
            echo "Health check attempt $i/$max_retries"
            all_healthy=true
            
            # Get health status of all containers
            health_status_json=$(docker compose ps --format json)

            for service in "${essential_services[@]}"; do
              # Use jq to check the health of THIS specific service
              status=$(echo "$health_status_json" | jq -r --arg srv "$service" 'select(.Name == $srv) | .Health')
              
              if [[ "$status" == "healthy" ]]; then
                echo "  ✅ $service is healthy."
              else
                echo "  ⏳ $service is not healthy (Status: ${status:-not running})."
                all_healthy=false
              fi
            done
            
            if [ "$all_healthy" = true ]; then
              echo "✅ All essential services are healthy!"
              break
            else
              if [ $i -eq $max_retries ]; then
                echo "❌ Essential services failed to become healthy after $max_retries attempts."
                echo "Final service status:"
                docker compose ps
                exit 1
              fi
              sleep $retry_interval
            fi
          done
          
      - name: Validate Service Health Endpoints
        run: |
          echo "=== Service Health Validation ==="
          
          # Define services and their health endpoints
          declare -A services=(
            ["content_service"]="http://localhost:8001/healthz"
            ["batch_orchestrator_service"]="http://localhost:5001/healthz"
            ["essay_lifecycle_service"]="http://localhost:6001/healthz"
            ["file_service"]="http://localhost:7001/healthz"
            ["spell_checker_service"]="http://localhost:8002/healthz"
          )
          
          # Test each service health endpoint
          for service in "${!services[@]}"; do
            url="${services[$service]}"
            echo "Testing $service health endpoint: $url"
            
            for attempt in {1..5}; do
              if curl -f -s "$url" > /dev/null; then
                echo "✅ $service: Health check passed"
                break
              else
                echo "⏳ $service: Health check attempt $attempt failed, retrying..."
                if [ $attempt -eq 5 ]; then
                  echo "❌ $service: Health check failed after 5 attempts"
                  exit 1
                fi
                sleep 5
              fi
            done
          done
          
      - name: Validate Prometheus Metrics Endpoints
        run: |
          echo "=== Prometheus Metrics Validation ==="
          
          # Define services and their metrics endpoints
          declare -A metrics_endpoints=(
            ["content_service"]="http://localhost:8001/metrics"
            ["batch_orchestrator_service"]="http://localhost:5001/metrics"
            ["essay_lifecycle_service"]="http://localhost:6001/metrics"
            ["file_service"]="http://localhost:7001/metrics"
            ["spell_checker_service"]="http://localhost:8002/metrics"
            ["cj_assessment_service"]="http://localhost:9095/metrics"
          )
          
          # Test each service metrics endpoint
          for service in "${!metrics_endpoints[@]}"; do
            url="${metrics_endpoints[$service]}"
            echo "Testing $service metrics endpoint: $url"
            
            if curl -f -s "$url" | head -10; then
              echo "✅ $service: Metrics endpoint accessible"
            else
              echo "⚠️ $service: Metrics endpoint may have issues (acceptable for walking skeleton)"
            fi
          done
          
      - name: Validate Kafka Infrastructure
        run: |
          echo "=== Kafka Infrastructure Validation ==="
          
          # Wait for Kafka to be ready
          echo "Waiting for Kafka to be ready..."
          for attempt in {1..10}; do
            if docker exec huleedu_kafka kafka-topics.sh --bootstrap-server localhost:9092 --list > /dev/null 2>&1; then
              echo "✅ Kafka is responding"
              break
            else
              echo "⏳ Kafka not ready, attempt $attempt/10"
              if [ $attempt -eq 10 ]; then
                echo "❌ Kafka failed to respond after 10 attempts"
                exit 1
              fi
              sleep 10
            fi
          done
          
          # Validate required topics exist
          echo "Validating Kafka topics..."
          required_topics=(
            "huleedu.batch.essays.registered.v1"
            "huleedu.file.essay.content.provisioned.v1"
            "huleedu.els.batch.essays.ready.v1"
            "huleedu.els.spellcheck.initiate.command.v1"
            "huleedu.essay.spellcheck.requested.v1"
            "huleedu.essay.spellcheck.completed.v1"
            "huleedu.els.cj_assessment.requested.v1"
            "huleedu.cj_assessment.completed.v1"
            "huleedu.cj_assessment.failed.v1"
            "huleedu.els.batch_phase.outcome.v1"
          )
          
          topics_list=$(docker exec huleedu_kafka kafka-topics.sh --bootstrap-server localhost:9092 --list)
          
          for topic in "${required_topics[@]}"; do
            if echo "$topics_list" | grep -q "$topic"; then
              echo "✅ Topic exists: $topic"
            else
              echo "❌ Missing topic: $topic"
              exit 1
            fi
          done
          
      - name: Test Basic Service Connectivity
        run: |
          echo "=== Basic Service Connectivity Test ==="
          
          # Test that services can communicate with each other
          # This is a basic smoke test - just verify endpoints respond
          
          echo "Testing Content Service upload endpoint..."
          if curl -f -X POST http://localhost:8001/v1/content \
               -H "Content-Type: application/json" \
               -d '{"content": "test", "content_type": "text/plain"}' > /dev/null; then
            echo "✅ Content Service: Upload endpoint responds"
          else
            echo "❌ Content Service: Upload endpoint failed"
            exit 1
          fi
          
          echo "Testing Batch Orchestrator Service endpoints..."
          # Test batch registration endpoint (expect validation error, but 400 is good)
          if curl -X POST http://localhost:5001/v1/batches/register \
               -H "Content-Type: application/json" \
               -d '{}' | grep -q "error\|validation"; then
            echo "✅ BOS: Registration endpoint responds with validation"
          else
            echo "❌ BOS: Registration endpoint failed"
            exit 1
          fi
          
          echo "Testing File Service health..."
          if curl -f -s http://localhost:7001/healthz | grep -q "healthy"; then
            echo "✅ File Service: Health endpoint responds correctly"
          else
            echo "❌ File Service: Health endpoint failed"
            exit 1
          fi
          
          echo "Testing Essay Lifecycle Service health..."
          if curl -f -s http://localhost:6001/healthz | grep -q "healthy"; then
            echo "✅ ELS: Health endpoint responds correctly"
          else
            echo "❌ ELS: Health endpoint failed"
            exit 1
          fi
          
      - name: Run Unit Test Suite
        run: |
          echo "=== Running Unit Test Suite ==="
          
          # Set up Python environment for testing
          python -m pip install --upgrade pip
          pip install pdm
          pdm install --dev
          
          # Run unit tests with coverage
          pdm run pytest tests/unit/ -v --tb=short --maxfail=5
          
          # Run contract tests 
          if [ -d "tests/contract" ]; then
            pdm run pytest tests/contract/ -v --tb=short --maxfail=3
          fi
          
      - name: Run Service Health Tests
        run: |
          echo "=== Running Service Health Tests ==="
          
          # Run the functional service health tests using our test infrastructure
          pdm run pytest tests/functional/test_service_health.py -v -s --tb=short
          
      - name: Display Service Logs on Failure
        if: failure()
        run: |
          echo "=== Service Logs for Debugging ==="
          echo "--- Docker Compose Services Status ---"
          docker compose ps
          
          echo "--- Content Service Logs ---"
          docker compose logs --tail=50 content_service
          
          echo "--- Batch Orchestrator Service Logs ---"
          docker compose logs --tail=50 batch_orchestrator_service
          
          echo "--- Essay Lifecycle Service API Logs ---"
          docker compose logs --tail=50 essay_lifecycle_api
          
          echo "--- Essay Lifecycle Service Worker Logs ---"
          docker compose logs --tail=50 essay_lifecycle_worker
          
          echo "--- File Service Logs ---"
          docker compose logs --tail=50 file_service
          
          echo "--- Spell Checker Service Logs ---"
          docker compose logs --tail=50 spell_checker_service
          
          echo "--- CJ Assessment Service Logs ---"
          docker compose logs --tail=50 cj_assessment_service
          
          echo "--- Kafka Logs ---"
          docker compose logs --tail=30 kafka
          
      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up Docker resources..."
          docker compose down --volumes --remove-orphans
          docker system prune -f 