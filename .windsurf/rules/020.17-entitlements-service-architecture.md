---
description: Entitlements Service – Centralized credit accounting with org-first identity attribution
alwaysApply: false
---
# 020.17: Entitlements Service Architecture

## Purpose
Authoritative credit accounting for HuleEdu. Attributes resource consumption to the correct subject using an org-first, user-fallback identity model.

## Core Responsibilities
- Consume `ResourceConsumptionV1` events and persist debit records.
- Attribute credits to `org_id` when present; otherwise attribute to `user_id`.
- Maintain counters and limits by organization and by user.
- Expose reporting and audit endpoints for platform operators.

## Identity Attribution (Org-First)
1. If `org_id` is present → attribute consumption to organization (primary key).
2. Else → attribute to `user_id` (fallback).
3. All records retain both fields (nullable `org_id`) for auditability.

## Event Integration
- Topic (example): `huleedu.metrics.resource.consumption.v1`
- Envelope: `EventEnvelope[ResourceConsumptionV1]`
- Required identity fields in payload or metadata:
  - `user_id: str` (required)
  - `org_id: str | None` (optional)
- Consumers MUST honor `envelope.metadata` for auxiliary identity when payload uses a thin contract.

## Data Model (Sketch)
- `consumption_records` table:
  - `id` (UUID PK), `event_id` (UUID, unique), `timestamp` (UTC)
  - `user_id` (str, not null)
  - `org_id` (str, null)
  - `resource_type` (enum), `units` (numeric), `source_service` (str)
  - `correlation_id` (UUID), `trace_id` (optional)

## Observability & SLAs
- Prometheus metrics: totals by `resource_type`, `org_id`/`user_id`, error rates.
- Tracing boundary: decode envelope headers first; include correlation IDs in logs.

## Configuration
- Environment-aware database URL, connection pool.
- Idempotency window for duplicate events (by `event_id`).
- Soft enforcement thresholds for rate limiting or alerting.

## Security
- Principle of least privilege for write paths.
- Read-only reporting endpoints gated by operator roles.

## Notes
- The service is write-optimized for event ingestion; reporting paths may use materialized views.
- Works in tandem with API Gateway org_id extraction and downstream services that propagate identity.
