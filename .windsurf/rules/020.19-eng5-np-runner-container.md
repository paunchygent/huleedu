---
id: "020.19-eng5-np-runner-container"
type: "standards"
created: 2025-11-10
last_updated: 2025-11-17
scope: "infrastructure"
parent_rule: "020-architectural-mandates"
---
# 020.19: ENG5 NP Runner Container Patterns

## 1. Container Architecture

### 1.1. Base Image Pattern
- **MUST** inherit from `huledu-deps:dev` base image containing all PDM dependencies
- **MUST** use multi-stage build with `base` and `production` stages
- **MUST** set standard environment block:
  ```dockerfile
  ENV PYTHONUNBUFFERED=1 \
      PYTHONDONTWRITEBYTECODE=1 \
      PDM_USE_VENV=false \
      PDM_IGNORE_ACTIVE_VENV=1 \
      PROJECT_ROOT=/app \
      PYTHONPATH=/app \
      ENV_TYPE=docker
  ```

### 1.2. Code Packaging
- **MUST** copy CLI scripts into image: `COPY --chown=appuser:appuser scripts/cj_experiments_runners/ /app/scripts/cj_experiments_runners/`
- **MUST** separate `ENTRYPOINT` from `CMD` for argument passthrough
- Standard pattern:
  ```dockerfile
  ENTRYPOINT ["pdm", "run", "-p", "/app", "eng5-np-run"]
  CMD ["--help"]
  ```

## 2. Volume Mount Strategy

### 2.1. Source Code Only
**CRITICAL**: Never mount entire repository (`./:/app`). Only mount specific source directories:

```yaml
volumes:
  # Mount source for hot-reload
  - ./scripts/cj_experiments_runners:/app/scripts/cj_experiments_runners:cached
  - ./libs/common_core/src:/app/libs/common_core/src:cached
  - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
  - ./test_uploads:/app/test_uploads:ro
  - ./.claude/research:/app/.claude/research
  # Exclude __pycache__
  - /app/scripts/cj_experiments_runners/__pycache__
```

### 2.2. Dependency Isolation
- Dependencies live in container's `/app/__pypackages__/3.11/lib/` from build
- **NEVER** mount `__pypackages__` or `.venv` from host
- Host uses `.venv` mode; container uses `__pypackages__` mode (via `PDM_USE_VENV=false`)
- Mounting `./:/app` overwrites container dependencies with host's empty `__pypackages__/`

### 2.3. PYTHONPATH Configuration
- Use Dockerfile default (`PYTHONPATH=/app`)
- **DO NOT** override in docker-compose with `__pypackages__/3.11/lib` path
- PDM handles path resolution when `PDM_USE_VENV=false` is set

## 3. Execution Patterns

### 3.1. Orchestration Wrapper
Automated infrastructure checks via `scripts/run_eng5_np_runner.sh`:
```bash
pdm run eng5-runner --mode plan --batch-id test
```

### 3.2. Direct Container Execution
```bash
docker compose -f docker-compose.yml -f docker-compose.eng5-runner.yml run --rm eng5_np_runner --mode plan --batch-id test
```

### 3.3. Service Dependencies
```yaml
depends_on:
  kafka:
    condition: service_healthy
  cj_assessment_service:
    condition: service_healthy
  llm_provider_service:
    condition: service_healthy
```

### 3.4. Anchor Registration Contract
- **EXECUTE mode MUST register anchors with CJ** before uploading any essays. The CLI now aborts on `AnchorRegistrationError` or missing `CJ_SERVICE_URL`; do not attempt to reintroduce ephemeral anchors.
- After a successful registration call, the runner uploads only student essays and relies on the CJ database for anchor hydration.
- `--max-comparisons` is emitted as envelope metadata (`metadata["max_comparisons"]`) for observability/cost hints. The runner must not slice essays locally based on this flag.

### 3.4. Admin CLI Authentication Pattern
- **MUST** ensure CJ admin commands have a valid JWT via the documented workflow in `services/cj_assessment_service/README.md`.
- Preferred local setup: run `pdm run cj-admin login --email <admin>` once to populate `~/.huleedu/cj_admin_token.json`; mount that path into the runner container when needed.
- Automation path: export a short-lived `CJ_ADMIN_TOKEN` in the shell (or compose env block) so CLI commands inherit it. See `services/cj_assessment_service/cli_admin.py` for token override and cache behavior.

## 4. Git SHA Metadata Handling

### 4.1. Environment Helper Pattern
`scripts/cj_experiments_runners/eng5_np/environment.py:gather_git_sha()`:
- Git SHA used for research reproducibility tracking in artefact metadata
- **MUST** catch both `subprocess.CalledProcessError` and `FileNotFoundError`
- Returns `"UNKNOWN"` when git binary unavailable (containerized environments)
- Non-critical metadata; fallback semantics appropriate

```python
try:
    result = subprocess.check_output(
        ["git", "-C", str(repo_root), "rev-parse", "HEAD"],
        stderr=subprocess.STDOUT,
    )
except (subprocess.CalledProcessError, FileNotFoundError):
    return "UNKNOWN"
return result.decode().strip()
```

### 4.2. No Git Installation Required
- Git binary NOT installed in production container
- Artefact metadata includes `git_sha: "UNKNOWN"` in containerized execution
- Host-based execution captures actual SHA via local git

## 5. Build and Deployment

### 5.1. Build Commands
```bash
# Ensure huledu-deps:dev base image exists
docker tag huledu-deps:<hash> huledu-deps:dev

# Build runner
docker compose -f docker-compose.yml -f docker-compose.eng5-runner.yml build eng5_np_runner
```

### 5.2. Source Code Hot-Reload
- Changes to mounted source directories immediately available
- No rebuild required for Python code changes
- Rebuild only needed for Dockerfile or dependency changes

## 6. Anti-Patterns

### ❌ Full Repository Mount
```yaml
# WRONG - overwrites container dependencies
volumes:
  - ./:/app:cached
```

### ❌ PYTHONPATH Override
```yaml
# WRONG - breaks PDM's __pypackages__ resolution
environment:
  - PYTHONPATH=/app/__pypackages__/3.11/lib:/app
```

### ❌ Uncaught FileNotFoundError
```python
# WRONG - crashes when git missing
try:
    result = subprocess.check_output(["git", ...])
except subprocess.CalledProcessError:  # Doesn't catch FileNotFoundError
    return "UNKNOWN"
```

## 7. Reference Files

- Dockerfile: `services/eng5_np_runner/Dockerfile`
- Compose Override: `docker-compose.eng5-runner.yml`
- Orchestration: `scripts/run_eng5_np_runner.sh`
- PDM Script: `pyproject.toml` (`eng5-runner = {shell = "bash scripts/run_eng5_np_runner.sh"}`)
- Operational Guide: `Documentation/OPERATIONS/ENG5-NP-RUNBOOK.md`
