---
description: Defines the Class Management Service architecture. The authoritative source for classes and students. Provides a synchronous CRUD API and publishes state change events to Kafka.
globs: 
alwaysApply: false
---

# 020.9: Class Management Service

## Service Identity

- **Port**: 5002
- **Stack**: HuleEduApp, SQLAlchemy+asyncpg, Dishka, Kafka
- **Purpose**: Authoritative source for classes/students

## Architecture

**HTTP Service Pattern**:
- `app.py`: HuleEduApp initialization (<150 LOC)
- `api/`: Blueprints (health_routes.py, class_routes.py, student_routes.py)
- `protocols.py`: `ClassRepositoryProtocol`, `ClassEventPublisherProtocol`
- `di.py`: Dishka providers

## API Endpoints

**Base**: `/v1/classes` (requires `X-User-ID` header)

- `POST /`: Create class
- `GET /<class_id>`: Get class
- `PUT /<class_id>`: Update class
- `DELETE /<class_id>`: Delete class
- `POST /students`: Create student
- `GET /students/<student_id>`: Get student
- `PUT /students/<student_id>`: Update student
- `DELETE /students/<student_id>`: Delete student

**Models**: `api_models.py` (Pydantic), uses `PersonNameV1`

## Database Architecture

**PostgreSQL**: Port 5435, SQLAlchemy+asyncpg

**Models** (`models_db.py`):
- `Course`: Reference data
- `UserClass`: Single course per class
- `Student`: Email+user_id unique constraint
- `class_student_association`: M2M
- `EssayStudentAssociation`: Essay->Student with Phase 1 fields:
  - `batch_id`, `class_id`: Batch and class references
  - `confidence_score`: NLP matching confidence
  - `validation_status`: pending_validation/confirmed/timeout_confirmed
  - `validation_method`: human/timeout/auto

**Repository Pattern**:
```python
class PostgreSQLClassRepositoryImpl:
    def __init__(self, engine: AsyncEngine, metrics: DatabaseMetrics):
        self.engine = engine
        self.session = async_sessionmaker(engine, expire_on_commit=False)
    
    @asynccontextmanager
    async def session_context(self) -> AsyncGenerator[AsyncSession, None]:
        async with self.session() as session:
            yield session
```

**Patterns**:
- Repository-managed sessions (prevents MissingGreenlet)
- `selectinload()` for relationships (prevents DetachedInstanceError)
- Single course validation with custom exceptions
- Alembic migrations for schema+data

## Phase 1 Student Matching

**Association Timeout Monitor** (`AssociationTimeoutMonitor`):
- **Purpose**: Auto-confirms pending student-essay associations after 24 hours
- **Configuration**: `TIMEOUT_HOURS = 24`, `HIGH_CONFIDENCE_THRESHOLD = 0.7`, runs hourly
- **High Confidence (â‰¥0.7)**: Confirms with original student, validation_method=`TIMEOUT`
- **Low Confidence (<0.7)**: Creates UNKNOWN student with email `unknown.{class_id}@huleedu.system`
- **Event Publishing**: `StudentAssociationsConfirmedV1` with `timeout_triggered=true`

**Handler**: `BatchAuthorMatchesHandler` processes NLP match suggestions and stores associations

## Events & Configuration

**Published Events**: `ClassCreatedV1`, `ClassUpdatedV1`, `StudentCreatedV1`, `StudentUpdatedV1`, `StudentAssociationsConfirmedV1`

**Consumed Events**: `BatchAuthorMatchesSuggestedV1` (Phase 1 student matching)

**Dual-Channel Publishing**:
1. Kafka: Durable events via `KafkaBus`
2. Redis: Real-time via `ws:{user_id}` channel

**Config** (`CLASS_MANAGEMENT_SERVICE_` prefix):
- `DATABASE_URL`
- `KAFKA_BOOTSTRAP_SERVERS`
- `REDIS_URL`
- `USE_MOCK_REPOSITORY`

## Production Status: READY

**Performance**: 500+ students/sec, 10ms queries (P95: 27ms)

**Key Patterns**:
- Repository-managed async sessions
- Eager loading with `selectinload()`
- HuleEduApp guaranteed contract
- Protocol-based DI with Dishka
- Dual-channel event publishing
