---
id: "043.2-correlation-context-pattern"
type: "implementation"
created: 2025-09-07
last_updated: 2025-11-17
scope: "backend"
parent_rule: "043-service-configuration-and-logging"
---

# 043.2 CorrelationContext Pattern

## Mandate
All HTTP services **MUST** use CorrelationContext middleware. Manual header extraction is **PROHIBITED**.

## Implementation

### App Setup
```python
# app.py
from huleedu_service_libs.middleware.frameworks.quart_correlation_middleware import (
    setup_correlation_middleware,
)

setup_correlation_middleware(app)  # Early in app setup
```

### DI Provider
```python
# di.py
@provide(scope=Scope.REQUEST)
def provide_correlation_context(self) -> CorrelationContext:
    from quart import g, request
    from huleedu_service_libs.error_handling.correlation import (
        CorrelationContext,
        extract_correlation_context_from_request,
    )
    
    ctx = getattr(g, "correlation_context", None)
    if isinstance(ctx, CorrelationContext):
        return ctx
    return extract_correlation_context_from_request(request)
```

### Route Usage
```python
# routes.py
from dishka import FromDishka
from huleedu_service_libs.error_handling.correlation import CorrelationContext

async def endpoint(
    corr: FromDishka[CorrelationContext],
    service: FromDishka[ServiceProtocol],
):
    # Errors: use corr.uuid
    raise_validation_error(
        service="x",
        operation="y", 
        correlation_id=corr.uuid,
        details={"original_correlation_id": corr.original}
    )
    
    # Events: use corr.uuid
    envelope = EventEnvelope(
        correlation_id=corr.uuid,
        metadata={"original_correlation_id": corr.original}
    )
    
    # Client response: echo corr.original
    return {"correlation_id": corr.original}
```

## Key Fields
- `corr.uuid`: Canonical UUID (parsed or uuid5-derived) for internal use
- `corr.original`: Original string from client for response echo
- `corr.source`: "header" | "query" | "generated"

## Backwards Compatibility
- `g.correlation_id` equals `corr.original` (middleware sets both)
- Legacy code using `g.correlation_id` continues working

## FastAPI Variant
```python
# For FastAPI services (if needed)
from fastapi import Request, Depends

async def get_correlation_context(request: Request) -> CorrelationContext:
    return extract_correlation_context_from_request(request)

async def endpoint(corr: Annotated[CorrelationContext, Depends(get_correlation_context)]):
    # Same usage as Quart
```
