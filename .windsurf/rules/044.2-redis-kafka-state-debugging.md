---
description: Redis and Kafka state debugging patterns for distributed system failures
globs: 
alwaysApply: false
---
# 044.2: Redis and Kafka State Debugging Standards

## 1. Redis Idempotency Collision Pattern

### Symptoms
- "No expectation registered for batch" errors in ELS
- Events appear published but not processed
- Silent failures with "Duplicate message skipped" logs
- State inconsistency between services

### Root Cause
Redis idempotency keys from previous test runs prevent event processing:
```
Redis SETNX key='huleedu:idempotency:v2:service:event_type:hash' result=EXISTS
```

### Debugging Steps (MANDATORY ORDER)

#### Step 1: Verify Event Publishing
```bash
# Check if event exists in Kafka topic
docker exec huleedu_kafka kafka-console-consumer.sh \
  --bootstrap-server localhost:9092 \
  --topic huleedu.batch.essays.registered.v1 \
  --from-beginning --max-messages 10
```

#### Step 2: Check Redis Idempotency State
```bash
# Find idempotency keys for the failing batch
docker exec huleedu_redis redis-cli KEYS "huleedu:idempotency:v2:*"

# Check specific event hash (from logs)
docker exec huleedu_redis redis-cli EXISTS "huleedu:idempotency:v2:SERVICE:EVENT_TYPE:HASH_FROM_LOGS"
```

#### Step 3: Verify Consumer Processing
```bash
# Check consumer offset position
docker exec huleedu_kafka kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group essay-lifecycle-service-group-v1.0 \
  --describe
```

#### Step 4: Database State Verification
```bash
# Check if batch expectation exists
docker exec huleedu_essay_lifecycle_db psql -U ${HULEEDU_DB_USER} -d essay_lifecycle \
  -c "SELECT batch_id, expected_count FROM batch_essay_trackers WHERE batch_id='BATCH_ID';"
```

### Resolution Pattern

#### Clean State Method
```bash
# 1. Clear Redis idempotency key
docker exec huleedu_redis redis-cli DEL "huleedu:idempotency:v2:SERVICE:EVENT_TYPE:EVENT_HASH"

# 2. Reset consumer offset to reprocess
docker exec huleedu_kafka kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group essay-lifecycle-service-group-v1.0 \
  --topic huleedu.batch.essays.registered.v1 \
  --reset-offsets --to-offset OFFSET --execute

# 3. Restart affected worker
docker restart huleedu_essay_lifecycle_worker
```

#### Nuclear Reset Method (Development Only)
```bash
# Clear ALL Redis state
docker exec huleedu_redis redis-cli FLUSHALL

# Reset ALL consumer offsets
docker exec huleedu_kafka kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group essay-lifecycle-service-group-v1.0 \
  --reset-offsets --to-earliest --all-topics --execute
```

## 2. Prevention Standards

### Test Environment Management
- **MANDATORY**: Flush Redis before each E2E test run
- **MANDATORY**: Reset Kafka consumer offsets in test setup
- **MANDATORY**: Verify clean state before test execution

### Event ID Diversification
- Use timestamp + random component in test event generation
- Avoid deterministic test data that creates identical event hashes
- Include test run identifiers in event metadata

### State Validation
- Services MUST verify expected state exists before processing
- Add health checks that validate Redis/Kafka state consistency
- Implement startup state recovery validation

## 3. Service-Specific Patterns

### Essay Lifecycle Service
**Startup Validation:**
```python
async def validate_startup_state():
    # Check database connectivity and schema
    # Verify Redis connectivity and key space
    # Validate Kafka consumer group state
    # Log any inconsistencies for debugging
```

**Event Processing Validation:**
```python
async def process_batch_event(event):
    # Log idempotency check result explicitly
    # Validate batch doesn't already exist before skipping
    # Include correlation tracking in all log statements
```

### General Event Processing
**Debugging Context (MANDATORY):**
```python
logger.info("Processing event", extra={
    'event_type': event.event_type,
    'event_id': event.event_id,
    'correlation_id': event.correlation_id,
    'redis_key': f"huleedu:idempotency:v2:{service}:{event_type}:{event_hash}",
    'idempotency_result': redis_result  # SET, EXISTS, ERROR
})
```

## 4. Alert Patterns

### Early Warning Signs
- Multiple "Duplicate message skipped" logs in short timeframe
- Consumer lag without corresponding error logs  
- State inconsistency between database and memory

### Critical Indicators
- "No expectation registered" errors
- Events published but never processed
- Service health checks passing but pipeline stalled

## 5. Recovery Time Objectives

- **Detection Time**: < 2 minutes via monitoring
- **Diagnosis Time**: < 5 minutes using this runbook
- **Resolution Time**: < 3 minutes for clean state method
- **Total Recovery**: < 10 minutes from symptom to resolution

---
**This pattern MUST be checked first when investigating pipeline stalls or event processing failures.**
