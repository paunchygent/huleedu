---
id: "053.1-migration-patterns"
type: "library"
created: 2025-09-04
last_updated: 2025-11-17
scope: "backend"
parent_rule: "053-sqlalchemy-core"
---

# 053.1: Database Migration Patterns

## Migration Infrastructure Requirements

All PostgreSQL services **MUST** follow the consolidated Alembic migration pattern established across the HuleEdu platform.

### Service Structure
```
services/{service_name}/
├── alembic.ini                    # Service-specific configuration
├── alembic/
│   ├── __init__.py               # Package initialization
│   ├── env.py                    # Async SQLAlchemy environment
│   └── versions/                 # Migration files
│       └── YYYYMMDD_NNNN_description.py
├── models_db.py                  # SQLAlchemy models
├── config.py                     # Must include database_url property
└── pyproject.toml               # Must include alembic dependency and PDM scripts
```

### Required Dependencies
**pyproject.toml**:
```toml
dependencies = [
    "sqlalchemy[asyncio]",
    "asyncpg",
    "alembic",  # Required for migrations
]

[tool.pdm.scripts]
# Standardized migration commands (identical across all services)
migrate-upgrade = "alembic upgrade head"
migrate-downgrade = "alembic downgrade -1"
migrate-history = "alembic history"
migrate-current = "alembic current"
migrate-revision = "alembic revision --autogenerate"
migrate-stamp = "alembic stamp head"
```

### Configuration Integration
**config.py pattern**:
```python
class Settings(BaseSettings):
    # Database connection fields
    DB_HOST: str = Field(default="localhost")
    DB_PORT: int = Field(default=5432)
    DB_NAME: str = Field(default="service_db")
    DB_USER: str = Field(default="huleedu_user")
    DB_PASSWORD: str = Field(default="REDACTED_DEFAULT_PASSWORD")
    
    @property
    def database_url(self) -> str:
        """Database URL for Alembic migration configuration."""
        return f"postgresql+asyncpg://{self.DB_USER}:{self.DB_PASSWORD}@{self.DB_HOST}:{self.DB_PORT}/{self.DB_NAME}"
```

### Async Migration Environment
**alembic/env.py pattern**:
```python
import asyncio
from alembic import context
from sqlalchemy import pool
from sqlalchemy.ext.asyncio import async_engine_from_config

from services.{service_name}.config import settings
from services.{service_name}.models_db import Base

config = context.config
config.set_main_option("sqlalchemy.url", settings.database_url)
target_metadata = Base.metadata

def run_migrations_offline() -> None:
    url = config.get_main_option("sqlalchemy.url")
    context.configure(url=url, target_metadata=target_metadata, literal_binds=True)
    with context.begin_transaction():
        context.run_migrations()

async def run_async_migrations() -> None:
    connectable = async_engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )
    async with connectable.connect() as connection:
        await connection.run_sync(lambda conn: context.configure(
            connection=conn, target_metadata=target_metadata
        ))
        await connection.run_sync(lambda conn: context.run_migrations())
    await connectable.dispose()

def run_migrations_online() -> None:
    asyncio.run(run_async_migrations())
```

### Service-Specific Configuration
**alembic.ini**:
```ini
[alembic]
script_location = alembic
# Database URL dynamically loaded from service configuration

[loggers]
keys = root,sqlalchemy,alembic
# ... standard logging configuration
```

## Usage Commands

### Development Workflow
```bash
# Apply pending migrations
pdm run migrate-upgrade

# Generate new migration after model changes
pdm run migrate-revision "description_of_changes"

# View migration history
pdm run migrate-history

# Check current migration
pdm run migrate-current

# Rollback one migration (use with caution)
pdm run migrate-downgrade
```

## Implementation Requirements

| Requirement | Description |
|-------------|-------------|
| **Service Isolation** | Each service has independent migration history |
| **Async Consistency** | All migration environments use async SQLAlchemy patterns |
| **Configuration Integration** | Dynamic database URLs from service settings |
| **Naming Standardization** | All services use identical `migrate-*` PDM commands |
| **Zero Disruption** | Baseline migrations preserve existing schemas exactly |
| **Outbox Integration** | Services using outbox pattern **MUST** include `EventOutbox` in migrations |
