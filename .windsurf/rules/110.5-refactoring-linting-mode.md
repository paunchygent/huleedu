---
trigger: model_decision
description: "Refactoring and linting mode for AI agents. Follow when improving code quality, structure, or style."
---

---
description: Always use if modules exceed 400 lines or violate SRP
globs: 
alwaysApply: false
---
# 110.5: Refactoring and Linting Mode

## 1. When to Use This Mode
- **Linting Issues**: When Ruff reports violations that need systematic fixing
- **File Size Violations**: When files exceed 400-line limit  
- **SRP Violations**: When single files contain multiple responsibilities
- **Architecture Drift**: When implementation patterns deviate from project standards

## 2. SRP Refactoring Pattern (ELS Model)

### 2.1. Problem Identification
When a service's `di.py` file becomes bloated with business logic:
- **Symptoms**: File size > 400 lines, multiple concrete implementations mixed with DI config
- **Root Cause**: Business logic implementations stored in DI configuration file
- **Impact**: Violates SRP, hard to test, maintainability issues

### 2.2. Extraction Strategy (Proven Pattern)
**Goal**: Extract concrete implementations while maintaining protocol compliance

**Step 1: Create implementations/ directory**
```bash
mkdir -p implementations
touch implementations/__init__.py
touch implementations/py.typed  
```

**Step 2: Extract implementations one by one**
- Start with simplest implementations (fewer dependencies)
- Extract to `implementations/[component]_[type].py` (e.g., `content_client.py`)
- Maintain protocol interfaces, extract only concrete classes
- Update imports in di.py after each extraction
- Verify tests pass after each extraction

**Step 3: Clean DI configuration**
- Import extracted implementations in di.py
- Remove extracted class definitions  
- Keep only Provider class and @provide methods
- Verify final di.py is under 150 lines

### 2.3. Example: ELS Refactoring Results
**Before**: 449 lines (violates 400-line limit)
**After**: 114 lines (75% reduction)

**Extracted implementations**:
- `content_client.py` (47 lines): HTTP operations
- `event_publisher.py` (98 lines): Kafka publishing  
- `metrics_collector.py` (69 lines): Prometheus metrics
- `batch_command_handler_impl.py` (67 lines): Command processing
- `service_request_dispatcher.py` (63 lines): Request dispatching

**Benefits**:
- ✅ Perfect SRP compliance (1 responsibility per file)
- ✅ All files under 400-line limit  
- ✅ Improved testability (isolated implementations)
- ✅ Better maintainability (related code grouped)
- ✅ Clean dependency injection (lean di.py)

### 2.4. Verification Requirements
- All tests must continue passing
- MyPy type checking must pass
- Services must start and function correctly
- Docker builds must work
- No import or dependency issues

## 3. Core Standards
- **MUST** follow @050-python-coding-standards.mdc
- **MUST** use `pdm run format-all`, `pdm run lint-all`, `pdm run typecheck-all`
- **CRITICAL**: Always use `--force-exclude` flag in Ruff commands

## 4. Systematic Linting Approach
- **NEVER** suppress linting errors with comments
- Fix underlying issues with proper code structure
- Use `pdm run lint-all` and `pdm run format-all`
- Address issues incrementally with verification
- Use `ruff check --fix --force-exclude .` for auto-fixable issues first
- Address MyPy errors with correct type hints

### 4.1. MyPy Missing Stubs Pattern
- **FORBIDDEN**: Creating `py.typed` marker files for internal modules
- **REQUIRED**: Add modules without type stubs to `pyproject.toml` MyPy external libraries section
- **Example**: `"transitions.*"`, `"essay_state_machine"` with `ignore_missing_imports = true`

## 5. Refactoring Best Practices
- Improve readability and reduce complexity
- Remove duplication without changing external behavior
- Avoid unnecessary or disruptive changes
- Update docstrings for significant structural changes
- Use `edit_file` tool with `// ... existing code ...` markers

## 6. Anti-Patterns to Avoid
- **FORBIDDEN**: Business logic in di.py files
- **FORBIDDEN**: Files over 400 lines
- **FORBIDDEN**: Multiple responsibilities in single files
- **FORBIDDEN**: Suppressing linting errors instead of fixing issues

---
**Improve code quality systematically.**