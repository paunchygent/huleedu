# Task Ticket: Finalize Walking Skeleton End-to-End Workflow

Ticket ID: HULEDU-PREP-002

**Status**: TODO
**Priority**: CRITICAL
**Sprint**: Current (Walking Skeleton Completion)
**Reporter**: Python Coding Companion
**Assignee**: HuleEdu Development Team

**1. Description:**
This ticket outlines the final set of changes required to achieve a fully functional end-to-end "walking skeleton" for the HuleEdu essay processing pipeline. It addresses previously identified gaps in `essay_id` coordination, `text_storage_id` propagation, and inter-service command handling, primarily between the Batch Orchestrator Service (BOS), File Service, and Essay Lifecycle Service (ELS).
The adopted solution is the **"ELS Assigns ID to Provisioned Content" model**: teachers upload arbitrarily named files to a batch, and ELS assigns persistent, HuleEdu-internal `essay_id`s (pre-defined "slots" for the batch, generated by BOS) to this provisioned content.

**2. Goals:**

* Implement a robust and user-friendly workflow for batch creation and file upload where teachers do not need to manage HuleEdu-internal `essay_id`s or rename files.
* Ensure unique, HuleEdu-internal `essay_id`s (slots generated by BOS during batch registration) are correctly and **idempotently** assigned by ELS to content provisioned by File Service.
* Enable the accurate flow of actual `text_storage_id`s (from Content Service) from File Service -> ELS -> BOS -> ELS -> Specialized Services (e.g., Spell Checker).
* Fully enable ELS to subscribe to, process, and act upon pipeline initiation commands from BOS (specifically `BatchServiceSpellcheckInitiateCommandDataV1` for this ticket).
* Update the Spell Checker Service to consume the correctly typed event from ELS, including `language` information.
* All changes must align with existing HuleEdu architectural principles: EDA, SRP, asynchronous communication, and defined development rules.

**3. Acceptance Criteria:**

* **BOS**: On batch registration (based on `expected_essay_count`), generates a list of unique HuleEdu-internal `essay_id`s (slots) and includes them in the `BatchEssaysRegistered.expected_essay_ids` field sent to ELS.
* **File Service**:
  * Accepts batch uploads (`batch_id` + list of files with arbitrary original names) via `POST /v1/files/batch`.
  * For each successfully sanitized and processed file: extracts text, stores it in Content Service (obtaining a `text_storage_id`), and publishes an `EssayContentProvisionedV1` event. This event contains `batch_id`, `original_file_name`, and `text_storage_id` (it does not contain a HuleEdu-internal `essay_id`).
* **ELS - Content Assignment & Validation**:
  * Consumes `BatchEssaysRegistered` to know the HuleEdu-internal `essay_id`s (slots) expected for each batch.
  * Consumes `EssayContentProvisionedV1` from File Service.
  * **Idempotently** assigns an available HuleEdu-internal `essay_id` (slot) for the given `batch_id` to the provisioned content. If the content (`text_storage_id`) has already been assigned a slot for this batch, the event is acknowledged without re-assignment or error.
  * Stores the mapping (HuleEdu-internal `essay_id`, `original_file_name`, `text_storage_id`) in its `EssayStateStore`, updating the essay status to `READY_FOR_PROCESSING`.
  * If no HuleEdu-internal `essay_id` (slot) is available for assignment (e.g., more files uploaded than `expected_essay_count`), ELS publishes an `ExcessContentProvisionedV1` event.
* **ELS - `BatchEssaysReady` Event**:
  * When all expected HuleEdu-internal `essay_id`s (slots) for a batch have been assigned provisioned content, ELS publishes `BatchEssaysReady`.
  * This event contains `ready_essays: List[EssayProcessingInputRefV1]`, where each `essay_id` is the HuleEdu-internal assigned ID, and `text_storage_id` is the actual ID from Content Service.
* **BOS - Command Generation**:
  * Consumes the `BatchEssaysReady` event.
  * Uses the actual HuleEdu-internal `essay_id`s and `text_storage_id`s from `ready_essays` to construct `BatchServiceSpellcheckInitiateCommandDataV1`.
* **ELS - Command Processing & Dispatch**:
  * ELS worker subscribes to and processes `BatchServiceSpellcheckInitiateCommandDataV1` from BOS.
  * ELS's `BatchCommandHandler` updates states for the specified HuleEdu-internal `essay_id`s (e.g., to `AWAITING_SPELLCHECK`).
  * ELS's `SpecializedServiceRequestDispatcher` publishes `EssayLifecycleSpellcheckRequestV1` events to the Spell Checker Service, containing the actual `text_storage_id` and `language`.
* **Spell Checker Service**:
  * Consumes `EventEnvelope[EssayLifecycleSpellcheckRequestV1]` and uses the `language` field.
* **End-to-End Test**: A defined test scenario successfully demonstrates the complete flow from batch registration and file upload to Spell Checker Service receiving the processing request with correct identifiers and context.

---
**4. Tasks & Justified Decisions:**

**4.1. Common Core Modifications (`common_core/src/common_core/`)**

* **(Task 1.1) Define `EssayContentProvisionedV1` event model**
  * File: `events/batch_coordination_events.py` (or a new `events/file_events.py`).
  * Payload: `batch_id: str`, `original_file_name: str`, `text_storage_id: str` (for extracted text), `file_size_bytes: int`, `content_md5_hash: Optional[str]`, `correlation_id: Optional[UUID]`, `timestamp: datetime`.
  * Justification: Decouples File Service from needing to know/generate HuleEdu-internal `essay_id`s. It simply announces that content has been successfully processed and stored for a batch. `file_size_bytes` and `content_md5_hash` added for better traceability and potential future validation.
* **(Task 1.2) Define `ExcessContentProvisionedV1` event model**
  * File: `events/batch_coordination_events.py` (or a new `events/file_events.py`).
  * Payload: `batch_id: str`, `original_file_name: str`, `text_storage_id: str`, `reason: str` (e.g., "NO_AVAILABLE_SLOT"), `correlation_id: Optional[UUID]`, `timestamp: datetime`.
  * Justification: Provides asynchronous feedback when ELS cannot assign provisioned content to an expected slot.
* **(Task 1.3) Modify `events/batch_coordination_events.py:BatchEssaysRegistered`**
  * Ensure it contains `batch_id: str` and `expected_essay_ids: List[str]`. The `expected_essay_ids` are the HuleEdu-internal `essay_id`s/slots generated by BOS.
  * Justification: This is critical for ELS to know the pre-defined slots it needs to fill. Current model `BatchEssaysRegistered` already includes `essay_ids` which will serve this purpose. Field name `essay_ids` is clear.
* **(Task 1.4) Modify `events/batch_coordination_events.py:BatchEssaysReady`**
  * Change field `ready_essay_ids: list[str]` to `ready_essays: List[EssayProcessingInputRefV1]`.
  * Justification: Provides BOS with the necessary `text_storage_id` for each HuleEdu-internal `essay_id` directly, avoiding synchronous queries and aligning with events carrying essential identifiers.
* **(Task 1.5) Confirm `essay_service_models.py:EssayLifecycleSpellcheckRequestV1`**
  * This model, containing `text_storage_id` and `language`, is correct for ELS to command the Spell Checker Service.
  * Justification: It already supports the required data propagation.
* **(Task 1.6) Add new `ProcessingEvent` enum members in `enums.py`**
  * Add `ESSAY_CONTENT_PROVISIONED` and `EXCESS_CONTENT_PROVISIONED`.
  * Map them to Kafka topics in `topic_name()` function, e.g.:
    * `ESSAY_CONTENT_PROVISIONED` -> `"huleedu.file.essay.content.provisioned.v1"`
    * `EXCESS_CONTENT_PROVISIONED` -> `"huleedu.els.excess.content.provisioned.v1"`
  * Justification: Standard way to manage event types and topic names.

**4.2. File Service Modifications (`services/file_service/`)**

* **(Task 2.1) In `core_logic.py:process_single_file_upload`** (called by `api/file_routes.py:upload_batch_files`):
  * Remove any HuleEdu-internal `essay_id` generation.
  * After successful file processing and storing content (obtaining `text_storage_id` from Content Service):
    * Construct and publish the new `EssayContentProvisionedV1` event using `EventPublisherProtocol`. The event includes `batch_id` (from upload request), `original_file_name` (from `FileStorage`), the actual `text_storage_id`, and other relevant fields like `file_size_bytes` and `content_md5_hash` (hash calculation to be added).
  * Justification: Simplifies File Service's responsibility to technical file processing, decoupling it from HuleEdu's internal `essay_id` logic.
* **(Task 2.2) In `api/file_routes.py:upload_batch_files`**:
  * Ensure `original_file_name` and raw `file_content` (bytes) are passed to `core_logic`.
  * Consider calculating MD5 hash of `file_content` here and passing it to `core_logic`.
  * Justification: Ensures `core_logic` has all necessary data from the uploaded file.

**4.3. Essay Lifecycle Service (ELS) Modifications (`services/essay_lifecycle_service/`)**

* **(Task 3.1) Event Consumption (`worker_main.py`, `batch_command_handlers.py`)**:
  * Subscribe ELS worker to `topic_name(ProcessingEvent.ESSAY_CONTENT_PROVISIONED)`.
  * Add routing in `_route_event` for `EssayContentProvisionedV1` to a new handler function.
  * Justification: Enables ELS to react to newly provisioned content.
* **(Task 3.2) New Handler for `EssayContentProvisionedV1` (in `batch_command_handlers.py`)**:
  * **Idempotency Check**:
    * Before assigning a slot, query `EssayStateStore` (e.g., via a new method `get_essay_by_text_storage_id_and_batch_id(batch_id, text_storage_id)`) to see if the `text_storage_id` from the event has already been assigned an essay slot for this `batch_id`. If yes, log a warning and acknowledge the event without further processing.
  * **Slot Assignment**:
    * Use `BatchEssayTracker` to get the next available pre-registered HuleEdu-internal `essay_id` (slot) for the `event_data.batch_id`.
    * If a slot is available:
      * Call `EssayStateStore.create_or_update_essay_state_for_slot_assignment` (new method) for this HuleEdu-internal `essay_id`, persisting its association with `event_data.text_storage_id`, `event_data.original_file_name`, `event_data.file_size_bytes`, `event_data.content_md5_hash`, and setting its status to `READY_FOR_PROCESSING`.
      * Notify `BatchEssayTracker` that this HuleEdu-internal `essay_id` (slot) is now fulfilled (passing the `text_storage_id` and HuleEdu-internal `essay_id` for its internal mapping).
    * If no slot is available: Log the issue and publish an `ExcessContentProvisionedV1` event using `EventPublisherProtocol`.
  * **Trigger `BatchEssaysReady` Check**: After successfully assigning content to a slot (or acknowledging an idempotent case), check with `BatchEssayTracker` if the batch is now complete. If `BatchEssayTracker.mark_essay_ready()` (or a similar updated method signifying slot fulfillment) indicates batch completion and returns a populated `BatchEssaysReady` event object, publish it using `EventPublisherProtocol`.
  * Justification: ELS manages the assignment of HuleEdu-internal `essay_id`s to actual content. Idempotency ensures robustness. Direct transition to `READY_FOR_PROCESSING` simplifies state. Publishing `BatchEssaysReady` from here completes Gap 2.
* **(Task 3.3) `BatchEssayTracker` Enhancements (`batch_tracker.py`)**:
  * Method `register_batch(event: BatchEssaysRegistered)`: Store the list of `event.expected_essay_ids` (HuleEdu-internal slots) for the batch.
  * Method `assign_slot_to_content(batch_id: str, text_storage_id: str, original_file_name: str) -> Optional[str]`:
    * Finds the next unassigned HuleEdu-internal `essay_id` for the `batch_id`.
    * If available, marks it as assigned (e.g., stores the `text_storage_id` and `original_file_name` against it internally or signals for `EssayStateStore` to do so). Returns the assigned HuleEdu-internal `essay_id`.
    * If no slot is available, returns `None`.
  * Method `mark_slot_fulfilled(batch_id: str, internal_essay_id: str, text_storage_id: str)`: Called by the event handler after `EssayStateStore` persistence.
  * Update `is_complete` logic to check if all `expected_essay_ids` have been fulfilled.
  * When constructing `BatchEssaysReady`: Iterate through the fulfilled HuleEdu-internal `essay_id`s. Retrieve the associated `text_storage_id` for each (this might come from its internal tracking, which was populated during `mark_slot_fulfilled`). Populate `BatchEssaysReady.ready_essays` with `EssayProcessingInputRefV1` instances.
  * **Note on identical `original_file_name`s**: The current sequential slot assignment based on event arrival order implicitly handles distinct uploads even with identical original filenames. The `original_file_name` is stored for traceability. Log a warning if duplicate `original_file_name`s are detected for the same batch if this becomes a concern, but the core logic relies on distinct `text_storage_id`s and filling available slots.
* **(Task 3.4) `EssayStateStore` Enhancements (`protocols.py:EssayStateStore`, `state_store.py:SQLiteEssayStateStore`)**:
  * Add method: `async def create_or_update_essay_state_for_slot_assignment(self, internal_essay_id: str, batch_id: str, text_storage_id: str, original_file_name: str, file_size: int, content_hash: Optional[str], initial_status: EssayStatus) -> EssayState:`. This method will create a new record for the `internal_essay_id` or update it if it was pre-registered, linking it to the `text_storage_id` and other metadata.
  * Add method: `async def get_essay_by_text_storage_id_and_batch_id(self, batch_id: str, text_storage_id: str) -> Optional[EssayState]:` for the idempotency check.
  * Ensure `storage_references` in `EssayState` can correctly store the `text_storage_id` for `ContentType.ORIGINAL_ESSAY`.
* **(Task 3.5) `EventPublisher` Enhancements (`protocols.py:EventPublisher`, `implementations/event_publisher.py`)**:
  * Add method `async def publish_excess_content_provisioned(self, event_data: ExcessContentProvisionedV1, correlation_id: Optional[UUID]) -> None:`.
  * Ensure `publish_batch_essays_ready` uses the new `BatchEssaysReady` structure.
* **(Task 3.6) BOS Command Consumption & Processing (`BatchServiceSpellcheckInitiateCommandDataV1`)**:
  * Ensure subscription, routing, and handling for `BatchServiceSpellcheckInitiateCommandDataV1` are fully implemented in `worker_main.py` and `batch_command_handlers.py`.
  * Implement `DefaultBatchCommandHandler.process_initiate_spellcheck_command`:
    * For each `EssayProcessingInputRefV1` in the command's `essays_to_process` list:
      * Update the state of the HuleEdu-internal `essay_id` in `EssayStateStore` to `AWAITING_SPELLCHECK`.
    * Call `DefaultSpecializedServiceRequestDispatcher.dispatch_spellcheck_requests` with the list of `EssayProcessingInputRefV1` and `language` from the command.
  * Implement `DefaultSpecializedServiceRequestDispatcher.dispatch_spellcheck_requests`:
    * For each `EssayProcessingInputRefV1`:
      * Construct an `EssayLifecycleSpellcheckRequestV1` event using its `essay_id` (which is the HuleEdu-internal ID), `text_storage_id`, and the `language`.
      * Publish this event to the Spell Checker Service topic (`topic_name(ProcessingEvent.ESSAY_SPELLCHECK_REQUESTED)` needs to be correctly mapped or a new event like `ESSAY_LIFECYCLE_SPELLCHECK_REQUESTED` should be used for this specific command from ELS to Spell Checker).
  * Justification: Completes the command processing loop within ELS and ensures `text_storage_id` is used for actual content operations by specialized services.

**4.4. Batch Orchestrator Service (BOS) Modifications (`services/batch_orchestrator_service/`)**

* **(Task 4.1) In `implementations/batch_processing_service_impl.py:register_new_batch`**:
  * When BOS registers a new batch, it **must** generate a list of unique HuleEdu-internal `essay_id`s (e.g., UUIDs) based on `registration_data.expected_essay_count`.
  * These HuleEdu-internal `essay_id`s **must** be included in the `BatchEssaysRegistered.essay_ids` field (renaming from `expected_essay_ids` for clarity if necessary, but current `essay_ids` field is suitable if defined as the list of slots).
  * Justification: BOS is the source of truth for the batch structure and the "slots" ELS will fill.
* **(Task 4.2) In `kafka_consumer.py:_handle_message` (handler for `BatchEssaysReady`)**:
  * Update logic to consume the modified `BatchEssaysReady` (with `ready_essays: List[EssayProcessingInputRefV1]`).
  * Use the HuleEdu-internal `essay_id`s and actual `text_storage_id`s from `ready_essays` when constructing `BatchServiceSpellcheckInitiateCommandDataV1.essays_to_process`.
  * The `language` will be inferred using `_infer_language_from_course_code` as currently implemented, using the `batch_context` fetched from `batch_repo`.
  * Justification: Ensures BOS commands ELS with the correct content references for further processing.
* **(Task 4.3) `ExcessContentProvisionedV1` Handling (TODO Marker)**:
  * In `kafka_consumer.py`, add a TODO comment indicating that BOS should eventually subscribe to `ExcessContentProvisionedV1` events. The handling logic could involve logging, alerting, or updating batch metadata. For the walking skeleton, logging might be sufficient.

**4.5. Spell Checker Service Modifications (`services/spell_checker_service/`)**

* **(Task 5.1) In `event_processor.py:process_single_message`**:
  * Update the expected event model for deserialization from `EventEnvelope[SpellcheckRequestedDataV1]` to `EventEnvelope[EssayLifecycleSpellcheckRequestV1]`. This event is sent by ELS.
  * Extract and use `event_data.language` when calling the spell checking logic.
  * The `text_storage_id` will be correctly received from ELS through this event.
  * Justification: Aligns with ELS dispatching a richer, context-aware event to specialized services. The topic consumed by Spell Checker should match the topic ELS publishes `EssayLifecycleSpellcheckRequestV1` to. This might need a new `ProcessingEvent` enum like `ESSAY_LIFECYCLE_SPELLCHECK_COMMANDED` and its topic mapping if it's different from the current `ESSAY_SPELLCHECK_REQUESTED` used by BOS. Given ELS now commands the spellchecker, a new specific event type from ELS is cleaner.
    * **Clarification**: For the walking skeleton, ELS will publish `EssayLifecycleSpellcheckRequestV1`. The Spell Checker Service's input topic should align with this. `common_core/enums.py`'s `topic_name` for `ProcessingEvent.ESSAY_SPELLCHECK_REQUESTED` is currently `"huleedu.essay.spellcheck.requested.v1"`. ELS should publish to this, or a new topic/event enum needs to be defined if this topic is reserved for BOS->SpellChecker (which is no longer the direct path for this command). *Decision*: ELS will publish `EssayLifecycleSpellcheckRequestV1` to the existing `huleedu.essay.spellcheck.requested.v1` topic, and Spell Checker will now expect this richer payload from ELS.

---
**5. Affected Files Summary:**

* `common_core/src/common_core/enums.py`
* `common_core/src/common_core/events/batch_coordination_events.py` (or new `file_events.py`)
* `common_core/src/common_core/metadata_models.py` (confirm `EssayProcessingInputRefV1`)
* `common_core/src/common_core/essay_service_models.py` (confirm `EssayLifecycleSpellcheckRequestV1`)
* `services/file_service/core_logic.py`
* `services/file_service/api/file_routes.py`
* `services/file_service/protocols.py` (if MD5 hash calculation implies changes)
* `services/essay_lifecycle_service/worker_main.py`
* `services/essay_lifecycle_service/batch_command_handlers.py`
* `services/essay_lifecycle_service/batch_tracker.py`
* `services/essay_lifecycle_service/protocols.py`
* `services/essay_lifecycle_service/state_store.py`
* `services/essay_lifecycle_service/implementations/event_publisher.py`
* `services/essay_lifecycle_service/implementations/batch_command_handler_impl.py`
* `services/essay_lifecycle_service/implementations/service_request_dispatcher.py`
* `services/batch_orchestrator_service/implementations/batch_processing_service_impl.py`
* `services/batch_orchestrator_service/kafka_consumer.py`
* `services/spell_checker_service/event_processor.py`
* `services/spell_checker_service/protocols.py` (if method signatures change due to language, though likely not)

---
**6. Involved Enums, Pydantic Models, and Kafka Topics:**

* **New Enums (`ProcessingEvent`)**:
  * `ESSAY_CONTENT_PROVISIONED`
  * `EXCESS_CONTENT_PROVISIONED`
* **New Pydantic Models**:
  * `EssayContentProvisionedV1` (Fields: `batch_id`, `original_file_name`, `text_storage_id`, `file_size_bytes`, `content_md5_hash`, `correlation_id`, `timestamp`)
  * `ExcessContentProvisionedV1` (Fields: `batch_id`, `original_file_name`, `text_storage_id`, `reason`, `correlation_id`, `timestamp`)
* **Modified Pydantic Models**:
  * `BatchEssaysRegistered`: Ensure field `essay_ids: List[str]` correctly represents the HuleEdu-internal slots generated by BOS.
  * `BatchEssaysReady`: Payload changed to `ready_essays: List[EssayProcessingInputRefV1]`.
* **Key Involved Pydantic Models**:
  * `common_core.metadata_models.EssayProcessingInputRefV1` (payload of `BatchEssaysReady.ready_essays`)
  * `common_core.events.envelope.EventEnvelope`
  * `common_core.batch_service_models.BatchServiceSpellcheckInitiateCommandDataV1` (BOS to ELS)
  * `common_core.essay_service_models.EssayLifecycleSpellcheckRequestV1` (ELS to Spell Checker)
* **New Kafka Topics** (example names):
  * `huleedu.file.essay.content.provisioned.v1` (for `EssayContentProvisionedV1`)
  * `huleedu.els.excess.content.provisioned.v1` (for `ExcessContentProvisionedV1`)
* **Key Involved Kafka Topics**:
  * `huleedu.batch.essays.registered.v1` (BOS to ELS)
  * `huleedu.els.batch.essays.ready.v1` (ELS to BOS)
  * Topic for `BatchServiceSpellcheckInitiateCommandDataV1` (BOS to ELS) - *Need to define if not existing, e.g., `huleedu.bos.els.command.v1`*
  * `huleedu.essay.spellcheck.requested.v1` (ELS to Spell Checker, carrying `EssayLifecycleSpellcheckRequestV1`)

---
**7. Compatibility of Status/Event Logic with Internal Essay ID:**

The introduction of a HuleEdu-internal `essay_id` (slot) managed by BOS and ELS is a fundamental shift but compatible if implemented as described:

* **File Service**: No longer deals with HuleEdu-internal `essay_id`s. It processes files and emits `EssayContentProvisionedV1` with its own context (`batch_id`, `original_file_name`, `text_storage_id`). This simplifies File Service.
* **ELS**:
  * `EssayState` will now be primarily keyed or identified by the HuleEdu-internal `essay_id`.
  * The `batch_tracker` will track fulfillment of these internal `essay_id` slots.
  * When consuming `EssayContentProvisionedV1`, ELS assigns an internal `essay_id` to the `text_storage_id` and `original_file_name`. The essay status for this internal `essay_id` becomes `READY_FOR_PROCESSING`.
  * When consuming commands from BOS (like `BatchServiceSpellcheckInitiateCommandDataV1`), ELS will use the HuleEdu-internal `essay_id`s specified in the command to update its `EssayStateStore` (e.g., to `AWAITING_SPELLCHECK`).
  * When ELS dispatches tasks to specialized services (e.g., `EssayLifecycleSpellcheckRequestV1` to Spell Checker), it will still use the HuleEdu-internal `essay_id` for the `entity_ref` within the event payload for context, but critically, it will provide the `text_storage_id` for the specialized service to fetch the actual content. The `language` parameter will also be passed.
* **BOS**:
  * Generates HuleEdu-internal `essay_id`s upon batch registration.
  * Receives `BatchEssaysReady` containing these internal `essay_id`s mapped to their respective `text_storage_id`s.
  * Commands ELS using these internal `essay_id`s and passing the `text_storage_id`s where necessary for ELS to then relay to specialized services.
* **Spell Checker Service**:
  * Receives `EssayLifecycleSpellcheckRequestV1` from ELS. This event will contain the `text_storage_id` (which it uses to fetch content) and the `language`. The `entity_ref` within the event will use the HuleEdu-internal `essay_id`. This is consistent.

This approach maintains a clear distinction:

* **HuleEdu-internal `essay_id`**: Used for tracking, state management within ELS, and as the primary essay identifier in commands between BOS and ELS.
* **`text_storage_id`**: Used by any service that needs to fetch the actual content of an essay from the Content Service.

The overall event logic and status transitions can adapt to this. For instance, ELS's `StateTransitionValidator` will operate based on the status of the HuleEdu-internal `essay_id`.

This refined task ticket should provide a very clear and actionable plan.

---

# PHASED IMPLEMENTATION PLAN

**Status**: IN PROGRESS  
**Current Phase**: Phase 1 - Common Core Foundation ‚úÖ COMPLETED  
**Last Updated**: 2025-01-30  
**User Feedback Addressed**: ‚úÖ Document cleanup & Event contract separation

## üìã **IMPLEMENTATION STRATEGY**

This task will be implemented in 6 carefully orchestrated phases with mandatory checkpoints between each phase. Each phase must be completed fully and validated before proceeding to the next phase.

### **EXECUTION PRINCIPLES:**
- **Sequential Validation**: Each phase must pass all checkpoints before proceeding
- **Incremental Testing**: Test at each phase boundary to prevent issue accumulation  
- **Documentation Updates**: Update this document with implementation details after each phase
- **Rollback Capability**: Each phase can be reverted if critical issues arise
- **Best Practices**: All code must pass `pdm run lint-all` and `pdm run typecheck-all`
- **‚úÖ Mandatory Phase Cleanup**: Remove detailed instructions from completed phases to keep document manageable
- **‚úÖ Architectural Integrity**: Ensure proper separation of concerns in all implementations

---

## üîß **PHASE 1: Common Core Foundation** 
**Status**: ‚úÖ COMPLETED  
**Estimated Time**: 2-3 hours  
**Actual Time**: 1.5 hours  
**Dependencies**: None (blocking for all other phases)  
**Completed**: 2025-01-30 (Phase completion timestamp)

### **Phase 1 Implementation Details:**
**‚úÖ COMPLETED** - 2025-01-30

#### **Successfully Implemented:**

1. **Task 1.1: ProcessingEvent Enums** ‚úÖ
   - **File**: `common_core/src/common_core/enums.py`
   - **Added**: `ESSAY_CONTENT_PROVISIONED = "essay.content.provisioned"`
   - **Added**: `EXCESS_CONTENT_PROVISIONED = "excess.content.provisioned"`
   - **Updated**: `_TOPIC_MAPPING` with correct topic names:
     - `ESSAY_CONTENT_PROVISIONED` ‚Üí `"huleedu.file.essay.content.provisioned.v1"`
     - `EXCESS_CONTENT_PROVISIONED` ‚Üí `"huleedu.els.excess.content.provisioned.v1"`

2. **Task 1.2: EssayContentProvisionedV1 Event Model** ‚úÖ
   - **File**: `common_core/src/common_core/events/file_events.py` (NEW FILE - proper separation of concerns)
   - **Added**: Complete model with all required fields
   - **Includes**: `batch_id`, `original_file_name`, `text_storage_id`, `file_size_bytes`
   - **Optional**: `content_md5_hash`, `correlation_id`
   - **Auto-generated**: `timestamp` with UTC timezone

3. **Task 1.3: ExcessContentProvisionedV1 Event Model** ‚úÖ
   - **File**: `common_core/src/common_core/events/batch_coordination_events.py`
   - **Added**: Complete model for handling excess content
   - **Includes**: `batch_id`, `original_file_name`, `text_storage_id`, `reason`
   - **Optional**: `correlation_id`
   - **Auto-generated**: `timestamp` with UTC timezone

4. **Task 1.4: Modified BatchEssaysReady Event Model** ‚úÖ
   - **File**: `common_core/src/common_core/events/batch_coordination_events.py`
   - **Changed**: `ready_essay_ids: list[str]` ‚Üí `ready_essays: list[EssayProcessingInputRefV1]`
   - **Removed**: `total_count: int` field (derivable from ready_essays length)

5. **Task 1.5: Validated Dependent Models** ‚úÖ
   - **Confirmed**: `EssayProcessingInputRefV1` has required fields: `essay_id`, `text_storage_id`, `student_name`
   - **Confirmed**: `EssayLifecycleSpellcheckRequestV1` has required fields: `text_storage_id`, `language`

#### **Architecture Improvements (Addressing User Feedback):**

1. **‚úÖ Proper Separation of Concerns**:
   - **File Events** (`file_events.py`): File Service domain events (`EssayContentReady`, `EssayContentProvisionedV1`)
   - **Batch Coordination** (`batch_coordination_events.py`): BOS/ELS coordination events (`BatchEssaysRegistered`, `BatchEssaysReady`, `ExcessContentProvisionedV1`)
   - **Domain Clarity**: Each event file now serves a single domain responsibility

2. **‚úÖ Updated Import Structure**:
   - Fixed all service imports to use correct event file locations
   - Updated `common_core/__init__.py` with proper exports
   - Added proper union types for each event domain

3. **‚úÖ Documentation Cleanup**:
   - Removed detailed task instructions from completed Phase 1 (mandatory after completion)
   - Kept only implementation summary and architectural notes
   - Document now remains manageable and focused on outcomes

#### **All Checkpoints Passed:**
‚úÖ **Code Quality**: `pdm run lint-all` & `pdm run typecheck-all` - All passed  
‚úÖ **Import Validation**: New models import successfully from correct files  
‚úÖ **Enum Validation**: New enums and topic mappings work correctly  
‚úÖ **Schema Validation**: Models instantiate and validate properly  
‚úÖ **Architecture Review**: Event contracts properly separated by domain

#### **Important Notes:**
- Temporary implementation in `batch_tracker.py` for `BatchEssaysReady` construction (Phase 4 will fix)
- Event contracts properly separated by domain concerns per architectural best practices
- All common core contracts in place for remaining phases
- **Phase cleanup completed**: Detailed instructions removed to keep document manageable

#### **Files Created/Modified:**
- **NEW**: `common_core/src/common_core/events/file_events.py`
- **MODIFIED**: `common_core/src/common_core/events/batch_coordination_events.py`
- **MODIFIED**: `common_core/src/common_core/__init__.py`
- **MODIFIED**: Multiple service import statements updated

#### **Ready for Next Phase:**
All common core contracts are now in place with proper architectural separation. Phase 2 (File Service) and Phase 3 (BOS) can proceed in parallel.

---

## üîÑ **PHASE 2: File Service Updates**

**Status**: ‚úÖ COMPLETED (2025-06-01)  
**Estimated Time**: 1-2 hours  
**Actual Time**: 45 minutes  
**Dependencies**: Phase 1 complete ‚úÖ

### **Phase 2 Objectives:**

Remove essay ID generation from File Service and replace event publishing with new EssayContentProvisionedV1 events.

### **Phase 2 Implementation Details:**

**‚úÖ COMPLETED** - 2025-06-01 (Phase completion timestamp)

#### **Successfully Implemented:**

1. **Task 2A.1: Core Logic Updates** ‚úÖ
   - **File**: `services/file_service/core_logic.py`
   - **Removed**: `essay_id = str(uuid.uuid4())` generation
   - **Added**: MD5 hash calculation for file content integrity
   - **Replaced**: `EssayContentReady` with `EssayContentProvisionedV1` event construction
   - **Updated**: Return structure to include `text_storage_id` instead of `essay_id`

2. **Task 2A.2: Protocol Interface Updates** ‚úÖ
   - **File**: `services/file_service/protocols.py`
   - **Added**: `publish_essay_content_provisioned` method to `EventPublisherProtocol`
   - **Import**: Added `EssayContentProvisionedV1` import

3. **Task 2A.3: DI Implementation Updates** ‚úÖ
   - **File**: `services/file_service/di.py`
   - **Added**: `publish_essay_content_provisioned` method to `DefaultEventPublisher`
   - **Implemented**: Complete event envelope construction and Kafka publishing

4. **Task 2A.4: Configuration Updates** ‚úÖ
   - **File**: `services/file_service/config.py`
   - **Added**: `ESSAY_CONTENT_PROVISIONED_TOPIC` setting using `topic_name(ProcessingEvent.ESSAY_CONTENT_PROVISIONED)`

#### **Validation Results:**

**‚úÖ Checkpoint 2A**: Code Quality Validation
- **Linting**: `pdm run ruff check services/file_service/` - All checks passed
- **Type Checking**: `pdm run typecheck-all` - Success, no issues found in 94 source files

**‚úÖ Checkpoint 2B**: Functional Validation  
- **Service Health**: HTTP 200 from `http://localhost:7001/healthz`
- **Event Publishing**: EssayContentProvisionedV1 events successfully published to `huleedu.file.essay.content.provisioned.v1`
- **Data Integrity**: MD5 hash calculation working, file size tracking implemented
- **Legacy Event Elimination**: No EssayContentReady events published in new code

#### **Architectural Impact:**

1. **Essay ID Coordination Fix**: File Service no longer generates internal essay IDs, eliminating the coordination mismatch discovered in testing
2. **Event Contract Alignment**: Uses Phase 1 event contracts (`EssayContentProvisionedV1`) properly  
3. **Data Flow Enhancement**: `text_storage_id` propagation works correctly for downstream services
4. **Content Integrity**: Added MD5 hash and file size tracking for better validation

#### **Test Evidence:**

- **Upload Test**: Successfully uploaded test file with batch_id `test-batch-phase2-v2`
- **Event Logs**: `Published EssayContentProvisionedV1 event for file: test_essay.txt`
- **Storage Logs**: `Stored content for file test_essay.txt, text_storage_id: 7de1265be60f4117aa9ad983e41b74ac`
- **Topic Creation**: `huleedu.file.essay.content.provisioned.v1` auto-created in Kafka

#### **Phase Cleanup Notes:**
- Container rebuild required to pick up code changes (`docker-compose build file_service`)
- Topic auto-creation warning expected for new topics
- All File Service functionality preserved, only internal ID generation removed

#### **Ready for Next Phase:**
File Service now publishes EssayContentProvisionedV1 events that ELS can consume for slot assignment. Phase 3 (BOS) can proceed in parallel.

---

## üéõÔ∏è **PHASE 3: BOS Updates**

**Status**: ‚úÖ COMPLETED (2025-06-01)  
**Estimated Time**: 2-3 hours  
**Actual Time**: 50 minutes  
**Dependencies**: Phase 1 complete (can run parallel with Phase 2)  

### **Phase 3 Objectives:**

Update BOS to generate internal essay IDs and consume modified BatchEssaysReady events.

### **Phase 3 Implementation Details:**

**‚úÖ COMPLETED** - 2025-06-01 (Phase completion timestamp)

#### **Successfully Implemented:**

1. **Task 3A.1: Batch Registration Updates** ‚úÖ
   - **File**: `services/batch_orchestrator_service/implementations/batch_processing_service_impl.py`
   - **Added**: Internal essay ID generation based on `expected_essay_count`
   - **Updated**: BatchEssaysRegistered event to use generated internal IDs instead of user-provided ones
   - **Result**: BOS now generates authoritative essay identifier slots for each batch

2. **Task 3A.2: Event Consumption Updates** ‚úÖ
   - **File**: `services/batch_orchestrator_service/kafka_consumer.py`
   - **Updated**: BatchEssaysReady handler to use `ready_essays` structure
   - **Removed**: Mock text_storage_id pattern, now uses actual data from ELS
   - **Enhanced**: Documentation to reflect new architecture flow

3. **Task 3A.3: Excess Content Handling TODO** ‚úÖ
   - **File**: `services/batch_orchestrator_service/kafka_consumer.py`
   - **Added**: TODO marker for ExcessContentProvisionedV1 subscription and handling

#### **Validation Results:**

**‚úÖ Checkpoint 3A**: Code Quality Validation
- **Linting**: `pdm run ruff check services/batch_orchestrator_service/` - All checks passed
- **Type Checking**: `pdm run typecheck-all` - Success, no issues found in 94 source files

**‚úÖ Checkpoint 3B**: Functional Validation  
- **Service Health**: HTTP 200 from `http://localhost:5001/healthz`
- **Batch Registration**: Successfully registered test batch with batch_id `523d7a95-4dea-4822-b844-3747168cd2da`
- **Internal Essay ID Generation**: Generated UUIDs `["b9162e90-dd26-4e10-833f-75bac1d5611f","8d732fab-314d-4203-86e8-e73bd211b0a2"]`
- **Event Publishing**: BatchEssaysRegistered event published to `huleedu.batch.essays.registered.v1` with internal IDs

#### **Architectural Impact:**

1. **Source of Truth Establishment**: BOS now generates authoritative internal essay identifiers, eliminating ID coordination mismatches
2. **Event Contract Compliance**: Uses Phase 1 BatchEssaysRegistered structure with proper internal essay_ids
3. **Mock Data Elimination**: Removed mock storage ID patterns, now ready for actual ELS data flow
4. **Forward Compatibility**: Added TODO for excess content handling for complete workflow coverage

#### **Test Evidence:**

- **Batch Registration**: Successfully ignored user IDs `["ignored-user-id-1", "ignored-user-id-2"]`
- **Internal ID Generation**: Generated proper UUIDs for `expected_essay_count: 2`
- **Event Publishing**: Kafka event confirmed with correct structure and generated IDs
- **Correlation Tracking**: Event published with correlation_id `1c7383b8-1539-4e6d-be2b-aa436380edcb`

#### **Phase Cleanup Notes:**
- Container rebuild required to pick up code changes (`docker-compose build batch_orchestrator_service`)
- Event published to correct topic `huleedu.batch.essays.registered.v1`
- All user-provided essay IDs properly replaced with internal generation

#### **Ready for Next Phase:**
BOS now generates internal essay ID slots and is ready to consume BatchEssaysReady events with actual text_storage_id data from ELS. Phase 4 (ELS Major Overhaul) can proceed.

---

## ‚öôÔ∏è **PHASE 4: ELS Major Overhaul**

**Status**: BLOCKED (Waiting for Phase 1)  
**Estimated Time**: 6-8 hours  
**Dependencies**: Phase 1 complete  

### **Phase 4 Objectives:**

Implement slot assignment logic, new event handlers, and command processing in ELS.

### **Phase 4 Tasks:**

[Detailed tasks as outlined in original plan]

### **Phase 4 Mandatory Checkpoints:**

**üö® CRITICAL: These checkpoints CANNOT be skipped**

1. **ELS Worker Health**: Verify ELS worker continues processing events
2. **Slot Assignment Test**: Verify idempotent slot assignment works
3. **Batch Completion Test**: Verify BatchEssaysReady emission with correct structure
4. **Command Processing Test**: Verify BOS‚ÜíELS command handling
5. **Code Quality**: `pdm run lint-all && pdm run typecheck-all`

### **Phase 4 Implementation Details:**

*Will be filled in after Phase 4 completion*

---

## üî§ **PHASE 5: Spell Checker Updates**

**Status**: BLOCKED (Waiting for Phase 1 & 4)  
**Estimated Time**: 1 hour  
**Dependencies**: Phase 1 and 4 complete  

### **Phase 5 Objectives:**

Update Spell Checker to consume EssayLifecycleSpellcheckRequestV1 events.

### **Phase 5 Mandatory Checkpoints:**

**üö® CRITICAL: These checkpoints CANNOT be skipped**

1. **Event Consumption Test**: Verify Spell Checker processes new event format
2. **Language Field Usage**: Verify language parameter utilized in spell checking
3. **Code Quality**: `pdm run lint-all && pdm run typecheck-all`

### **Phase 5 Implementation Details:**

*Will be filled in after Phase 5 completion*

---

## üß™ **PHASE 6: Integration Testing & Validation**

**Status**: BLOCKED (Waiting for Phases 1-5)  
**Estimated Time**: 3-4 hours  
**Dependencies**: All previous phases complete  

### **Phase 6 Objectives:**

Comprehensive end-to-end testing and validation of complete workflow.

### **Phase 6 Mandatory Checkpoints:**

**üö® CRITICAL: These checkpoints CANNOT be skipped**

1. **End-to-End Test**: Complete flow from batch registration to spell checker
2. **Existing Test Validation**: All existing tests still pass
3. **Performance Validation**: No significant performance degradation
4. **Documentation Update**: Final implementation summary

### **Phase 6 Implementation Details:**

*Will be filled in after Phase 6 completion*

---

## üìä **IMPLEMENTATION TRACKING**

### **Current Status:**

- [x] Phase 1: ‚úÖ COMPLETED (2025-01-30)
- [x] Phase 2: ‚úÖ COMPLETED (2025-06-01)  
- [x] Phase 3: ‚úÖ COMPLETED (2025-06-01)  
- [ ] Phase 4: READY TO START (Phase 1 complete)
- [ ] Phase 5: BLOCKED (Waiting for Phase 4)  
- [ ] Phase 6: BLOCKED (Waiting for Phases 1-5)

### **Risk Mitigation:**

- Each phase has rollback capability
* Checkpoints prevent issue accumulation
* Parallel development where possible
* Clear documentation for handoff

**üö® IMPORTANT**: No phase may be skipped, and all checkpoints are mandatory. Any phase that fails checkpoints must be fixed before proceeding.
