# Development-optimized Docker Compose with volume mounts for hot-reload
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
# 
# This file overrides ALL services to use development Dockerfiles and configurations.
# It ensures that development containers are started instead of production ones.

x-build-args-deps: &deps-build-args
  args:
    DEPS_IMAGE: ${DEPS_IMAGE_TAG:-huledu-deps:dev}

x-huleedu-db-env: &huleedu-db-env
  HULEEDU_DB_USER: ${HULEEDU_DB_USER}
  HULEEDU_DB_PASSWORD: ${HULEEDU_DB_PASSWORD}

services:
  # NLP Service with development optimizations
  nlp_service:
    build:
      context: .
      dockerfile: services/nlp_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    volumes:
      # Mount source code for hot-reload
      - ./services/nlp_service:/app/services/nlp_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - ./libs/huleedu_nlp_shared/src:/app/libs/huleedu_nlp_shared/src:cached
      # Exclude __pycache__ and other build artifacts
      - /app/services/nlp_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-dev-secret-key}
    # Override command for development with auto-reload if service supports it
    # command: ["pdm", "run", "dev"]  # Uncomment if you add a dev script

  # Batch Orchestrator Service with development optimizations
  batch_orchestrator_service:
    build:
      context: .
      dockerfile: services/batch_orchestrator_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.batch_orchestrator_service.app:app", "--bind", "0.0.0.0:5000", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/batch_orchestrator_service:/app/services/batch_orchestrator_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/batch_orchestrator_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Essay Lifecycle Service - Worker Component
  essay_lifecycle_worker:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "services/essay_lifecycle_service/worker_main.py"]
    volumes:
      - ./services/essay_lifecycle_service:/app/services/essay_lifecycle_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/essay_lifecycle_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Essay Lifecycle Service - API Component
  essay_lifecycle_api:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "services/essay_lifecycle_service/app.py"]
    volumes:
      - ./services/essay_lifecycle_service:/app/services/essay_lifecycle_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/essay_lifecycle_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Class Management Service
  class_management_service:
    build:
      context: .
      dockerfile: services/class_management_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.class_management_service.app:app", "--bind", "0.0.0.0:5002", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/class_management_service:/app/services/class_management_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/class_management_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Batch Conductor Service
  batch_conductor_service:
    build:
      context: .
      dockerfile: services/batch_conductor_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.batch_conductor_service.app:app", "--bind", "0.0.0.0:4002", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/batch_conductor_service:/app/services/batch_conductor_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/batch_conductor_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - BCS_PIPELINE_CONFIG_PATH=services/batch_conductor_service/pipelines.yaml

  # LLM Provider Service
  llm_provider_service:
    build:
      context: .
      dockerfile: services/llm_provider_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.llm_provider_service.app:app", "--bind", "0.0.0.0:8080", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/llm_provider_service:/app/services/llm_provider_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/llm_provider_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG

  # API Gateway Service
  api_gateway_service:
    build:
      context: .
      dockerfile: services/api_gateway_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "uvicorn", "services.api_gateway_service.app.main:app", "--host", "0.0.0.0", "--port", "8080", "--reload"]
    volumes:
      - ./services/api_gateway_service:/app/services/api_gateway_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/api_gateway_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}

  # Result Aggregator Service
  result_aggregator_service:
    container_name: huleedu_result_aggregator_service
    build:
      context: .
      dockerfile: services/result_aggregator_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.result_aggregator_service.app:app", "--bind", "0.0.0.0:4003", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/result_aggregator_service:/app/services/result_aggregator_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/result_aggregator_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # WebSocket Service
  websocket_service:
    build:
      context: .
      dockerfile: services/websocket_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "uvicorn", "services.websocket_service.main:app", "--reload", "--host", "0.0.0.0", "--port", "8080"]
    volumes:
      - ./services/websocket_service:/app/services/websocket_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/websocket_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG

  # CJ Assessment Service
  cj_assessment_service:
    build:
      context: .
      dockerfile: services/cj_assessment_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    volumes:
      - ./services/cj_assessment_service:/app/services/cj_assessment_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/cj_assessment_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - CJ_ASSESSMENT_SERVICE_LLM_BATCHING_MODE=${CJ_ASSESSMENT_SERVICE_LLM_BATCHING_MODE}
      - CJ_ASSESSMENT_SERVICE_COMPARISONS_PER_STABILITY_CHECK_ITERATION=12
      - CJ_ASSESSMENT_SERVICE_MIN_COMPARISONS_FOR_STABILITY_CHECK=12

  # Spellchecker Service (add missing services that we already optimized)
  spellchecker_service:
    build:
      context: .
      dockerfile: services/spellchecker_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    volumes:
      - ./services/spellchecker_service:/app/services/spellchecker_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - ./libs/huleedu_nlp_shared/src:/app/libs/huleedu_nlp_shared/src:cached
      - /app/services/spellchecker_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG

  # File Service
  file_service:
    build:
      context: .
      dockerfile: services/file_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.file_service.app:app", "--bind", "0.0.0.0:7001", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/file_service:/app/services/file_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/file_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Content Service
  content_service:
    build:
      context: .
      dockerfile: services/content_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.content_service.app:app", "--bind", "0.0.0.0:8000", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/content_service:/app/services/content_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/content_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG

  # Identity Service with development optimizations
  identity_service:
    build:
      context: .
      dockerfile: services/identity_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.identity_service.app:app", "--bind", "0.0.0.0:7005", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/identity_service:/app/services/identity_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/identity_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - IDENTITY_SERVICE_LOG_LEVEL=DEBUG
      - IDENTITY_SERVICE_DB_HOST=identity_db
      - IDENTITY_SERVICE_DB_PORT=5432
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Email Service with development optimizations
  email_service:
    build:
      context: .
      dockerfile: services/email_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.email_service.app:app", "--bind", "0.0.0.0:8080", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/email_service:/app/services/email_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/email_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - EMAIL_SERVICE_LOG_LEVEL=DEBUG
      - EMAIL_EMAIL_PROVIDER=${EMAIL_EMAIL_PROVIDER:-mock}  # Override with env var for SMTP testing
      # SMTP configuration (only used if EMAIL_EMAIL_PROVIDER=smtp)
      - EMAIL_SMTP_HOST=${EMAIL_SMTP_HOST:-mail.privateemail.com}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-587}
      - EMAIL_SMTP_USERNAME=${EMAIL_SMTP_USERNAME}
      - EMAIL_SMTP_PASSWORD=${EMAIL_SMTP_PASSWORD}
      - EMAIL_SMTP_USE_TLS=${EMAIL_SMTP_USE_TLS:-true}
      - EMAIL_SMTP_TIMEOUT=${EMAIL_SMTP_TIMEOUT:-30}
      - EMAIL_DEFAULT_FROM_EMAIL=${EMAIL_DEFAULT_FROM_EMAIL:-noreply@hule.education}
      - EMAIL_DEFAULT_FROM_NAME=${EMAIL_DEFAULT_FROM_NAME:-HuleEdu}
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Entitlements Service with development optimizations
  entitlements_service:
    build:
      context: .
      dockerfile: services/entitlements_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.entitlements_service.app:app", "--bind", "0.0.0.0:8083", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/entitlements_service:/app/services/entitlements_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/entitlements_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - ENTITLEMENTS_SERVICE_LOG_LEVEL=DEBUG
      - ENTITLEMENTS_USE_MOCK_REPOSITORY=false
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=entitlements_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}

  # Language Tool Service with development optimizations
  language_tool_service:
    build:
      context: .
      dockerfile: services/language_tool_service/Dockerfile.dev
      target: development
      <<: *deps-build-args
    command: ["pdm", "run", "-p", "/app", "python", "-m", "hypercorn", "services.language_tool_service.app:app", "--bind", "0.0.0.0:8085", "--worker-class", "asyncio", "--reload"]
    volumes:
      - ./services/language_tool_service:/app/services/language_tool_service:cached
      - ./libs/common_core/src:/app/libs/common_core/src:cached
      - ./libs/huleedu_service_libs/src:/app/libs/huleedu_service_libs/src:cached
      - /app/services/language_tool_service/__pycache__
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - LANGUAGE_TOOL_SERVICE_LOG_LEVEL=DEBUG
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=language_tool_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
