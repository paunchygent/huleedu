# This file defines the custom HuleEdu application microservices.
services:
  kafka_topic_setup:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app
        COPY common_core/pyproject.toml common_core/pdm.lock* ./common_core/
        COPY common_core/src ./common_core/src/
        COPY scripts/kafka_topic_bootstrap.py ./scripts/
        RUN pip install --no-cache-dir aiokafka>=0.10.0 && \
            pip install -e ./common_core/
        CMD ["python", "scripts/kafka_topic_bootstrap.py"]
    container_name: huleedu_kafka_topic_setup
    restart: "no"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_CONNECT_MAX_RETRIES=10
      - KAFKA_CONNECT_RETRY_DELAY=2.0
      - KAFKA_DEFAULT_PARTITIONS=3
      - KAFKA_DEFAULT_REPLICATION_FACTOR=1

  content_service:
    build:
      context: .
      dockerfile: services/content_service/Dockerfile
    container_name: huleedu_content_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
    networks:
      - huleedu_internal_network
    ports:
      - "8001:8000"
    volumes:
      - huleedu_content_store_data:/data/huleedu_content_store
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - CONTENT_STORE_ROOT_PATH=/data/huleedu_content_store
      - PORT=8000
      - LOG_LEVEL=INFO
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=content_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  result_aggregator_service:
    build:
      context: .
      dockerfile: services/result_aggregator_service/Dockerfile
    container_name: huleedu_result_aggregator
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      result_aggregator_db:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "4003:4003"  # API port
      - "9096:9096"  # Metrics port
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - DATABASE_URL=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@result_aggregator_db:5432/result_aggregator
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDIS_URL=redis://redis:6379
      - INTERNAL_API_KEY=${HULEEDU_INTERNAL_API_KEY}
      - LOG_LEVEL=INFO
      - SERVICE_NAME=result-aggregator-service
      - HOST=0.0.0.0
      - PORT=4003
      - METRICS_PORT=9096
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=result_aggregator
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4003/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  batch_conductor_service:
    build:
      context: .
      dockerfile: services/batch_conductor_service/Dockerfile
    container_name: huleedu_batch_conductor_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "4002:4002"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LOG_LEVEL=INFO
      - HTTP_PORT=4002
      - BCS_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=batch_conductor_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4002/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  spell_checker_service:
    build:
      context: .
      dockerfile: services/spell_checker_service/Dockerfile
    container_name: huleedu_spell_checker_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8002:8002"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - LOG_LEVEL=DEBUG
      # Database configuration
      - SPELL_CHECKER_SERVICE_DATABASE_URL=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@spellchecker_db:5432/spellchecker
      - HTTP_PORT=8002
      - SPELL_CHECKER_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=spell_checker_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8002/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  batch_orchestrator_service:
    build:
      context: .
      dockerfile: services/batch_orchestrator_service/Dockerfile
    container_name: huleedu_batch_orchestrator_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      essay_lifecycle_api:
        condition: service_healthy
      batch_orchestrator_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "5001:5000"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - BATCH_ORCHESTRATOR_SERVICE_PORT=5000
      - LOG_LEVEL=INFO
      - BATCH_ORCHESTRATOR_SERVICE_REDIS_URL=redis://redis:6379
      # Database configuration
      - BATCH_ORCHESTRATOR_DB_HOST=batch_orchestrator_db
      - BATCH_ORCHESTRATOR_DB_PORT=5432
      - BATCH_ORCHESTRATOR_DB_NAME=batch_orchestrator
      - BATCH_ORCHESTRATOR_DB_USER=${HULEEDU_DB_USER}
      - BATCH_ORCHESTRATOR_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=batch_orchestrator_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  essay_lifecycle_api:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_essay_lifecycle_api
    restart: unless-stopped
    command: ["pdm", "run", "start"]
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      essay_lifecycle_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "6001:6000"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - ESSAY_LIFECYCLE_SERVICE_HTTP_PORT=6000
      - ESSAY_LIFECYCLE_SERVICE_USE_MOCK_REPOSITORY=false
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_PATH=/data/essay_lifecycle/essay_lifecycle.db
      # PostgreSQL configuration
      - ELS_DATABASE_URL=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@essay_lifecycle_db:5432/essay_lifecycle
      - ELS_DB_HOST=essay_lifecycle_db
      - ELS_DB_PORT=5432
      - ELS_DB_NAME=essay_lifecycle
      - ELS_DB_USER=${HULEEDU_DB_USER}
      - ELS_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - LOG_LEVEL=INFO
      - ESSAY_LIFECYCLE_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=essay_lifecycle_api
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  essay_lifecycle_worker:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_essay_lifecycle_worker
    restart: unless-stopped
    command: ["pdm", "run", "start_worker"]
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      essay_lifecycle_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    environment:
      - ENV_TYPE=docker
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - ESSAY_LIFECYCLE_SERVICE_USE_MOCK_REPOSITORY=false
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_PATH=/data/essay_lifecycle/essay_lifecycle.db
      # PostgreSQL configuration
      - ELS_DATABASE_URL=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@essay_lifecycle_db:5432/essay_lifecycle
      - ELS_DB_HOST=essay_lifecycle_db
      - ELS_DB_PORT=5432
      - ELS_DB_NAME=essay_lifecycle
      - ELS_DB_USER=${HULEEDU_DB_USER}
      - ELS_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - LOG_LEVEL=INFO
      - ESSAY_LIFECYCLE_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=essay_lifecycle_worker
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    # Note: essay_lifecycle_worker is a worker service, no health check needed

  file_service:
    build:
      context: .
      dockerfile: services/file_service/Dockerfile
    container_name: huleedu_file_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "7001:7001"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - FILE_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - FILE_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - FILE_SERVICE_HTTP_PORT=7001
      - FILE_SERVICE_HOST=0.0.0.0
      - FILE_SERVICE_LOG_LEVEL=INFO
      - FILE_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=file_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7001/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  cj_assessment_service:
    build:
      context: .
      dockerfile: services/cj_assessment_service/Dockerfile
    container_name: huleedu_cj_assessment_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      cj_assessment_db:
        condition: service_healthy
      redis:
        condition: service_healthy
      llm_provider_service:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "9095:9090"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - CJ_ASSESSMENT_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CJ_ASSESSMENT_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - CJ_ASSESSMENT_SERVICE_LOG_LEVEL=INFO
      - CJ_ASSESSMENT_SERVICE_METRICS_PORT=9090
      - CJ_ASSESSMENT_SERVICE_REDIS_URL=redis://redis:6379
      - CJ_ASSESSMENT_SERVICE_LLM_PROVIDER_SERVICE_URL=http://llm_provider_service:8080/api/v1
      # Database configuration
      - CJ_ASSESSMENT_SERVICE_DATABASE_URL_CJ=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@cj_assessment_db:5432/cj_assessment
      # Testing configuration handled by LLM Provider Service
      # Default LLM configuration (passed to LLM Provider Service)
      - CJ_ASSESSMENT_SERVICE_DEFAULT_LLM_PROVIDER=anthropic
      - CJ_ASSESSMENT_SERVICE_DEFAULT_LLM_MODEL=claude-3-5-haiku-20241022
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=cj_assessment_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9090/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  api_gateway_service:
    build:
      context: .
      dockerfile: services/api_gateway_service/Dockerfile
    container_name: huleedu_api_gateway_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      batch_orchestrator_service:
        condition: service_healthy
      class_management_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8080:8080"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LOG_LEVEL=INFO
      - API_GATEWAY_SERVICE_PORT=8080
      - API_GATEWAY_SERVICE_HOST=0.0.0.0
      - API_GATEWAY_SERVICE_REDIS_URL=redis://redis:6379
      # Backend service URLs
      - BATCH_ORCHESTRATOR_SERVICE_URL=http://batch_orchestrator_service:5000
      - CLASS_MANAGEMENT_SERVICE_URL=http://class_management_service:5002
      - FILE_SERVICE_URL=http://file_service:7001
      - LLM_PROVIDER_SERVICE_URL=http://llm_provider_service:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=api_gateway_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  class_management_service:
    build:
      context: .
      dockerfile: services/class_management_service/Dockerfile
    container_name: huleedu_class_management_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      class_management_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "5002:5002"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LOG_LEVEL=INFO
      - CLASS_MANAGEMENT_SERVICE_DB_HOST=class_management_db
      - CLASS_MANAGEMENT_SERVICE_DB_PORT=5432
      - CLASS_MANAGEMENT_SERVICE_DB_NAME=huledu_class_management
      - CLASS_MANAGEMENT_SERVICE_DB_USER=${HULEEDU_DB_USER}
      - CLASS_MANAGEMENT_SERVICE_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - CLASS_MANAGEMENT_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=class_management_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5002/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s




  llm_provider_service:
    build:
      context: .
      dockerfile: services/llm_provider_service/Dockerfile
    container_name: huleedu_llm_provider_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8090:8080"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=production
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LOG_LEVEL=INFO
      - LLM_PROVIDER_SERVICE_PORT=8080
      - LLM_PROVIDER_SERVICE_HOST=0.0.0.0
      - LLM_PROVIDER_SERVICE_REDIS_URL=redis://redis:6379
      # Testing configuration
      - LLM_PROVIDER_SERVICE_USE_MOCK_LLM=${USE_MOCK_LLM:-true}
      # LLM Provider API Keys (from env)
      - LLM_PROVIDER_SERVICE_ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_PROVIDER_SERVICE_OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_PROVIDER_SERVICE_GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - LLM_PROVIDER_SERVICE_GOOGLE_PROJECT_ID=${GOOGLE_PROJECT_ID:-}
      - LLM_PROVIDER_SERVICE_OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      # Provider Selection
      - LLM_PROVIDER_SERVICE_DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-anthropic}
      - LLM_PROVIDER_SERVICE_PROVIDER_SELECTION_STRATEGY=${PROVIDER_SELECTION_STRATEGY:-priority}
      # Circuit Breaker Settings
      - LLM_PROVIDER_SERVICE_CIRCUIT_BREAKER_ENABLED=true
      - LLM_PROVIDER_SERVICE_LLM_CIRCUIT_BREAKER_FAILURE_THRESHOLD=3
      - LLM_PROVIDER_SERVICE_LLM_CIRCUIT_BREAKER_RECOVERY_TIMEOUT=120
      # Cost Management
      - LLM_PROVIDER_SERVICE_ENABLE_COST_TRACKING=true
      - LLM_PROVIDER_SERVICE_COST_ALERT_THRESHOLD_USD=${LLM_COST_ALERT_THRESHOLD:-100.0}
      # Admin API
      - LLM_PROVIDER_SERVICE_ADMIN_API_ENABLED=true
      - LLM_PROVIDER_SERVICE_ADMIN_API_KEY=${LLM_ADMIN_API_KEY}
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=llm_provider_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

