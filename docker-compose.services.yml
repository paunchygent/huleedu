# This file defines the custom HuleEdu application microservices.

# Shared logging configuration for all services
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "100m"      # 100MB per file
    max-file: "10"        # Keep 10 files = 1GB total per container
    compress: "true"      # Compress rotated logs
    labels: "service,environment"

services:
  kafka_topic_setup:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app
        COPY libs/common_core/pyproject.toml libs/common_core/pdm.lock* ./libs/common_core/
        COPY libs/common_core/src ./libs/common_core/src/
        COPY scripts/kafka_topic_bootstrap.py ./scripts/
        RUN pip install --no-cache-dir aiokafka>=0.10.0 && \
            pip install -e ./libs/common_core/
        CMD ["python", "scripts/kafka_topic_bootstrap.py"]
    container_name: huleedu_kafka_topic_setup
    restart: "no"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_CONNECT_MAX_RETRIES=10
      - KAFKA_CONNECT_RETRY_DELAY=2.0
      - KAFKA_DEFAULT_PARTITIONS=3
      - KAFKA_DEFAULT_REPLICATION_FACTOR=1
    logging: *default-logging

  content_service:
    build:
      context: .
      dockerfile: services/content_service/Dockerfile
    container_name: huleedu_content_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
    networks:
      - huleedu_internal_network
    ports:
      - "8001:8000"
    volumes:
      - huleedu_content_store_data:/data/huleedu_content_store
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - CONTENT_STORE_ROOT_PATH=/data/huleedu_content_store
      - PORT=8000
      - LOG_LEVEL=INFO
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=content_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  result_aggregator_service:
    build:
      context: .
      dockerfile: services/result_aggregator_service/Dockerfile
    container_name: huleedu_result_aggregator
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      result_aggregator_db:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "4003:4003"  # API port
      - "9096:9096"  # Metrics port
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDIS_URL=redis://redis:6379
      - HULEEDU_INTERNAL_API_KEY=${HULEEDU_INTERNAL_API_KEY}
      - LOG_LEVEL=INFO
      - SERVICE_NAME=result_aggregator_service
      - HOST=0.0.0.0
      - PORT=4003
      - METRICS_PORT=9096
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=result_aggregator
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4003/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  batch_conductor_service:
    build:
      context: .
      dockerfile: services/batch_conductor_service/Dockerfile
    container_name: huleedu_batch_conductor_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      batch_conductor_db:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "4002:4002"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - BCS_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - BCS_KAFKA_CONSUMER_GROUP_ID=batch-conductor-service-group
      - BCS_LOG_LEVEL=INFO
      - BCS_HTTP_PORT=4002
      - BCS_REDIS_URL=redis://redis:6379
      # Database configuration
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=batch_conductor_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4002/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  spellchecker_service:
    build:
      context: .
      dockerfile: services/spellchecker_service/Dockerfile
    container_name: huleedu_spellchecker_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8002:8002"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - SPELLCHECKER_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPELLCHECKER_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - SPELLCHECKER_SERVICE_LOG_LEVEL=DEBUG
      - SPELLCHECKER_SERVICE_HTTP_PORT=8002
      - SPELLCHECKER_SERVICE_REDIS_URL=redis://redis:6379
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=spellchecker_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8002/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  batch_orchestrator_service:
    build:
      context: .
      dockerfile: services/batch_orchestrator_service/Dockerfile
    container_name: huleedu_batch_orchestrator_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      essay_lifecycle_api:
        condition: service_healthy
      batch_orchestrator_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "5001:5000"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - BATCH_ORCHESTRATOR_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - BATCH_ORCHESTRATOR_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - BATCH_ORCHESTRATOR_SERVICE_PORT=5000
      - BATCH_ORCHESTRATOR_SERVICE_LOG_LEVEL=INFO
      - BATCH_ORCHESTRATOR_SERVICE_REDIS_URL=redis://redis:6379
      - BATCH_ORCHESTRATOR_SERVICE_ENVIRONMENT=${ENVIRONMENT:-production}
      # Database configuration
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=batch_orchestrator_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  essay_lifecycle_api:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_essay_lifecycle_api
    restart: unless-stopped
    command: ["pdm", "run", "start"]
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      essay_lifecycle_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "6001:6000"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - ESSAY_LIFECYCLE_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - ESSAY_LIFECYCLE_SERVICE_REDIS_URL=redis://redis:6379
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - ESSAY_LIFECYCLE_SERVICE_HTTP_PORT=6000
      - ESSAY_LIFECYCLE_SERVICE_USE_MOCK_REPOSITORY=false
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_PATH=/data/essay_lifecycle/essay_lifecycle.db
      # PostgreSQL configuration
      - ELS_DB_HOST=essay_lifecycle_db
      - ELS_DB_PORT=5432
      - ELS_DB_NAME=essay_lifecycle
      - ELS_DB_USER=${HULEEDU_DB_USER}
      - ELS_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - LOG_LEVEL=INFO
      - ESSAY_LIFECYCLE_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=essay_lifecycle_api
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  essay_lifecycle_worker:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_essay_lifecycle_worker
    restart: unless-stopped
    command: ["pdm", "run", "start_worker"]
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      essay_lifecycle_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    environment:
      - ENV_TYPE=docker
      - LOG_FORMAT=json
      - ESSAY_LIFECYCLE_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - ESSAY_LIFECYCLE_SERVICE_REDIS_URL=redis://redis:6379
      - ESSAY_LIFECYCLE_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - ESSAY_LIFECYCLE_SERVICE_USE_MOCK_REPOSITORY=false
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_PATH=/data/essay_lifecycle/essay_lifecycle.db
      # PostgreSQL configuration
      - ELS_DB_HOST=essay_lifecycle_db
      - ELS_DB_PORT=5432
      - ELS_DB_NAME=essay_lifecycle
      - ELS_DB_USER=${HULEEDU_DB_USER}
      - ELS_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - LOG_LEVEL=INFO
      - ESSAY_LIFECYCLE_SERVICE_REDIS_URL=redis://redis:6379
      - ESSAY_LIFECYCLE_SERVICE_DISABLE_IDEMPOTENCY=false
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=essay_lifecycle_worker
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    # Note: essay_lifecycle_worker is a worker service, no health check needed

  file_service:
    build:
      context: .
      dockerfile: services/file_service/Dockerfile
    container_name: huleedu_file_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      file_service_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "7001:7001"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - FILE_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - FILE_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - FILE_SERVICE_HTTP_PORT=7001
      - FILE_SERVICE_HOST=0.0.0.0
      - FILE_SERVICE_LOG_LEVEL=INFO
      - FILE_SERVICE_REDIS_URL=redis://redis:6379
      - FILE_SERVICE_ENVIRONMENT=${ENVIRONMENT:-production}
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=file_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7001/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  cj_assessment_service:
    build:
      context: .
      dockerfile: services/cj_assessment_service/Dockerfile
    container_name: huleedu_cj_assessment_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      cj_assessment_db:
        condition: service_healthy
      redis:
        condition: service_healthy
      llm_provider_service:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "9095:9090"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - CJ_ASSESSMENT_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CJ_ASSESSMENT_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - CJ_ASSESSMENT_SERVICE_LOG_LEVEL=INFO
      - CJ_ASSESSMENT_SERVICE_METRICS_PORT=9090
      - CJ_ASSESSMENT_SERVICE_REDIS_URL=redis://redis:6379
      - CJ_ASSESSMENT_SERVICE_LLM_PROVIDER_SERVICE_URL=http://llm_provider_service:8080/api/v1
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
      # Database configuration
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      # Testing configuration handled by LLM Provider Service
      # Default LLM configuration (passed to LLM Provider Service)
      - CJ_ASSESSMENT_SERVICE_DEFAULT_LLM_PROVIDER=anthropic
      - CJ_ASSESSMENT_SERVICE_DEFAULT_LLM_MODEL=claude-haiku-4-5-20251001
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=cj_assessment_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
      # JWT authentication for admin endpoints
      - CJ_ASSESSMENT_SERVICE_JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9090/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  api_gateway_service:
    build:
      context: .
      dockerfile: services/api_gateway_service/Dockerfile
    container_name: huleedu_api_gateway_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      batch_orchestrator_service:
        condition: service_healthy
      class_management_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8080:8080"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - API_GATEWAY_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - API_GATEWAY_LOG_LEVEL=INFO
      - API_GATEWAY_SERVICE_PORT=8080
      - API_GATEWAY_SERVICE_HOST=0.0.0.0
      - API_GATEWAY_SERVICE_REDIS_URL=redis://redis:6379
      # JWT Configuration
      - API_GATEWAY_JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
      # Backend service URLs
      - BATCH_ORCHESTRATOR_SERVICE_URL=http://batch_orchestrator_service:5000
      - CLASS_MANAGEMENT_SERVICE_URL=http://class_management_service:5002
      - FILE_SERVICE_URL=http://file_service:7001
      - LLM_PROVIDER_SERVICE_URL=http://llm_provider_service:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=api_gateway_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s


  class_management_service:
    build:
      context: .
      dockerfile: services/class_management_service/Dockerfile
    container_name: huleedu_class_management_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      class_management_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "5002:5002"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - CLASS_MANAGEMENT_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CLASS_MANAGEMENT_SERVICE_REDIS_URL=redis://redis:6379
      - CLASS_MANAGEMENT_SERVICE_LOG_LEVEL=INFO
      - CLASS_MANAGEMENT_SERVICE_DB_HOST=class_management_db
      - CLASS_MANAGEMENT_SERVICE_DB_PORT=5432
      - CLASS_MANAGEMENT_SERVICE_DB_NAME=huleedu_class_management
      - CLASS_MANAGEMENT_SERVICE_DB_USER=${HULEEDU_DB_USER}
      - CLASS_MANAGEMENT_SERVICE_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - CLASS_MANAGEMENT_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=class_management_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5002/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s




  llm_provider_service:
    build:
      context: .
      dockerfile: services/llm_provider_service/Dockerfile
    container_name: huleedu_llm_provider_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8090:8080"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - LLM_PROVIDER_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - LLM_PROVIDER_SERVICE_LOG_LEVEL=INFO
      - LLM_PROVIDER_SERVICE_PORT=8080
      - LLM_PROVIDER_SERVICE_HOST=0.0.0.0
      - LLM_PROVIDER_SERVICE_REDIS_URL=redis://redis:6379
      # Testing configuration
      - LLM_PROVIDER_SERVICE_USE_MOCK_LLM=${USE_MOCK_LLM:-true}
      # LLM Provider API Keys (from env)
      - LLM_PROVIDER_SERVICE_ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_PROVIDER_SERVICE_OPENAI_API_KEY=${OPENAI_API_KEY}
      - LLM_PROVIDER_SERVICE_GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - LLM_PROVIDER_SERVICE_GOOGLE_PROJECT_ID=${GOOGLE_PROJECT_ID:-}
      - LLM_PROVIDER_SERVICE_OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      # Provider Selection
      - LLM_PROVIDER_SERVICE_DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-anthropic}
      - LLM_PROVIDER_SERVICE_PROVIDER_SELECTION_STRATEGY=${PROVIDER_SELECTION_STRATEGY:-priority}
      # Circuit Breaker Settings
      - LLM_PROVIDER_SERVICE_CIRCUIT_BREAKER_ENABLED=true
      - LLM_PROVIDER_SERVICE_LLM_CIRCUIT_BREAKER_FAILURE_THRESHOLD=3
      - LLM_PROVIDER_SERVICE_LLM_CIRCUIT_BREAKER_RECOVERY_TIMEOUT=120
      # Cost Management
      - LLM_PROVIDER_SERVICE_ENABLE_COST_TRACKING=true
      - LLM_PROVIDER_SERVICE_COST_ALERT_THRESHOLD_USD=${LLM_COST_ALERT_THRESHOLD:-100.0}
      # Admin API
      - LLM_PROVIDER_SERVICE_ADMIN_API_ENABLED=true
      - LLM_PROVIDER_SERVICE_ADMIN_API_KEY=${LLM_ADMIN_API_KEY}
      - LLM_PROVIDER_SERVICE_QUEUE_PROCESSING_MODE=${LLM_PROVIDER_SERVICE_QUEUE_PROCESSING_MODE:-per_request}
      - LLM_PROVIDER_SERVICE_SERIAL_BUNDLE_MAX_REQUESTS_PER_CALL=${LLM_PROVIDER_SERVICE_SERIAL_BUNDLE_MAX_REQUESTS_PER_CALL:-8}
      - LLM_PROVIDER_SERVICE_BATCH_API_MODE=${LLM_PROVIDER_SERVICE_BATCH_API_MODE:-disabled}
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=llm_provider_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  websocket_service:
    build:
      context: .
      dockerfile: services/websocket_service/Dockerfile
    container_name: huleedu_websocket_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8081:8080"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - SERVICE_NAME=websocket_service
      - WEBSOCKET_PORT=8080
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here}
      - JWT_ALGORITHM=HS256
      - WEBSOCKET_MAX_CONNECTIONS_PER_USER=5
      - WEBSOCKET_IDLE_TIMEOUT=300
      - WEBSOCKET_PING_INTERVAL=30
      - CORS_ORIGINS=["http://localhost:3000"]
      - LOG_LEVEL=INFO
      - ENABLE_METRICS=true
      - ENABLE_TRACING=false
      - JAEGER_ENDPOINT=http://jaeger:14268/api/traces
      # Kafka configuration
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_CONSUMER_GROUP=websocket-service-consumer
      - KAFKA_CONSUMER_CLIENT_ID=websocket-service-client
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  nlp_service:
    build:
      context: .
      dockerfile: services/nlp_service/Dockerfile
    container_name: huleedu_nlp_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      nlp_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - NLP_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - NLP_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - NLP_SERVICE_LOG_LEVEL=INFO
      - NLP_SERVICE_REDIS_URL=redis://redis:6379
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=nlp_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging

  identity_service:
    build:
      context: .
      dockerfile: services/identity_service/Dockerfile
    container_name: huleedu_identity_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      identity_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "7005:7005"  # HTTP API port
      - "9097:9097"  # Prometheus metrics port
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - IDENTITY_SERVICE_DB_HOST=identity_db
      - IDENTITY_SERVICE_DB_PORT=5432
      - IDENTITY_SERVICE_DB_NAME=huleedu_identity
      - IDENTITY_SERVICE_DB_USER=${HULEEDU_DB_USER}
      - IDENTITY_SERVICE_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - IDENTITY_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - IDENTITY_REDIS_URL=redis://redis:6379
      - IDENTITY_LOG_LEVEL=INFO
      - IDENTITY_SERVICE_HOST=0.0.0.0
      - IDENTITY_SERVICE_HTTP_PORT=7005
      - IDENTITY_SERVICE_PROMETHEUS_PORT=9097
      # JWT Configuration
      - IDENTITY_SERVICE_JWT_ACCESS_TOKEN_TTL_SECONDS=900  # 15 minutes
      - IDENTITY_SERVICE_JWT_REFRESH_TOKEN_TTL_SECONDS=604800  # 7 days
      - IDENTITY_SERVICE_JWT_RSA_KEY_SIZE=2048
      - IDENTITY_JWT_ISSUER=huleedu-identity-service
      - IDENTITY_JWT_AUDIENCE=huleedu-platform
      # Security Configuration
      - IDENTITY_SERVICE_BCRYPT_ROUNDS=12
      - IDENTITY_SERVICE_MAX_LOGIN_ATTEMPTS=5
      - IDENTITY_SERVICE_LOCKOUT_DURATION_SECONDS=1800  # 30 minutes
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=identity_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7005/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  email_service:
    build:
      context: .
      dockerfile: services/email_service/Dockerfile
    container_name: huleedu_email_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      email_db:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8082:8080"  # HTTP API port (external 8082, internal 8080)
      - "9098:9098"  # Prometheus metrics port
    environment:
      # Core environment
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      # Database configuration
      - EMAIL_SERVICE_DB_HOST=email_db
      - EMAIL_SERVICE_DB_PORT=5432
      - EMAIL_SERVICE_DB_NAME=huleedu_email
      - EMAIL_SERVICE_DB_USER=${HULEEDU_DB_USER}
      - EMAIL_SERVICE_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      # Kafka and Redis
      - EMAIL_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - EMAIL_REDIS_URL=redis://redis:6379
      # Service configuration
      - EMAIL_LOG_LEVEL=INFO
      - EMAIL_SERVICE_HOST=0.0.0.0
      - EMAIL_SERVICE_HTTP_PORT=8080
      - EMAIL_SERVICE_PROMETHEUS_PORT=9098
      # Email provider configuration (SMTP for production)
      - EMAIL_EMAIL_PROVIDER=smtp
      - EMAIL_SMTP_HOST=${EMAIL_SMTP_HOST:-mail.privateemail.com}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-587}
      - EMAIL_SMTP_USERNAME=${EMAIL_SMTP_USERNAME}
      - EMAIL_SMTP_PASSWORD=${EMAIL_SMTP_PASSWORD}
      - EMAIL_SMTP_USE_TLS=${EMAIL_SMTP_USE_TLS:-true}
      - EMAIL_SMTP_TIMEOUT=${EMAIL_SMTP_TIMEOUT:-30}
      - EMAIL_DEFAULT_FROM_EMAIL=${EMAIL_DEFAULT_FROM_EMAIL:-noreply@hule.education}
      - EMAIL_DEFAULT_FROM_NAME=${EMAIL_DEFAULT_FROM_NAME:-HuleEdu}
      - EMAIL_TEMPLATE_PATH=templates
      - EMAIL_MAX_RETRY_ATTEMPTS=3
      - EMAIL_RETRY_DELAY_SECONDS=60
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=email_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  entitlements_service:
    build:
      context: .
      dockerfile: services/entitlements_service/Dockerfile
    container_name: huleedu_entitlements_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      entitlements_db:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8083:8083"
    environment:
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      - HULEEDU_DB_USER=${HULEEDU_DB_USER}
      - HULEEDU_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - ENTITLEMENTS_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - ENTITLEMENTS_REDIS_URL=redis://redis:6379
      - ENTITLEMENTS_LOG_LEVEL=INFO
      - ENTITLEMENTS_SERVICE_HOST=0.0.0.0
      - ENTITLEMENTS_METRICS_PORT=8083
      - ENTITLEMENTS_POLICY_FILE=policies/default.yaml
      - ENTITLEMENTS_POLICY_CACHE_TTL=300
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=entitlements_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  language_tool_service:
    build:
      context: .
      dockerfile: services/language_tool_service/Dockerfile
    container_name: huleedu_language_tool_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8085:8085"
    environment:
      # Core environment
      - ENV_TYPE=docker
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_FORMAT=json
      # Service configuration
      - LANGUAGE_TOOL_SERVICE_PORT=8085
      - LANGUAGE_TOOL_SERVICE_HOST=0.0.0.0
      - LANGUAGE_TOOL_SERVICE_LOG_LEVEL=INFO
      - LANGUAGE_TOOL_SERVICE_REDIS_URL=redis://redis:6379
      # LanguageTool configuration
      - LANGUAGE_TOOL_SERVICE_LANGUAGE_TOOL_PORT=8081
      - LANGUAGE_TOOL_SERVICE_LANGUAGE_TOOL_HEAP_SIZE=512m
      - LANGUAGE_TOOL_SERVICE_LANGUAGE_TOOL_JAR_PATH=/app/languagetool/languagetool-server.jar
      - LANGUAGE_TOOL_SERVICE_LANGUAGE_TOOL_MAX_CONCURRENT_REQUESTS=10
      - LANGUAGE_TOOL_SERVICE_LANGUAGE_TOOL_REQUEST_TIMEOUT_SECONDS=30
      - LANGUAGE_TOOL_SERVICE_LANGUAGE_TOOL_HEALTH_CHECK_INTERVAL=30
      # Observability
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=language_tool_service
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8085/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
