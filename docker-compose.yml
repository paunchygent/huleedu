networks:
  huleedu_internal_network:
    driver: bridge

volumes:
  huleedu_content_store_data:
  essay_lifecycle_data:
  batch_orchestrator_db_data:
  essay_lifecycle_db_data:
  cj_assessment_db_data:
  redis_data:

services:
  # PostgreSQL database for Batch Orchestrator Service
  batch_orchestrator_db:
    image: postgres:15
    container_name: huleedu_batch_orchestrator_db
    restart: unless-stopped
    networks:
      - huleedu_internal_network
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=batch_orchestrator
      - POSTGRES_USER=${HULEEDU_DB_USER}
      - POSTGRES_PASSWORD=${HULEEDU_DB_PASSWORD}
    volumes:
      - batch_orchestrator_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HULEEDU_DB_USER} -d batch_orchestrator"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # PostgreSQL database for Essay Lifecycle Service
  essay_lifecycle_db:
    image: postgres:15
    container_name: huleedu_essay_lifecycle_db
    restart: unless-stopped
    networks:
      - huleedu_internal_network
    ports:
      - "5433:5432"  # Different port from BOS database
    environment:
      - POSTGRES_DB=essay_lifecycle
      - POSTGRES_USER=${HULEEDU_DB_USER}
      - POSTGRES_PASSWORD=${HULEEDU_DB_PASSWORD}
    volumes:
      - essay_lifecycle_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HULEEDU_DB_USER} -d essay_lifecycle"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # PostgreSQL database for CJ Assessment Service
  cj_assessment_db:
    image: postgres:15
    container_name: huleedu_cj_assessment_db
    restart: unless-stopped
    networks:
      - huleedu_internal_network
    ports:
      - "5434:5432"  # Different port from other databases
    environment:
      - POSTGRES_DB=cj_assessment
      - POSTGRES_USER=${HULEEDU_DB_USER}
      - POSTGRES_PASSWORD=${HULEEDU_DB_PASSWORD}
    volumes:
      - cj_assessment_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HULEEDU_DB_USER} -d cj_assessment"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis cache for idempotency and session management
  redis:
    image: redis:7-alpine
    container_name: huleedu_redis
    restart: unless-stopped
    networks:
      - huleedu_internal_network
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: huleedu_zookeeper
    restart: unless-stopped
    networks:
      - huleedu_internal_network
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes

  kafka:
    image: bitnami/kafka:3.7 
    container_name: huleedu_kafka
    restart: unless-stopped
    depends_on:
      - zookeeper
    networks:
      - huleedu_internal_network
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092,EXTERNAL://0.0.0.0:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  kafka_topic_setup:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app
        COPY common_core/pyproject.toml common_core/pdm.lock* ./common_core/
        COPY common_core/src ./common_core/src/
        COPY scripts/kafka_topic_bootstrap.py ./scripts/
        RUN pip install --no-cache-dir aiokafka>=0.10.0 && \
            pip install -e ./common_core/
        CMD ["python", "scripts/kafka_topic_bootstrap.py"]
    container_name: huleedu_kafka_topic_setup
    restart: "no"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_CONNECT_MAX_RETRIES=10
      - KAFKA_CONNECT_RETRY_DELAY=2.0
      - KAFKA_DEFAULT_PARTITIONS=3
      - KAFKA_DEFAULT_REPLICATION_FACTOR=1

  content_service:
    build:
      context: .
      dockerfile: services/content_service/Dockerfile
    container_name: huleedu_content_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
    networks:
      - huleedu_internal_network
    ports:
      - "8001:8000"
    volumes:
      - huleedu_content_store_data:/data/huleedu_content_store 
    environment:
      - ENV_TYPE=docker
      - CONTENT_STORE_ROOT_PATH=/data/huleedu_content_store
      - PORT=8000
      - LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  spell_checker_service:
    build:
      context: .
      dockerfile: services/spell_checker_service/Dockerfile
    container_name: huleedu_spell_checker_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "8002:8002"
    environment:
      - ENV_TYPE=docker
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - LOG_LEVEL=DEBUG
      - HTTP_PORT=8002
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8002/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  batch_orchestrator_service:
    build:
      context: .
      dockerfile: services/batch_orchestrator_service/Dockerfile
    container_name: huleedu_batch_orchestrator_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      essay_lifecycle_api:
        condition: service_healthy
      batch_orchestrator_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "5001:5000"
    environment:
      - ENV_TYPE=docker
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - BATCH_ORCHESTRATOR_SERVICE_PORT=5000
      - LOG_LEVEL=INFO
      # Database configuration
      - BATCH_ORCHESTRATOR_DB_HOST=batch_orchestrator_db
      - BATCH_ORCHESTRATOR_DB_PORT=5432
      - BATCH_ORCHESTRATOR_DB_NAME=batch_orchestrator
      - BATCH_ORCHESTRATOR_DB_USER=${HULEEDU_DB_USER}
      - BATCH_ORCHESTRATOR_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  essay_lifecycle_api:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_essay_lifecycle_api
    restart: unless-stopped
    command: ["pdm", "run", "start"]
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      essay_lifecycle_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "6001:6000"
      - "9091:9090"
    environment:
      - ENV_TYPE=docker
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - ESSAY_LIFECYCLE_SERVICE_HTTP_PORT=6000
      - ESSAY_LIFECYCLE_SERVICE_PROMETHEUS_PORT=9090
      - ESSAY_LIFECYCLE_SERVICE_USE_MOCK_REPOSITORY=false  # Use PostgreSQL in production
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_PATH=/data/essay_lifecycle/essay_lifecycle.db
      # PostgreSQL configuration
      - ELS_DATABASE_URL=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@essay_lifecycle_db:5432/essay_lifecycle
      - ELS_DB_HOST=essay_lifecycle_db
      - ELS_DB_PORT=5432
      - ELS_DB_NAME=essay_lifecycle
      - ELS_DB_USER=${HULEEDU_DB_USER}
      - ELS_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - LOG_LEVEL=INFO
    volumes:
      - essay_lifecycle_data:/data/essay_lifecycle
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6000/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  essay_lifecycle_worker:
    build:
      context: .
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_essay_lifecycle_worker
    restart: unless-stopped
    command: ["pdm", "run", "start_worker"]
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      file_service:
        condition: service_healthy
      essay_lifecycle_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    environment:
      - ENV_TYPE=docker
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - ESSAY_LIFECYCLE_SERVICE_USE_MOCK_REPOSITORY=false  # Use PostgreSQL in production
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_PATH=/data/essay_lifecycle/essay_lifecycle.db
      # PostgreSQL configuration
      - ELS_DATABASE_URL=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@essay_lifecycle_db:5432/essay_lifecycle
      - ELS_DB_HOST=essay_lifecycle_db
      - ELS_DB_PORT=5432
      - ELS_DB_NAME=essay_lifecycle
      - ELS_DB_USER=${HULEEDU_DB_USER}
      - ELS_DB_PASSWORD=${HULEEDU_DB_PASSWORD}
      - LOG_LEVEL=INFO
    volumes:
      - essay_lifecycle_data:/data/essay_lifecycle
    # Note: essay_lifecycle_worker is a worker service, no health check needed

  file_service:
    build:
      context: .
      dockerfile: services/file_service/Dockerfile
    container_name: huleedu_file_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "7001:7001"
      - "9094:9094"
    environment:
      - ENV_TYPE=docker
      - FILE_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - FILE_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - FILE_SERVICE_HTTP_PORT=7001
      - FILE_SERVICE_PROMETHEUS_PORT=9094
      - FILE_SERVICE_HOST=0.0.0.0
      - FILE_SERVICE_LOG_LEVEL=INFO 
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7001/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

  cj_assessment_service:
    build:
      context: .
      dockerfile: services/cj_assessment_service/Dockerfile
    container_name: huleedu_cj_assessment_service
    restart: unless-stopped
    depends_on:
      kafka_topic_setup:
        condition: service_completed_successfully
      content_service:
        condition: service_healthy
      cj_assessment_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_internal_network
    ports:
      - "9095:9090"  # Metrics port
    environment:
      - ENV_TYPE=docker
      - CJ_ASSESSMENT_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - CJ_ASSESSMENT_SERVICE_CONTENT_SERVICE_URL=http://content_service:8000/v1/content
      - CJ_ASSESSMENT_SERVICE_LOG_LEVEL=INFO
      - CJ_ASSESSMENT_SERVICE_METRICS_PORT=9090
      # Database configuration
      - CJ_ASSESSMENT_SERVICE_DATABASE_URL_CJ=postgresql+asyncpg://${HULEEDU_DB_USER}:${HULEEDU_DB_PASSWORD}@cj_assessment_db:5432/cj_assessment
      # Testing configuration
      - CJ_ASSESSMENT_SERVICE_USE_MOCK_LLM=true  # Use mock LLM for E2E testing (no API costs)
      # LLM API Keys for real testing if mock is disabled
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
    # Note: cj_assessment_service is a worker service with metrics endpoint only 