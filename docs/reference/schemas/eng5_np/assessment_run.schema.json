{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://huleedu.dev/schemas/eng5-np/assessment_run.json",
  "title": "ENG5 NP Assessment Run Artifact",
  "type": "object",
  "required": [
    "schema_version",
    "metadata",
    "inputs",
    "llm_comparisons",
    "bt_summary",
    "grade_projections",
    "costs",
    "validation"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^1\\.0\\.\\d+$",
      "description": "Semantic version of this artefact format."
    },
    "metadata": {
      "$ref": "#/definitions/metadata"
    },
    "inputs": {
      "$ref": "#/definitions/inputs"
    },
    "llm_comparisons": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/comparison_record"
      },
      "description": "Ordered list of every LLM comparison request and outcome collected during the batch run."
    },
    "bt_summary": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/bt_entry"
      },
      "description": "Per-essay Bradleyâ€“Terry scores, standard errors, and derived ranks."
    },
    "grade_projections": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/grade_projection"
      },
      "description": "Outputs from the GradeProjector mirroring the service response."
    },
    "costs": {
      "$ref": "#/definitions/costs"
    },
    "validation": {
      "$ref": "#/definitions/validation"
    }
  },
  "definitions": {
    "metadata": {
      "type": "object",
      "required": [
        "assignment_id",
        "course_id",
        "grade_scale",
        "runner_version",
        "git_sha",
        "generated_at",
        "runner_mode"
      ],
      "properties": {
        "assignment_id": {
          "type": "string",
          "format": "uuid"
        },
        "course_id": {
          "type": "string",
          "format": "uuid"
        },
        "grade_scale": {
          "type": "string",
          "enum": [
            "eng5_np_legacy_9_step",
            "eng5_np_national_9_step"
          ],
          "description": "Registry key for the grade scale used during this run."
        },
        "runner_version": {
          "type": "string",
          "description": "Semver for the CLI/runner implementation."
        },
        "git_sha": {
          "type": "string",
          "pattern": "^[0-9a-f]{7,40}$"
        },
        "generated_at": {
          "type": "string",
          "format": "date-time"
        },
        "runner_mode": {
          "type": "string",
          "enum": [
            "plan",
            "dry-run",
            "execute"
          ]
        }
      }
    },
    "inputs": {
      "type": "object",
      "required": [
        "instructions",
        "prompt_reference",
        "anchors",
        "students"
      ],
      "properties": {
        "instructions": {
          "$ref": "#/definitions/document_blob"
        },
        "prompt_reference": {
          "$ref": "#/definitions/document_blob"
        },
        "anchors": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/anchor_record"
          },
          "minItems": 1
        },
        "students": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/student_record"
          },
          "minItems": 1
        }
      }
    },
    "document_blob": {
      "type": "object",
      "required": [
        "source_path",
        "checksum",
        "content"
      ],
      "properties": {
        "source_path": {
          "type": "string"
        },
        "checksum": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "content": {
          "type": "string"
        }
      }
    },
    "anchor_record": {
      "type": "object",
      "required": [
        "anchor_id",
        "file_name",
        "grade",
        "source_path",
        "checksum"
      ],
      "properties": {
        "anchor_id": {
          "type": "string"
        },
        "file_name": {
          "type": "string"
        },
        "grade": {
          "type": "string"
        },
        "source_path": {
          "type": "string"
        },
        "checksum": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "student_record": {
      "type": "object",
      "required": [
        "essay_id",
        "file_name",
        "source_path",
        "checksum"
      ],
      "properties": {
        "essay_id": {
          "type": "string",
          "pattern": "^[a-z0-9_-]{3,64}$"
        },
        "file_name": {
          "type": "string"
        },
        "source_path": {
          "type": "string"
        },
        "checksum": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "comparison_record": {
      "type": "object",
      "required": [
        "sequence",
        "correlation_id",
        "winner_id",
        "loser_id",
        "prompt_hash",
        "provider",
        "model",
        "tokens_prompt",
        "tokens_completion",
        "cost_usd",
        "started_at",
        "completed_at"
      ],
      "properties": {
        "sequence": {
          "type": "integer",
          "minimum": 1
        },
        "correlation_id": {
          "type": "string",
          "format": "uuid"
        },
        "winner_id": {
          "type": "string"
        },
        "loser_id": {
          "type": "string"
        },
        "prompt_hash": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "provider": {
          "type": "string"
        },
        "model": {
          "type": "string"
        },
        "tokens_prompt": {
          "type": "integer",
          "minimum": 0
        },
        "tokens_completion": {
          "type": "integer",
          "minimum": 0
        },
        "cost_usd": {
          "type": "number",
          "minimum": 0
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "completed_at": {
          "type": "string",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "enum": [
            "submitted",
            "succeeded",
            "failed"
          ]
        },
        "failure_reason": {
          "type": "string"
        }
      }
    },
    "bt_entry": {
      "type": "object",
      "required": [
        "essay_id",
        "theta",
        "standard_error",
        "rank",
        "comparison_count",
        "is_anchor"
      ],
      "properties": {
        "essay_id": {
          "type": "string"
        },
        "theta": {
          "type": "number"
        },
        "standard_error": {
          "type": "number",
          "minimum": 0
        },
        "rank": {
          "type": "integer",
          "minimum": 1
        },
        "comparison_count": {
          "type": "integer",
          "minimum": 0
        },
        "is_anchor": {
          "type": "boolean"
        },
        "anchor_grade": {
          "type": "string"
        },
        "grade_projection": {
          "type": "string"
        }
      }
    },
    "grade_projection": {
      "type": "object",
      "required": [
        "essay_id",
        "grade_scale",
        "grade",
        "probabilities"
      ],
      "properties": {
        "essay_id": {
          "type": "string"
        },
        "grade_scale": {
          "type": "string"
        },
        "grade": {
          "type": "string"
        },
        "probabilities": {
          "type": "object",
          "additionalProperties": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          }
        },
        "primary_anchor_id": {
          "type": "string"
        },
        "anchor_alignment": {
          "type": "string"
        }
      }
    },
    "costs": {
      "type": "object",
      "required": [
        "total_usd",
        "token_counts"
      ],
      "properties": {
        "total_usd": {
          "type": "number",
          "minimum": 0
        },
        "token_counts": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/cost_breakdown"
          }
        }
      }
    },
    "cost_breakdown": {
      "type": "object",
      "required": [
        "provider",
        "model",
        "prompt_tokens",
        "completion_tokens",
        "usd"
      ],
      "properties": {
        "provider": {
          "type": "string"
        },
        "model": {
          "type": "string"
        },
        "prompt_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "completion_tokens": {
          "type": "integer",
          "minimum": 0
        },
        "usd": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "validation": {
      "type": "object",
      "required": [
        "artefact_checksum",
        "manifest",
        "cli_environment"
      ],
      "properties": {
        "artefact_checksum": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "manifest": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/manifest_entry"
          }
        },
        "cli_environment": {
          "type": "object",
          "required": [
            "python",
            "pdm",
            "os",
            "docker_compose"
          ],
          "properties": {
            "python": {
              "type": "string"
            },
            "pdm": {
              "type": "string"
            },
            "os": {
              "type": "string"
            },
            "docker_compose": {
              "type": "string"
            }
          }
        }
      }
    },
    "manifest_entry": {
      "type": "object",
      "required": [
        "path",
        "sha256",
        "bytes"
      ],
      "properties": {
        "path": {
          "type": "string"
        },
        "sha256": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "bytes": {
          "type": "integer",
          "minimum": 0
        }
      }
    }
  }
}
