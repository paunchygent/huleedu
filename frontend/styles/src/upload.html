<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladda upp filer – HuleEdu</title>
    <meta name="description" content="Ladda upp elevtexter för automatiserad bedömning.">
    
    <!-- Fonts: IBM Plex industrial type system -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Serif:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="tailwind.css">
    
    <!-- Inline fallback for file:// protocol viewing -->
    <style>
        .form-select {
            width: 100%;
            border: 1px solid rgba(28, 46, 74, 0.3);
            background-color: var(--color-canvas);
            padding: 0.75rem 1rem;
            color: var(--color-navy);
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%231C2E4A' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(28, 46, 74, 0.6);
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body class="font-sans">
<!-- Skip link -->
<a href="#main-content" class="skip-link">Hoppa till huvudinnehåll</a>

<div class="ledger-frame min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="h-16 border-b border-navy shrink-0 flex items-center justify-between px-6" role="banner">
        <a href="/" aria-label="HuleEdu startsida">
            <img src="HuleEduLogo.svg" alt="HuleEdu" class="h-8 w-auto">
        </a>
        <a href="/dashboard" class="text-xs font-semibold uppercase tracking-label text-navy/60 hover:text-navy transition-colors">
            ← Tillbaka
        </a>
    </header>

    <!-- Main content -->
    <main id="main-content" class="flex-grow p-6 md:p-12" role="main">
        
        <div class="max-w-2xl mx-auto">
            
            <!-- Page header -->
            <div class="mb-8">
                <h1 class="text-2xl md:text-3xl font-extrabold text-navy tracking-tightest mb-2">
                    Ny batch
                </h1>
                <p class="text-navy/60">
                    Ladda upp elevtexter och välj om de ska kopplas till en klass.
                </p>
            </div>

            <!-- Step 1: Mode selection -->
            <div class="mb-8" data-step="1">
                <h2 class="text-xs font-semibold uppercase tracking-label text-navy/60 mb-4">Steg 1 · Välj typ</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- REGULAR mode -->
                    <label class="batch-mode-option border border-navy p-5 cursor-pointer hover:bg-navy/[0.02] transition-colors has-[:checked]:bg-navy has-[:checked]:text-canvas">
                        <input type="radio" name="batch_mode" value="regular" class="sr-only" checked>
                        <div class="flex items-start gap-4">
                            <div class="w-5 h-5 border-2 border-current rounded-full flex items-center justify-center shrink-0 mt-0.5">
                                <div class="w-2.5 h-2.5 bg-current rounded-full opacity-0 check-indicator"></div>
                            </div>
                            <div>
                                <div class="font-bold mb-1">Koppla till klass</div>
                                <p class="text-sm opacity-70">Texterna matchas mot klassens elevlista. Du bekräftar matchningarna innan bedömning.</p>
                            </div>
                        </div>
                    </label>
                    
                    <!-- GUEST mode -->
                    <label class="batch-mode-option border border-navy p-5 cursor-pointer hover:bg-navy/[0.02] transition-colors has-[:checked]:bg-navy has-[:checked]:text-canvas">
                        <input type="radio" name="batch_mode" value="guest" class="sr-only">
                        <div class="flex items-start gap-4">
                            <div class="w-5 h-5 border-2 border-current rounded-full flex items-center justify-center shrink-0 mt-0.5">
                                <div class="w-2.5 h-2.5 bg-current rounded-full opacity-0 check-indicator"></div>
                            </div>
                            <div>
                                <div class="font-bold mb-1">Gästläge</div>
                                <p class="text-sm opacity-70">Snabb analys utan elevkoppling. Perfekt för övningar eller anonyma texter.</p>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Class selector (shown only for REGULAR mode) -->
            <div id="class-selector" class="mb-8">
                <label for="class-select" class="form-label">Välj klass</label>
                <select 
                    id="class-select" 
                    name="class_id"
                    class="form-select"
                >
                    <option value="">— Välj klass —</option>
                    <option value="sa22b">SA22B · Svenska 3</option>
                    <option value="ek21a">EK21A · Engelska 7</option>
                    <option value="na21b">NA21B · Svenska 2</option>
                </select>
            </div>

            <!-- Step 2: File upload -->
            <div class="mb-4" data-step="2">
                <h2 class="text-xs font-semibold uppercase tracking-label text-navy/60 mb-4">Steg 2 · Välj filer</h2>
                <p class="text-sm text-navy/60 mb-4">.txt, .pdf eller .docx · Max 50 filer · Max 100 MB totalt</p>
            </div>

            <!-- Upload form -->
            <form id="upload-form" action="/api/v1/files/batch" method="POST" enctype="multipart/form-data">
                
                <!-- Hidden batch_id (would be set by JS or server) -->
                <input type="hidden" name="batch_id" id="batch-id" value="">

                <!-- Drop zone -->
                <div 
                    id="drop-zone"
                    class="border-2 border-dashed border-navy/30 bg-white p-12 text-center cursor-pointer hover:border-navy/60 hover:bg-navy/[0.02] transition-colors"
                    role="button"
                    tabindex="0"
                    aria-label="Klicka eller dra filer hit för att ladda upp"
                >
                    <div class="mb-4">
                        <svg class="w-12 h-12 mx-auto text-navy/30" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <p class="text-navy font-semibold mb-1">Dra filer hit eller klicka för att välja</p>
                    <p class="text-sm text-navy/60">.txt, .pdf, .docx (max 50 filer)</p>
                    
                    <input 
                        type="file" 
                        id="file-input" 
                        name="files" 
                        multiple 
                        accept=".txt,.pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain"
                        class="hidden"
                    >
                </div>

                <!-- File list (populated by JS) -->
                <div id="file-list" class="mt-6 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-xs font-semibold uppercase tracking-label text-navy/60">Valda filer</h2>
                        <button type="button" id="clear-files" class="text-xs text-burgundy hover:underline">
                            Rensa alla
                        </button>
                    </div>
                    <div id="file-items" class="border border-navy divide-y divide-navy">
                        <!-- File rows inserted here -->
                    </div>
                    
                    <!-- Summary -->
                    <div id="file-summary" class="mt-3 flex justify-between text-sm text-navy/60">
                        <span id="file-count">0 filer</span>
                        <span id="file-size">0 MB</span>
                    </div>

                    <!-- Validation errors -->
                    <div id="validation-errors" class="mt-4 hidden">
                        <div class="bg-burgundy/10 border border-burgundy/30 p-4 text-sm text-burgundy">
                            <strong>Valideringsfel:</strong>
                            <ul id="error-list" class="mt-2 list-disc list-inside"></ul>
                        </div>
                    </div>
                </div>

                <!-- Submit button -->
                <div class="mt-8 flex flex-col md:flex-row gap-4">
                    <button 
                        type="submit" 
                        id="submit-btn"
                        disabled
                        class="flex-grow bg-burgundy text-canvas py-4 text-sm font-semibold uppercase tracking-label hover:bg-navy transition-colors disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-burgundy"
                    >
                        Ladda upp filer
                    </button>
                </div>
            </form>

            <!-- Upload progress (hidden by default) -->
            <div id="upload-progress" class="mt-8 hidden">
                <div class="border border-navy bg-white p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="status-dot bg-amber-500 analysis-badge"></div>
                        <span class="text-sm font-semibold">Laddar upp...</span>
                    </div>
                    <div class="h-2 bg-navy/10 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-navy transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Success state: REGULAR mode -->
            <div id="upload-success-regular" class="mt-8 hidden">
                <div class="border border-navy bg-white p-6 shadow-brutal">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="status-dot bg-amber-500"></div>
                        <span class="text-sm font-semibold">Filer uppladdade</span>
                    </div>
                    <p class="text-sm text-navy/70 mb-6">
                        Texterna analyseras nu för att hitta elevnamn. När det är klart får du bekräfta matchningarna mot klassens elevlista.
                    </p>
                    <a href="/dashboard" class="inline-block bg-navy text-canvas px-6 py-3 text-sm font-semibold uppercase tracking-label hover:bg-burgundy transition-colors">
                        Gå till översikten
                    </a>
                </div>
            </div>

            <!-- Success state: GUEST mode -->
            <div id="upload-success-guest" class="mt-8 hidden">
                <div class="border border-emerald-600 bg-emerald-50 p-6">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="status-dot bg-emerald-600"></div>
                        <span class="text-sm font-semibold text-emerald-800">Analys startad</span>
                    </div>
                    <p class="text-sm text-emerald-700 mb-6">
                        Texterna analyseras nu. Resultaten visas i översikten när de är klara.
                    </p>
                    <a href="/dashboard" class="inline-block bg-emerald-700 text-white px-6 py-3 text-sm font-semibold uppercase tracking-label hover:bg-emerald-800 transition-colors">
                        Gå till översikten
                    </a>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-navy py-4 text-center shrink-0" role="contentinfo">
        <p class="text-xs text-navy/40">
            © 2025 HuleEdu
        </p>
    </footer>

</div>

<script>
// ═══════════════════════════════════════════════════════════════
// UPLOAD PAGE LOGIC
// ═══════════════════════════════════════════════════════════════

const CONSTRAINTS = {
    maxFiles: 50,
    maxFileSize: 50 * 1024 * 1024,      // 50 MB
    maxTotalSize: 100 * 1024 * 1024,    // 100 MB
    allowedTypes: ['.txt', '.pdf', '.docx'],
    allowedMimes: [
        'text/plain',
        'application/pdf',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    ]
};

// State
let selectedFiles = [];
let currentMode = 'regular'; // 'regular' or 'guest'

// DOM Elements
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileList = document.getElementById('file-list');
const fileItems = document.getElementById('file-items');
const fileCount = document.getElementById('file-count');
const fileSize = document.getElementById('file-size');
const validationErrors = document.getElementById('validation-errors');
const errorList = document.getElementById('error-list');
const submitBtn = document.getElementById('submit-btn');
const clearBtn = document.getElementById('clear-files');
const uploadForm = document.getElementById('upload-form');
const uploadProgress = document.getElementById('upload-progress');
const uploadSuccessRegular = document.getElementById('upload-success-regular');
const uploadSuccessGuest = document.getElementById('upload-success-guest');
const progressBar = document.getElementById('progress-bar');
const classSelector = document.getElementById('class-selector');
const classSelect = document.getElementById('class-select');
const modeRadios = document.querySelectorAll('input[name="batch_mode"]');

// ─────────────────────────────────────────────────────────────────
// Event Listeners
// ─────────────────────────────────────────────────────────────────

// Mode toggle (REGULAR vs GUEST)
modeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
        currentMode = e.target.value;
        updateModeUI();
        updateSubmitState();
    });
});

function updateModeUI() {
    // Show/hide class selector
    if (currentMode === 'guest') {
        classSelector.classList.add('hidden');
        classSelect.removeAttribute('required');
    } else {
        classSelector.classList.remove('hidden');
        classSelect.setAttribute('required', '');
    }
    
    // Update radio button visual states
    document.querySelectorAll('.batch-mode-option').forEach(label => {
        const radio = label.querySelector('input[type="radio"]');
        const indicator = label.querySelector('.check-indicator');
        if (radio.checked) {
            indicator.classList.remove('opacity-0');
        } else {
            indicator.classList.add('opacity-0');
        }
    });
}

// Initialize mode UI
updateModeUI();

// Class select change
classSelect.addEventListener('change', updateSubmitState);

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
    }
});

// Drag & Drop
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-navy', 'bg-navy/[0.02]');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-navy', 'bg-navy/[0.02]');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-navy', 'bg-navy/[0.02]');
    handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', () => {
    handleFiles(fileInput.files);
});

clearBtn.addEventListener('click', () => {
    selectedFiles = [];
    renderFileList();
});

uploadForm.addEventListener('submit', handleSubmit);

// ─────────────────────────────────────────────────────────────────
// File Handling
// ─────────────────────────────────────────────────────────────────

function handleFiles(files) {
    const newFiles = Array.from(files);
    selectedFiles = [...selectedFiles, ...newFiles];
    renderFileList();
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
}

function renderFileList() {
    if (selectedFiles.length === 0) {
        fileList.classList.add('hidden');
        submitBtn.disabled = true;
        return;
    }

    fileList.classList.remove('hidden');
    
    // Render file items
    fileItems.innerHTML = selectedFiles.map((file, index) => {
        const isValid = validateFile(file);
        const sizeStr = formatFileSize(file.size);
        const ext = getFileExtension(file.name);
        
        return `
            <div class="flex items-center justify-between p-3 ${isValid.valid ? '' : 'bg-burgundy/5'}">
                <div class="flex items-center gap-3 min-w-0">
                    <span class="text-xs font-mono uppercase text-navy/40">${ext}</span>
                    <span class="truncate text-sm ${isValid.valid ? 'text-navy' : 'text-burgundy'}">${file.name}</span>
                    ${!isValid.valid ? `<span class="text-xs text-burgundy">(${isValid.error})</span>` : ''}
                </div>
                <div class="flex items-center gap-4 shrink-0">
                    <span class="text-xs text-navy/60">${sizeStr}</span>
                    <button type="button" onclick="removeFile(${index})" class="text-navy/40 hover:text-burgundy" aria-label="Ta bort ${file.name}">
                        ✕
                    </button>
                </div>
            </div>
        `;
    }).join('');

    // Update summary
    const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
    fileCount.textContent = `${selectedFiles.length} fil${selectedFiles.length !== 1 ? 'er' : ''}`;
    fileSize.textContent = formatFileSize(totalSize);

    // Validate all
    const errors = validateAll();
    if (errors.length > 0) {
        validationErrors.classList.remove('hidden');
        errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
    } else {
        validationErrors.classList.add('hidden');
    }
    
    updateSubmitState();
}

function updateSubmitState() {
    const errors = validateAll();
    const hasFiles = selectedFiles.length > 0;
    const hasValidFiles = errors.length === 0;
    const hasClass = currentMode === 'guest' || classSelect.value !== '';
    
    submitBtn.disabled = !(hasFiles && hasValidFiles && hasClass);
}

// ─────────────────────────────────────────────────────────────────
// Validation
// ─────────────────────────────────────────────────────────────────

function validateFile(file) {
    const ext = getFileExtension(file.name).toLowerCase();
    
    if (!CONSTRAINTS.allowedTypes.includes(ext)) {
        return { valid: false, error: 'Ogiltigt format' };
    }
    if (file.size > CONSTRAINTS.maxFileSize) {
        return { valid: false, error: 'För stor' };
    }
    return { valid: true };
}

function validateAll() {
    const errors = [];
    
    if (selectedFiles.length > CONSTRAINTS.maxFiles) {
        errors.push(`Max ${CONSTRAINTS.maxFiles} filer tillåtna (du har ${selectedFiles.length})`);
    }
    
    const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
    if (totalSize > CONSTRAINTS.maxTotalSize) {
        errors.push(`Total storlek överstiger ${formatFileSize(CONSTRAINTS.maxTotalSize)}`);
    }
    
    selectedFiles.forEach(file => {
        const result = validateFile(file);
        if (!result.valid) {
            errors.push(`${file.name}: ${result.error}`);
        }
    });
    
    return errors;
}

// ─────────────────────────────────────────────────────────────────
// Upload Handler
// ─────────────────────────────────────────────────────────────────

async function handleSubmit(e) {
    e.preventDefault();
    
    // Generate batch ID (in production, this might come from server)
    const batchId = crypto.randomUUID();
    document.getElementById('batch-id').value = batchId;
    
    // Build FormData
    const formData = new FormData();
    formData.append('batch_id', batchId);
    formData.append('mode', currentMode);
    
    // Include class_id for REGULAR mode
    if (currentMode === 'regular' && classSelect.value) {
        formData.append('class_id', classSelect.value);
    }
    
    selectedFiles.forEach(file => {
        formData.append('files', file);
    });
    
    // Hide all form sections, show progress
    document.querySelector('[data-step="1"]')?.classList.add('hidden');
    document.querySelector('[data-step="2"]')?.classList.add('hidden');
    classSelector.classList.add('hidden');
    fileList.classList.add('hidden');
    dropZone.classList.add('hidden');
    submitBtn.parentElement.classList.add('hidden');
    uploadProgress.classList.remove('hidden');
    
    try {
        const response = await fetch('/api/v1/files/batch', {
            method: 'POST',
            headers: {
                // Authorization would be added here
                // 'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        // Simulate progress for demo
        await simulateProgress();
        
        if (response.status === 429) {
            throw new Error('Du laddar upp för snabbt. Vänta en stund.');
        }
        
        if (response.status === 202 || response.ok) {
            // Success - 202 Accepted
            uploadProgress.classList.add('hidden');
            
            // Show mode-specific success
            if (currentMode === 'guest') {
                uploadSuccessGuest.classList.remove('hidden');
            } else {
                uploadSuccessRegular.classList.remove('hidden');
            }
        } else {
            throw new Error('Uppladdning misslyckades');
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        // Reset UI for retry
        uploadProgress.classList.add('hidden');
        fileList.classList.remove('hidden');
        dropZone.classList.remove('hidden');
        submitBtn.disabled = false;
        
        // Show error
        validationErrors.classList.remove('hidden');
        errorList.innerHTML = `<li>${error.message}</li>`;
    }
}

async function simulateProgress() {
    for (let i = 0; i <= 100; i += 10) {
        progressBar.style.width = `${i}%`;
        await new Promise(r => setTimeout(r, 100));
    }
}

// ─────────────────────────────────────────────────────────────────
// Utilities
// ─────────────────────────────────────────────────────────────────

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function getFileExtension(filename) {
    return '.' + filename.split('.').pop();
}

// Make removeFile available globally for onclick handlers
window.removeFile = removeFile;
</script>

</body>
</html>
