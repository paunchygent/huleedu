============================= test session starts ==============================
platform darwin -- Python 3.11.11, pytest-8.4.1, pluggy-1.6.0 -- /Users/olofs_mba/Documents/Repos/huledu-reboot/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/olofs_mba/Documents/Repos/huledu-reboot
configfile: pyproject.toml
testpaths: tests, libs/common_core/tests, services/content_service/tests, services/spellchecker_service/tests, services/batch_orchestrator_service/tests, services/essay_lifecycle_service/tests, services/file_service/tests, services/cj_assessment_service/tests, services/class_management_service/tests, services/result_aggregator_service/tests, services/llm_provider_service/tests, services/websocket_service/tests
plugins: respx-0.22.0, anyio-4.9.0, asyncio-1.1.0, xdist-3.8.0, timeout-2.4.0, cov-6.2.1, mock-3.14.1
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... [2m2025-07-28T14:09:24.081629Z[0m [[32m[1minfo     [0m] [1mCreated default test user: test_user_123[0m [[0m[1m[34mtest.auth_manager[0m][0m [36mfilename[0m=[35mtest_auth_manager.py[0m [36mfunc_name[0m=[35m_create_default_test_user[0m [36mlineno[0m=[35m89[0m

----------------------------- live log collection ------------------------------
2025-07-28 16:09:24 [    INFO] huleedu_service_libs.logging_utils:test_auth_manager.py:89 [2m2025-07-28T14:09:24.081629Z[0m [[32m[1minfo     [0m] [1mCreated default test user: test_user_123[0m [[0m[1m[34mtest.auth_manager[0m][0m [36mfilename[0m=[35mtest_auth_manager.py[0m [36mfunc_name[0m=[35m_create_default_test_user[0m [36mlineno[0m=[35m89[0m
[2m2025-07-28T14:09:24.081889Z[0m [[32m[1minfo     [0m] [1mCreated default test user: test_user_123[0m [[0m[1m[34mtest.auth_manager[0m][0m [36mfilename[0m=[35mtest_auth_manager.py[0m [36mfunc_name[0m=[35m_create_default_test_user[0m [36mlineno[0m=[35m89[0m
2025-07-28 16:09:24 [    INFO] huleedu_service_libs.logging_utils:test_auth_manager.py:89 [2m2025-07-28T14:09:24.081889Z[0m [[32m[1minfo     [0m] [1mCreated default test user: test_user_123[0m [[0m[1m[34mtest.auth_manager[0m][0m [36mfilename[0m=[35mtest_auth_manager.py[0m [36mfunc_name[0m=[35m_create_default_test_user[0m [36mlineno[0m=[35m89[0m
collected 1396 items / 1353 deselected / 43 selected

tests/functional/test_e2e_idempotency.py::TestControlledIdempotencyScenarios::test_v2_cross_service_isolation âœ… v2 service isolation validated: {'total_keys': 2, 'active_keys': ['huleedu:idempotency:v2:batch_orchestrator_service:huleedu_batch_essays_ready_v1:2bb3c80f997d5087885acca2443903c42ca927db64cf944e427e42bad5fe3e75', 'huleedu:idempotency:v2:essay_lifecycle_service:huleedu_batch_essays_ready_v1:2bb3c80f997d5087885acca2443903c42ca927db64cf944e427e42bad5fe3e75'], 'set_calls': 2, 'delete_calls': 0, 'connected_services': 2}
PASSED
tests/functional/test_e2e_idempotency.py::TestControlledIdempotencyScenarios::test_redis_outage_fail_open_behavior [2m2025-07-28T14:09:25.357891Z[0m [[31m[1merror    [0m] [1mREDIS_ERROR: Processing without idempotency protection[0m [[0m[1m[34midempotency-v2[0m][0m [36mextra[0m=[35m{'service': 'test_service', 'action': 'processing_without_idempotency', 'error': 'Redis connection failed - simulated outage', 'error_type': 'Exception', 'kafka_topic': 'huleedu.test.idempotency.v1', 'kafka_partition': 0, 'kafka_offset': 123}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m382[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 180, in wrapper
    existing_value = await redis_client.get(redis_key)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/tests/functional/test_e2e_idempotency.py", line 216, in get
    raise Exception("Redis connection failed - simulated outage")
Exception: Redis connection failed - simulated outage

-------------------------------- live log call ---------------------------------
2025-07-28 16:09:25 [   ERROR] huleedu_service_libs.logging_utils:idempotency_v2.py:382 [2m2025-07-28T14:09:25.357891Z[0m [[31m[1merror    [0m] [1mREDIS_ERROR: Processing without idempotency protection[0m [[0m[1m[34midempotency-v2[0m][0m [36mextra[0m=[35m{'service': 'test_service', 'action': 'processing_without_idempotency', 'error': 'Redis connection failed - simulated outage', 'error_type': 'Exception', 'kafka_topic': 'huleedu.test.idempotency.v1', 'kafka_partition': 0, 'kafka_offset': 123}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m382[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 180, in wrapper
    existing_value = await redis_client.get(redis_key)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/tests/functional/test_e2e_idempotency.py", line 216, in get
    raise Exception("Redis connection failed - simulated outage")
Exception: Redis connection failed - simulated outage
âœ… Fail-open behavior validated during Redis outage
PASSED
tests/functional/test_e2e_idempotency.py::TestControlledIdempotencyScenarios::test_processing_failure_key_cleanup [2m2025-07-28T14:09:25.362459Z[0m [[31m[1merror    [0m] [1mPROCESSING_FAILED: Releasing idempotency lock for retry[0m [[0m[1m[34midempotency-v2[0m][0m [36mextra[0m=[35m{'service': 'cleanup_test_service', 'event_type': 'huleedu.batch.essays.ready.v1', 'event_id': 'fad6e4a5-6857-45e1-81bd-25e6b760e04f', 'correlation_id': 'c2025b8d-22cc-426b-901f-1413bd6a0645', 'source_service': 'essay_lifecycle_service', 'deterministic_hash': 'ec7f3f7f6e1fef58...', 'redis_key': 'huleedu:idempotency:v2:cleanup_test_service:huleedu_batch_essays_ready_v1:ec7f3f7f6e1fef58f0e0a9e57cd10b26febb1526b316dbcfcf44a8e301f9861d', 'kafka_topic': 'huleedu.test.idempotency.v1', 'kafka_partition': 0, 'kafka_offset': 123, 'action': 'failed_releasing_lock', 'error': 'Simulated processing failure', 'error_type': 'Exception'}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m327[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 307, in wrapper
    result = await func(
             ^^^^^^^^^^^
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/tests/functional/test_e2e_idempotency.py", line 413, in failing_process_event
    raise Exception("Simulated processing failure")
Exception: Simulated processing failure

-------------------------------- live log call ---------------------------------
2025-07-28 16:09:25 [   ERROR] huleedu_service_libs.logging_utils:idempotency_v2.py:327 [2m2025-07-28T14:09:25.362459Z[0m [[31m[1merror    [0m] [1mPROCESSING_FAILED: Releasing idempotency lock for retry[0m [[0m[1m[34midempotency-v2[0m][0m [36mextra[0m=[35m{'service': 'cleanup_test_service', 'event_type': 'huleedu.batch.essays.ready.v1', 'event_id': 'fad6e4a5-6857-45e1-81bd-25e6b760e04f', 'correlation_id': 'c2025b8d-22cc-426b-901f-1413bd6a0645', 'source_service': 'essay_lifecycle_service', 'deterministic_hash': 'ec7f3f7f6e1fef58...', 'redis_key': 'huleedu:idempotency:v2:cleanup_test_service:huleedu_batch_essays_ready_v1:ec7f3f7f6e1fef58f0e0a9e57cd10b26febb1526b316dbcfcf44a8e301f9861d', 'kafka_topic': 'huleedu.test.idempotency.v1', 'kafka_partition': 0, 'kafka_offset': 123, 'action': 'failed_releasing_lock', 'error': 'Simulated processing failure', 'error_type': 'Exception'}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m327[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 307, in wrapper
    result = await func(
             ^^^^^^^^^^^
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/tests/functional/test_e2e_idempotency.py", line 413, in failing_process_event
    raise Exception("Simulated processing failure")
Exception: Simulated processing failure
[2m2025-07-28T14:09:25.363249Z[0m [[31m[1merror    [0m] [1mREDIS_ERROR: Processing without idempotency protection[0m [[0m[1m[34midempotency-v2[0m][0m [36mextra[0m=[35m{'service': 'cleanup_test_service', 'action': 'processing_without_idempotency', 'error': 'Simulated processing failure', 'error_type': 'Exception', 'kafka_topic': 'huleedu.test.idempotency.v1', 'kafka_partition': 0, 'kafka_offset': 123}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m382[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 357, in wrapper
    raise processing_error
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 307, in wrapper
    result = await func(
             ^^^^^^^^^^^
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/tests/functional/test_e2e_idempotency.py", line 413, in failing_process_event
    raise Exception("Simulated processing failure")
Exception: Simulated processing failure
2025-07-28 16:09:25 [   ERROR] huleedu_service_libs.logging_utils:idempotency_v2.py:382 [2m2025-07-28T14:09:25.363249Z[0m [[31m[1merror    [0m] [1mREDIS_ERROR: Processing without idempotency protection[0m [[0m[1m[34midempotency-v2[0m][0m [36mextra[0m=[35m{'service': 'cleanup_test_service', 'action': 'processing_without_idempotency', 'error': 'Simulated processing failure', 'error_type': 'Exception', 'kafka_topic': 'huleedu.test.idempotency.v1', 'kafka_partition': 0, 'kafka_offset': 123}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m382[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 357, in wrapper
    raise processing_error
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/libs/huleedu_service_libs/src/huleedu_service_libs/idempotency_v2.py", line 307, in wrapper
    result = await func(
             ^^^^^^^^^^^
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/tests/functional/test_e2e_idempotency.py", line 413, in failing_process_event
    raise Exception("Simulated processing failure")
Exception: Simulated processing failure
âœ… Processing failure key cleanup validated
PASSED
tests/functional/test_e2e_idempotency.py::TestControlledIdempotencyScenarios::test_deterministic_id_generation_consistency âœ… Deterministic ID consistency validated: e4b94c01860d63f5ba175a2f6d3c8dea569b4d9d101b62a9527df4de09def0ad
PASSED
tests/functional/test_e2e_idempotency.py::TestControlledIdempotencyScenarios::test_v2_service_isolation_and_ttl_configuration âœ… v2 service isolation validated: {'total_keys': 2, 'active_keys': ['huleedu:idempotency:v2:batch_orchestrator_service:huleedu_batch_essays_ready_v1:c948b6178fe03ff99ac89afa8eb823ea9f9f01290224c08f99903eb94ca13497', 'huleedu:idempotency:v2:essay_lifecycle_service:huleedu_batch_essays_ready_v1:c948b6178fe03ff99ac89afa8eb823ea9f9f01290224c08f99903eb94ca13497'], 'set_calls': 2, 'delete_calls': 0, 'connected_services': 0}
âœ… TTL configuration validated: [300, 300]
PASSED
tests/functional/test_e2e_idempotency.py::TestE2EPipelineIdempotency::test_pipeline_with_duplicate_injection [2m2025-07-28T14:09:25.368641Z[0m [[32m[1minfo     [0m] [1mCreated default test user: test_user_123[0m [[0m[1m[34mtest.auth_manager[0m][0m [36mfilename[0m=[35mtest_auth_manager.py[0m [36mfunc_name[0m=[35m_create_default_test_user[0m [36mlineno[0m=[35m89[0m

-------------------------------- live log call ---------------------------------
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:test_auth_manager.py:89 [2m2025-07-28T14:09:25.368641Z[0m [[32m[1minfo     [0m] [1mCreated default test user: test_user_123[0m [[0m[1m[34mtest.auth_manager[0m][0m [36mfilename[0m=[35mtest_auth_manager.py[0m [36mfunc_name[0m=[35m_create_default_test_user[0m [36mlineno[0m=[35m89[0m
HTTP Request: GET http://localhost:8001/healthz "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:8001/healthz "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.406012Z[0m [[32m[1minfo     [0m] [1mâœ… content_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:108 [2m2025-07-28T14:09:25.406012Z[0m [[32m[1minfo     [0m] [1mâœ… content_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
HTTP Request: GET http://localhost:8001/metrics "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:8001/metrics "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.430482Z[0m [[32m[1minfo     [0m] [1mðŸ“Š content_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:140 [2m2025-07-28T14:09:25.430482Z[0m [[32m[1minfo     [0m] [1mðŸ“Š content_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
HTTP Request: GET http://localhost:5001/healthz "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:5001/healthz "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.435359Z[0m [[32m[1minfo     [0m] [1mâœ… batch_orchestrator_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:108 [2m2025-07-28T14:09:25.435359Z[0m [[32m[1minfo     [0m] [1mâœ… batch_orchestrator_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
HTTP Request: GET http://localhost:5001/metrics "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:5001/metrics "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.437988Z[0m [[32m[1minfo     [0m] [1mðŸ“Š batch_orchestrator_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:140 [2m2025-07-28T14:09:25.437988Z[0m [[32m[1minfo     [0m] [1mðŸ“Š batch_orchestrator_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
HTTP Request: GET http://localhost:4002/healthz "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:4002/healthz "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.443105Z[0m [[32m[1minfo     [0m] [1mâœ… batch_conductor_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:108 [2m2025-07-28T14:09:25.443105Z[0m [[32m[1minfo     [0m] [1mâœ… batch_conductor_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
HTTP Request: GET http://localhost:4002/metrics "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:4002/metrics "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.446048Z[0m [[32m[1minfo     [0m] [1mðŸ“Š batch_conductor_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:140 [2m2025-07-28T14:09:25.446048Z[0m [[32m[1minfo     [0m] [1mðŸ“Š batch_conductor_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
HTTP Request: GET http://localhost:6001/healthz "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:6001/healthz "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.450913Z[0m [[32m[1minfo     [0m] [1mâœ… essay_lifecycle_api HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:108 [2m2025-07-28T14:09:25.450913Z[0m [[32m[1minfo     [0m] [1mâœ… essay_lifecycle_api HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
HTTP Request: GET http://localhost:6001/metrics "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:6001/metrics "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.453968Z[0m [[32m[1minfo     [0m] [1mðŸ“Š essay_lifecycle_api metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:140 [2m2025-07-28T14:09:25.453968Z[0m [[32m[1minfo     [0m] [1mðŸ“Š essay_lifecycle_api metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
HTTP Request: GET http://localhost:7001/healthz "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:7001/healthz "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.457539Z[0m [[32m[1minfo     [0m] [1mâœ… file_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:108 [2m2025-07-28T14:09:25.457539Z[0m [[32m[1minfo     [0m] [1mâœ… file_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
HTTP Request: GET http://localhost:7001/metrics "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:7001/metrics "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.460232Z[0m [[32m[1minfo     [0m] [1mðŸ“Š file_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:140 [2m2025-07-28T14:09:25.460232Z[0m [[32m[1minfo     [0m] [1mðŸ“Š file_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
HTTP Request: GET http://localhost:8002/healthz "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:8002/healthz "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.466395Z[0m [[32m[1minfo     [0m] [1mâœ… spellchecker_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:108 [2m2025-07-28T14:09:25.466395Z[0m [[32m[1minfo     [0m] [1mâœ… spellchecker_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
HTTP Request: GET http://localhost:8002/metrics "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:8002/metrics "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.468427Z[0m [[32m[1minfo     [0m] [1mðŸ“Š spellchecker_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:140 [2m2025-07-28T14:09:25.468427Z[0m [[32m[1minfo     [0m] [1mðŸ“Š spellchecker_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
HTTP Request: GET http://localhost:9095/healthz "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:9095/healthz "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.507630Z[0m [[32m[1minfo     [0m] [1mâœ… cj_assessment_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:108 [2m2025-07-28T14:09:25.507630Z[0m [[32m[1minfo     [0m] [1mâœ… cj_assessment_service HTTP API healthy[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m108[0m
HTTP Request: GET http://localhost:9095/metrics "HTTP/1.1 200 "
2025-07-28 16:09:25 [    INFO] httpx:_client.py:1740 HTTP Request: GET http://localhost:9095/metrics "HTTP/1.1 200 "
[2m2025-07-28T14:09:25.511770Z[0m [[32m[1minfo     [0m] [1mðŸ“Š cj_assessment_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
2025-07-28 16:09:25 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:140 [2m2025-07-28T14:09:25.511770Z[0m [[32m[1minfo     [0m] [1mðŸ“Š cj_assessment_service metrics endpoint valid[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35m_validate_all_services[0m [36mlineno[0m=[35m140[0m
Updating subscribed topics to: frozenset({'huleedu.file.essay.content.provisioned.v1', 'huleedu.batch.essays.registered.v1', 'huleedu.els.batch.essays.ready.v1'})
2025-07-28 16:09:25 [    INFO] aiokafka.consumer.subscription_state:subscription_state.py:110 Updating subscribed topics to: frozenset({'huleedu.file.essay.content.provisioned.v1', 'huleedu.batch.essays.registered.v1', 'huleedu.els.batch.essays.ready.v1'})
Discovered coordinator 1 for group test_pipeline_idempotency_e2e5f243
2025-07-28 16:09:25 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:594 Discovered coordinator 1 for group test_pipeline_idempotency_e2e5f243
Revoking previously assigned partitions set() for group test_pipeline_idempotency_e2e5f243
2025-07-28 16:09:25 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:415 Revoking previously assigned partitions set() for group test_pipeline_idempotency_e2e5f243
(Re-)joining group test_pipeline_idempotency_e2e5f243
2025-07-28 16:09:25 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:1281 (Re-)joining group test_pipeline_idempotency_e2e5f243
Joined group 'test_pipeline_idempotency_e2e5f243' (generation 1) with member_id aiokafka-0.12.0-cba915d2-5128-429a-aaf4-d9cf73fbce09
2025-07-28 16:09:28 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:1360 Joined group 'test_pipeline_idempotency_e2e5f243' (generation 1) with member_id aiokafka-0.12.0-cba915d2-5128-429a-aaf4-d9cf73fbce09
Elected group leader -- performing partition assignments using roundrobin
2025-07-28 16:09:28 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:1368 Elected group leader -- performing partition assignments using roundrobin
Successfully synced group test_pipeline_idempotency_e2e5f243 with generation 1
2025-07-28 16:09:28 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:1519 Successfully synced group test_pipeline_idempotency_e2e5f243 with generation 1
Setting newly assigned partitions {TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=0), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=1), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=2), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=0), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=0)} for group test_pipeline_idempotency_e2e5f243
2025-07-28 16:09:28 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:506 Setting newly assigned partitions {TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=0), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=1), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=2), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=0), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=0)} for group test_pipeline_idempotency_e2e5f243
[2m2025-07-28T14:09:28.549982Z[0m [[32m[1minfo     [0m] [1mConsumer started for test: pipeline_idempotency[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35mconsumer[0m [36mlineno[0m=[35m105[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:kafka_test_manager.py:105 [2m2025-07-28T14:09:28.549982Z[0m [[32m[1minfo     [0m] [1mConsumer started for test: pipeline_idempotency[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35mconsumer[0m [36mlineno[0m=[35m105[0m
[2m2025-07-28T14:09:28.550397Z[0m [[32m[1minfo     [0m] [1mConsumer assigned partitions: frozenset({TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=0), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=1), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=2), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=0), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=0)})[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35m_wait_for_partition_assignment[0m [36mlineno[0m=[35m143[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:kafka_test_manager.py:143 [2m2025-07-28T14:09:28.550397Z[0m [[32m[1minfo     [0m] [1mConsumer assigned partitions: frozenset({TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=2), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=0), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=1), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=1), TopicPartition(topic='huleedu.file.essay.content.provisioned.v1', partition=2), TopicPartition(topic='huleedu.els.batch.essays.ready.v1', partition=0), TopicPartition(topic='huleedu.batch.essays.registered.v1', partition=0)})[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35m_wait_for_partition_assignment[0m [36mlineno[0m=[35m143[0m
[2m2025-07-28T14:09:28.554217Z[0m [[32m[1minfo     [0m] [1mConsumer positioned at end of all topics[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35mconsumer[0m [36mlineno[0m=[35m112[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:kafka_test_manager.py:112 [2m2025-07-28T14:09:28.554217Z[0m [[32m[1minfo     [0m] [1mConsumer positioned at end of all topics[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35mconsumer[0m [36mlineno[0m=[35m112[0m
[2m2025-07-28T14:09:28.574544Z[0m [[32m[1minfo     [0m] [1mCreated batch c281458a-9bb1-4208-a224-d16b10efaf4b with correlation 88924629-fc5a-439f-8ea5-35c011cffe7a[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35mcreate_batch[0m [36mlineno[0m=[35m233[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:service_test_manager.py:233 [2m2025-07-28T14:09:28.574544Z[0m [[32m[1minfo     [0m] [1mCreated batch c281458a-9bb1-4208-a224-d16b10efaf4b with correlation 88924629-fc5a-439f-8ea5-35c011cffe7a[0m [[0m[1m[34mtest.service_manager[0m][0m [36mfilename[0m=[35mservice_test_manager.py[0m [36mfunc_name[0m=[35mcreate_batch[0m [36mlineno[0m=[35m233[0m
Pipeline test info: 'name'
LeaveGroup request succeeded
2025-07-28 16:09:28 [    INFO] aiokafka.consumer.group_coordinator:group_coordinator.py:390 LeaveGroup request succeeded
[2m2025-07-28T14:09:28.579241Z[0m [[32m[1minfo     [0m] [1mConsumer stopped for test: pipeline_idempotency[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35mconsumer[0m [36mlineno[0m=[35m121[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:kafka_test_manager.py:121 [2m2025-07-28T14:09:28.579241Z[0m [[32m[1minfo     [0m] [1mConsumer stopped for test: pipeline_idempotency[0m [[0m[1m[34mtest.kafka_manager[0m][0m [36mfilename[0m=[35mkafka_test_manager.py[0m [36mfunc_name[0m=[35mconsumer[0m [36mlineno[0m=[35m121[0m
âœ… E2E pipeline idempotency infrastructure validated
PASSED
tests/integration/test_pipeline_state_management_edge_cases.py::TestPipelineEdgeCases::test_idempotency_handling_for_already_initiated_phase [2m2025-07-28T14:09:28.586903Z[0m [[32m[1minfo     [0m] [1mHandling phase conclusion: batch=7e365b60-f89e-46a1-8c07-121140121ec4, phase=spellcheck, status=completed_successfully[0m [[0m[1m[34mbos.pipeline.coordinator[0m][0m [36mextra[0m=[35m{'correlation_id': 'cc095956-a692-49aa-8707-9c2489d9ab7f'}[0m [36mfilename[0m=[35mpipeline_phase_coordinator_impl.py[0m [36mfunc_name[0m=[35mhandle_phase_concluded[0m [36mlineno[0m=[35m73[0m

-------------------------------- live log call ---------------------------------
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:pipeline_phase_coordinator_impl.py:73 [2m2025-07-28T14:09:28.586903Z[0m [[32m[1minfo     [0m] [1mHandling phase conclusion: batch=7e365b60-f89e-46a1-8c07-121140121ec4, phase=spellcheck, status=completed_successfully[0m [[0m[1m[34mbos.pipeline.coordinator[0m][0m [36mextra[0m=[35m{'correlation_id': 'cc095956-a692-49aa-8707-9c2489d9ab7f'}[0m [36mfilename[0m=[35mpipeline_phase_coordinator_impl.py[0m [36mfunc_name[0m=[35mhandle_phase_concluded[0m [36mlineno[0m=[35m73[0m
[2m2025-07-28T14:09:28.589231Z[0m [[32m[1minfo     [0m] [1mPublished phase completion notification to Redis for user user_123[0m [[0m[1m[34mbos.notification.service[0m][0m [36mextra[0m=[35m{'batch_id': '7e365b60-f89e-46a1-8c07-121140121ec4', 'phase': 'spellcheck', 'user_id': 'user_123', 'correlation_id': 'cc095956-a692-49aa-8707-9c2489d9ab7f'}[0m [36mfilename[0m=[35mnotification_service.py[0m [36mfunc_name[0m=[35mpublish_phase_completion[0m [36mlineno[0m=[35m63[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:notification_service.py:63 [2m2025-07-28T14:09:28.589231Z[0m [[32m[1minfo     [0m] [1mPublished phase completion notification to Redis for user user_123[0m [[0m[1m[34mbos.notification.service[0m][0m [36mextra[0m=[35m{'batch_id': '7e365b60-f89e-46a1-8c07-121140121ec4', 'phase': 'spellcheck', 'user_id': 'user_123', 'correlation_id': 'cc095956-a692-49aa-8707-9c2489d9ab7f'}[0m [36mfilename[0m=[35mnotification_service.py[0m [36mfunc_name[0m=[35mpublish_phase_completion[0m [36mlineno[0m=[35m63[0m
[2m2025-07-28T14:09:28.589457Z[0m [[32m[1minfo     [0m] [1mInitiating next phase 'cj_assessment' for batch 7e365b60-f89e-46a1-8c07-121140121ec4 after 'spellcheck'[0m [[0m[1m[34mbos.pipeline.coordinator[0m][0m [36mextra[0m=[35m{'correlation_id': 'cc095956-a692-49aa-8707-9c2489d9ab7f'}[0m [36mfilename[0m=[35mpipeline_phase_coordinator_impl.py[0m [36mfunc_name[0m=[35m_initiate_next_phase[0m [36mlineno[0m=[35m214[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:pipeline_phase_coordinator_impl.py:214 [2m2025-07-28T14:09:28.589457Z[0m [[32m[1minfo     [0m] [1mInitiating next phase 'cj_assessment' for batch 7e365b60-f89e-46a1-8c07-121140121ec4 after 'spellcheck'[0m [[0m[1m[34mbos.pipeline.coordinator[0m][0m [36mextra[0m=[35m{'correlation_id': 'cc095956-a692-49aa-8707-9c2489d9ab7f'}[0m [36mfilename[0m=[35mpipeline_phase_coordinator_impl.py[0m [36mfunc_name[0m=[35m_initiate_next_phase[0m [36mlineno[0m=[35m214[0m
[2m2025-07-28T14:09:28.589568Z[0m [[32m[1minfo     [0m] [1mPhase cj_assessment already initiated for batch 7e365b60-f89e-46a1-8c07-121140121ec4, skipping[0m [[0m[1m[34mbos.pipeline.coordinator[0m][0m [36mextra[0m=[35m{'current_status': 'dispatch_initiated'}[0m [36mfilename[0m=[35mpipeline_phase_coordinator_impl.py[0m [36mfunc_name[0m=[35m_initiate_next_phase[0m [36mlineno[0m=[35m244[0m
2025-07-28 16:09:28 [    INFO] huleedu_service_libs.logging_utils:pipeline_phase_coordinator_impl.py:244 [2m2025-07-28T14:09:28.589568Z[0m [[32m[1minfo     [0m] [1mPhase cj_assessment already initiated for batch 7e365b60-f89e-46a1-8c07-121140121ec4, skipping[0m [[0m[1m[34mbos.pipeline.coordinator[0m][0m [36mextra[0m=[35m{'current_status': 'dispatch_initiated'}[0m [36mfilename[0m=[35mpipeline_phase_coordinator_impl.py[0m [36mfunc_name[0m=[35m_initiate_next_phase[0m [36mlineno[0m=[35m244[0m
PASSED
services/spellchecker_service/tests/test_redis_integration.py::test_redis_idempotency_pattern_with_testcontainer Pulling image testcontainers/ryuk:0.8.1

-------------------------------- live log setup --------------------------------
2025-07-28 16:09:28 [    INFO] testcontainers.core.container:container.py:172 Pulling image testcontainers/ryuk:0.8.1
Container started: 975f617fe557
2025-07-28 16:09:29 [    INFO] testcontainers.core.container:container.py:198 Container started: 975f617fe557
Waiting for container <Container: 975f617fe557> with image testcontainers/ryuk:0.8.1 to be ready ...
2025-07-28 16:09:29 [    INFO] testcontainers.core.waiting_utils:waiting_utils.py:52 Waiting for container <Container: 975f617fe557> with image testcontainers/ryuk:0.8.1 to be ready ...
Pulling image redis:7-alpine
2025-07-28 16:09:29 [    INFO] testcontainers.core.container:container.py:172 Pulling image redis:7-alpine
Container started: 631132a54180
2025-07-28 16:09:29 [    INFO] testcontainers.core.container:container.py:198 Container started: 631132a54180
Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
2025-07-28 16:09:29 [    INFO] testcontainers.core.waiting_utils:waiting_utils.py:52 Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
2025-07-28 16:09:29 [    INFO] testcontainers.core.waiting_utils:waiting_utils.py:52 Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
2025-07-28 16:09:30 [    INFO] testcontainers.core.waiting_utils:waiting_utils.py:52 Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
-------------------------------- live log call ---------------------------------
2025-07-28 16:09:30 [    INFO] testcontainers.core.waiting_utils:waiting_utils.py:52 Waiting for container <Container: 631132a54180> with image redis:7-alpine to be ready ...
2025-07-28 16:09:30 [info     ] Redis client 'idempotency-test' connected to redis://localhost:52633 [redis-client]
2025-07-28 16:09:30 [debug    ] Redis SETNX by 'idempotency-test': key='spell_check_event:test_correlation_id' ttl=60s result=SET [redis-client]
2025-07-28 16:09:30 [debug    ] Redis SETNX by 'idempotency-test': key='spell_check_event:test_correlation_id' ttl=60s result=EXISTS [redis-client]
2025-07-28 16:09:30 [debug    ] Redis DELETE by 'idempotency-test': key='spell_check_event:test_correlation_id' deleted=1 [redis-client]
2025-07-28 16:09:30 [info     ] Redis client 'idempotency-test' disconnected [redis-client]
PASSED
services/spellchecker_service/tests/unit/test_kafka_consumer_integration.py::test_kafka_consumer_with_idempotency_first_time_processing [2m2025-07-28T14:09:30.649367Z[0m [[32m[1minfo     [0m] [1mSuccessfully created all metrics[0m [[0m[1m[34mspellchecker_service.metrics[0m][0m [36mfilename[0m=[35mmetrics.py[0m [36mfunc_name[0m=[35m_create_metrics[0m [36mlineno[0m=[35m88[0m

-------------------------------- live log call ---------------------------------
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:metrics.py:88 [2m2025-07-28T14:09:30.649367Z[0m [[32m[1minfo     [0m] [1mSuccessfully created all metrics[0m [[0m[1m[34mspellchecker_service.metrics[0m][0m [36mfilename[0m=[35mmetrics.py[0m [36mfunc_name[0m=[35m_create_metrics[0m [36mlineno[0m=[35m88[0m
[2m2025-07-28T14:09:30.649884Z[0m [[32m[1minfo     [0m] [1mShared metrics initialized    [0m [[0m[1m[34mspellchecker_service.metrics[0m][0m [36mfilename[0m=[35mmetrics.py[0m [36mfunc_name[0m=[35mget_metrics[0m [36mlineno[0m=[35m37[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:metrics.py:37 [2m2025-07-28T14:09:30.649884Z[0m [[32m[1minfo     [0m] [1mShared metrics initialized    [0m [[0m[1m[34mspellchecker_service.metrics[0m][0m [36mfilename[0m=[35mmetrics.py[0m [36mfunc_name[0m=[35mget_metrics[0m [36mlineno[0m=[35m37[0m
[2m2025-07-28T14:09:30.650038Z[0m [[32m[1minfo     [0m] [1mAvailable metrics: ['http_requests_total', 'http_request_duration_seconds', 'spell_check_operations_total', 'spellcheck_corrections_made', 'kafka_queue_latency_seconds'][0m [[0m[1m[34mspellchecker_service.metrics[0m][0m [36mfilename[0m=[35mmetrics.py[0m [36mfunc_name[0m=[35mget_metrics[0m [36mlineno[0m=[35m38[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:metrics.py:38 [2m2025-07-28T14:09:30.650038Z[0m [[32m[1minfo     [0m] [1mAvailable metrics: ['http_requests_total', 'http_request_duration_seconds', 'spell_check_operations_total', 'spellcheck_corrections_made', 'kafka_queue_latency_seconds'][0m [[0m[1m[34mspellchecker_service.metrics[0m][0m [36mfilename[0m=[35mmetrics.py[0m [36mfunc_name[0m=[35mget_metrics[0m [36mlineno[0m=[35m38[0m
[2m2025-07-28T14:09:30.650522Z[0m [[32m[1minfo     [0m] [1mReceived spellcheck request   [0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mcurrent_processing_event[0m=[35messay.spellcheck.requested[0m [36mcurrent_processing_stage[0m=[35mpending[0m [36mevent_data_type[0m=[35mEssayLifecycleSpellcheckRequestV1[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mfilename[0m=[35mlogging_utils.py[0m [36mfunc_name[0m=[35mlog_event_processing[0m [36mlineno[0m=[35m147[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:logging_utils.py:147 [2m2025-07-28T14:09:30.650522Z[0m [[32m[1minfo     [0m] [1mReceived spellcheck request   [0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mcurrent_processing_event[0m=[35messay.spellcheck.requested[0m [36mcurrent_processing_stage[0m=[35mpending[0m [36mevent_data_type[0m=[35mEssayLifecycleSpellcheckRequestV1[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mfilename[0m=[35mlogging_utils.py[0m [36mfunc_name[0m=[35mlog_event_processing[0m [36mlineno[0m=[35m147[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.650901Z[0m [[32m[1minfo     [0m] [1mStep 1: Fetching content for essay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m290[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:event_processor.py:290 [2m2025-07-28T14:09:30.650901Z[0m [[32m[1minfo     [0m] [1mStep 1: Fetching content for essay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m290[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.651177Z[0m [[32m[1minfo     [0m] [1mStep 2: Content fetched successfully for essay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m303[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:event_processor.py:303 [2m2025-07-28T14:09:30.651177Z[0m [[32m[1minfo     [0m] [1mStep 2: Content fetched successfully for essay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m303[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.651320Z[0m [[32m[1minfo     [0m] [1mStep 3: Performing spell check for essay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m351[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:event_processor.py:351 [2m2025-07-28T14:09:30.651320Z[0m [[32m[1minfo     [0m] [1mStep 3: Performing spell check for essay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m351[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.653680Z[0m [[31m[1merror    [0m] [1mEssay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e: Unhandled error processing message: '<=' not supported between instances of 'MagicMock' and 'float'[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m482[0m [36msource_service[0m=[35messay_lifecycle_service[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/services/spellchecker_service/event_processor.py", line 390, in _process_single_message_impl
    corrections_metric.observe(result_data.corrections_made)
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/.venv/lib/python3.11/site-packages/prometheus_client/metrics.py", line 629, in observe
    if amount <= bound:
       ^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'MagicMock' and 'float'
2025-07-28 16:09:30 [   ERROR] huleedu_service_libs.logging_utils:event_processor.py:482 [2m2025-07-28T14:09:30.653680Z[0m [[31m[1merror    [0m] [1mEssay 42335bc9-2bfe-4807-a62a-f1c3b0a5691e: Unhandled error processing message: '<=' not supported between instances of 'MagicMock' and 'float'[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mef83d794-4c96-4838-8ce2-b9c09f196905[0m [36mevent_id[0m=[35m5869d089-c731-4dfe-9ddf-97a5284340aa[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'ef83d794-4c96-4838-8ce2-b9c09f196905'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m482[0m [36msource_service[0m=[35messay_lifecycle_service[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/services/spellchecker_service/event_processor.py", line 390, in _process_single_message_impl
    corrections_metric.observe(result_data.corrections_made)
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/.venv/lib/python3.11/site-packages/prometheus_client/metrics.py", line 629, in observe
    if amount <= bound:
       ^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'MagicMock' and 'float'
PASSED
services/spellchecker_service/tests/unit/test_kafka_consumer_integration.py::test_kafka_consumer_with_idempotency_duplicate_detection [2m2025-07-28T14:09:30.670888Z[0m [[32m[1minfo     [0m] [1mReceived spellcheck request   [0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mcurrent_processing_event[0m=[35messay.spellcheck.requested[0m [36mcurrent_processing_stage[0m=[35mpending[0m [36mevent_data_type[0m=[35mEssayLifecycleSpellcheckRequestV1[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mfilename[0m=[35mlogging_utils.py[0m [36mfunc_name[0m=[35mlog_event_processing[0m [36mlineno[0m=[35m147[0m [36msource_service[0m=[35messay_lifecycle_service[0m

-------------------------------- live log call ---------------------------------
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:logging_utils.py:147 [2m2025-07-28T14:09:30.670888Z[0m [[32m[1minfo     [0m] [1mReceived spellcheck request   [0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mcurrent_processing_event[0m=[35messay.spellcheck.requested[0m [36mcurrent_processing_stage[0m=[35mpending[0m [36mevent_data_type[0m=[35mEssayLifecycleSpellcheckRequestV1[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mfilename[0m=[35mlogging_utils.py[0m [36mfunc_name[0m=[35mlog_event_processing[0m [36mlineno[0m=[35m147[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.671406Z[0m [[32m[1minfo     [0m] [1mStep 1: Fetching content for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m290[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:event_processor.py:290 [2m2025-07-28T14:09:30.671406Z[0m [[32m[1minfo     [0m] [1mStep 1: Fetching content for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m290[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.671681Z[0m [[32m[1minfo     [0m] [1mStep 2: Content fetched successfully for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m303[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:event_processor.py:303 [2m2025-07-28T14:09:30.671681Z[0m [[32m[1minfo     [0m] [1mStep 2: Content fetched successfully for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m303[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.671818Z[0m [[32m[1minfo     [0m] [1mStep 3: Performing spell check for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m351[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [    INFO] huleedu_service_libs.logging_utils:event_processor.py:351 [2m2025-07-28T14:09:30.671818Z[0m [[32m[1minfo     [0m] [1mStep 3: Performing spell check for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m351[0m [36msource_service[0m=[35messay_lifecycle_service[0m
[2m2025-07-28T14:09:30.673488Z[0m [[31m[1merror    [0m] [1mEssay e45ff674-e2d1-49cd-8729-a987a01eeb77: Unhandled error processing message: '<=' not supported between instances of 'MagicMock' and 'float'[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m482[0m [36msource_service[0m=[35messay_lifecycle_service[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/services/spellchecker_service/event_processor.py", line 390, in _process_single_message_impl
    corrections_metric.observe(result_data.corrections_made)
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/.venv/lib/python3.11/site-packages/prometheus_client/metrics.py", line 629, in observe
    if amount <= bound:
       ^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'MagicMock' and 'float'
2025-07-28 16:09:30 [   ERROR] huleedu_service_libs.logging_utils:event_processor.py:482 [2m2025-07-28T14:09:30.673488Z[0m [[31m[1merror    [0m] [1mEssay e45ff674-e2d1-49cd-8729-a987a01eeb77: Unhandled error processing message: '<=' not supported between instances of 'MagicMock' and 'float'[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m482[0m [36msource_service[0m=[35messay_lifecycle_service[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/services/spellchecker_service/event_processor.py", line 390, in _process_single_message_impl
    corrections_metric.observe(result_data.corrections_made)
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/.venv/lib/python3.11/site-packages/prometheus_client/metrics.py", line 629, in observe
    if amount <= bound:
       ^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'MagicMock' and 'float'
[2m2025-07-28T14:09:30.674519Z[0m [[33m[1mwarning  [0m] [1mDUPLICATE_EVENT_DETECTED: Event already completed[0m [[0m[1m[34midempotency-v2[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'service': 'spell-checker-service', 'event_type': 'huleedu.essay.spellcheck.requested.v1', 'event_id': '4ee5c8d5-ce02-4ea6-bffc-f546cca85463', 'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711', 'source_service': 'essay_lifecycle_service', 'deterministic_hash': 'c2f91038e30cd3ca...', 'redis_key': 'huleedu:idempotency:v2:spell-checker-service:huleedu_essay_spellcheck_requested_v1:c2f91038e30cd3ca35c5edeecd8f28d5b98dcd0083c8fe7fca2a3087128a450a', 'kafka_topic': 'huleedu.essay.spellcheck.requested.v1', 'kafka_partition': 0, 'kafka_offset': 12345, 'action': 'skipped_duplicate', 'status': 'completed'}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m189[0m [36msource_service[0m=[35messay_lifecycle_service[0m
2025-07-28 16:09:30 [ WARNING] huleedu_service_libs.logging_utils:idempotency_v2.py:189 [2m2025-07-28T14:09:30.674519Z[0m [[33m[1mwarning  [0m] [1mDUPLICATE_EVENT_DETECTED: Event already completed[0m [[0m[1m[34midempotency-v2[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'service': 'spell-checker-service', 'event_type': 'huleedu.essay.spellcheck.requested.v1', 'event_id': '4ee5c8d5-ce02-4ea6-bffc-f546cca85463', 'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711', 'source_service': 'essay_lifecycle_service', 'deterministic_hash': 'c2f91038e30cd3ca...', 'redis_key': 'huleedu:idempotency:v2:spell-checker-service:huleedu_essay_spellcheck_requested_v1:c2f91038e30cd3ca35c5edeecd8f28d5b98dcd0083c8fe7fca2a3087128a450a', 'kafka_topic': 'huleedu.essay.spellcheck.requested.v1', 'kafka_partition': 0, 'kafka_offset': 12345, 'action': 'skipped_duplicate', 'status': 'completed'}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m189[0m [36msource_service[0m=[35messay_lifecycle_service[0m
FAILED

=================================== FAILURES ===================================
___________ test_kafka_consumer_with_idempotency_duplicate_detection ___________
services/spellchecker_service/tests/unit/test_kafka_consumer_integration.py:227: in test_kafka_consumer_with_idempotency_duplicate_detection
    assert len(redis_client.set_calls) == 2  # Two SETNX attempts
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   assert 1 == 2
E    +  where 1 = len([('huleedu:idempotency:v2:spell-checker-service:huleedu_essay_spellcheck_requested_v1:c2f91038e30cd3ca35c5edeecd8f28d5b98dcd0083c8fe7fca2a3087128a450a', '{"status": "processing", "started_at": 1753711770.669545, "processed_by": "spell-checker-service", "event_id": "4ee5c8d5-ce02-4ea6-bffc-f546cca85463", "correlation_id": "cc344491-c2c3-4e64-9c27-b580f44b8711", "source_service": "essay_lifecycle_service"}', 300)])
E    +    where [('huleedu:idempotency:v2:spell-checker-service:huleedu_essay_spellcheck_requested_v1:c2f91038e30cd3ca35c5edeecd8f28d5b98dcd0083c8fe7fca2a3087128a450a', '{"status": "processing", "started_at": 1753711770.669545, "processed_by": "spell-checker-service", "event_id": "4ee5c8d5-ce02-4ea6-bffc-f546cca85463", "correlation_id": "cc344491-c2c3-4e64-9c27-b580f44b8711", "source_service": "essay_lifecycle_service"}', 300)] = <services.spellchecker_service.tests.unit.test_kafka_consumer_integration.MockRedisClient object at 0x12484f510>.set_calls
------------------------------ Captured log call -------------------------------
INFO     huleedu_service_libs.logging_utils:logging_utils.py:147 [2m2025-07-28T14:09:30.670888Z[0m [[32m[1minfo     [0m] [1mReceived spellcheck request   [0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mcurrent_processing_event[0m=[35messay.spellcheck.requested[0m [36mcurrent_processing_stage[0m=[35mpending[0m [36mevent_data_type[0m=[35mEssayLifecycleSpellcheckRequestV1[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mfilename[0m=[35mlogging_utils.py[0m [36mfunc_name[0m=[35mlog_event_processing[0m [36mlineno[0m=[35m147[0m [36msource_service[0m=[35messay_lifecycle_service[0m
INFO     huleedu_service_libs.logging_utils:event_processor.py:290 [2m2025-07-28T14:09:30.671406Z[0m [[32m[1minfo     [0m] [1mStep 1: Fetching content for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m290[0m [36msource_service[0m=[35messay_lifecycle_service[0m
INFO     huleedu_service_libs.logging_utils:event_processor.py:303 [2m2025-07-28T14:09:30.671681Z[0m [[32m[1minfo     [0m] [1mStep 2: Content fetched successfully for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m303[0m [36msource_service[0m=[35messay_lifecycle_service[0m
INFO     huleedu_service_libs.logging_utils:event_processor.py:351 [2m2025-07-28T14:09:30.671818Z[0m [[32m[1minfo     [0m] [1mStep 3: Performing spell check for essay e45ff674-e2d1-49cd-8729-a987a01eeb77[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m351[0m [36msource_service[0m=[35messay_lifecycle_service[0m
ERROR    huleedu_service_libs.logging_utils:event_processor.py:482 [2m2025-07-28T14:09:30.673488Z[0m [[31m[1merror    [0m] [1mEssay e45ff674-e2d1-49cd-8729-a987a01eeb77: Unhandled error processing message: '<=' not supported between instances of 'MagicMock' and 'float'[0m [[0m[1m[34mspellchecker_service.event_processor[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711'}[0m [36mfilename[0m=[35mevent_processor.py[0m [36mfunc_name[0m=[35m_process_single_message_impl[0m [36mlineno[0m=[35m482[0m [36msource_service[0m=[35messay_lifecycle_service[0m
Traceback (most recent call last):
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/services/spellchecker_service/event_processor.py", line 390, in _process_single_message_impl
    corrections_metric.observe(result_data.corrections_made)
  File "/Users/olofs_mba/Documents/Repos/huledu-reboot/.venv/lib/python3.11/site-packages/prometheus_client/metrics.py", line 629, in observe
    if amount <= bound:
       ^^^^^^^^^^^^^^^
TypeError: '<=' not supported between instances of 'MagicMock' and 'float'
WARNING  huleedu_service_libs.logging_utils:idempotency_v2.py:189 [2m2025-07-28T14:09:30.674519Z[0m [[33m[1mwarning  [0m] [1mDUPLICATE_EVENT_DETECTED: Event already completed[0m [[0m[1m[34midempotency-v2[0m][0m [36mcorrelation_id[0m=[35mcc344491-c2c3-4e64-9c27-b580f44b8711[0m [36mevent_id[0m=[35m4ee5c8d5-ce02-4ea6-bffc-f546cca85463[0m [36mevent_type[0m=[35mhuleedu.essay.spellcheck.requested.v1[0m [36mextra[0m=[35m{'service': 'spell-checker-service', 'event_type': 'huleedu.essay.spellcheck.requested.v1', 'event_id': '4ee5c8d5-ce02-4ea6-bffc-f546cca85463', 'correlation_id': 'cc344491-c2c3-4e64-9c27-b580f44b8711', 'source_service': 'essay_lifecycle_service', 'deterministic_hash': 'c2f91038e30cd3ca...', 'redis_key': 'huleedu:idempotency:v2:spell-checker-service:huleedu_essay_spellcheck_requested_v1:c2f91038e30cd3ca35c5edeecd8f28d5b98dcd0083c8fe7fca2a3087128a450a', 'kafka_topic': 'huleedu.essay.spellcheck.requested.v1', 'kafka_partition': 0, 'kafka_offset': 12345, 'action': 'skipped_duplicate', 'status': 'completed'}[0m [36mfilename[0m=[35midempotency_v2.py[0m [36mfunc_name[0m=[35mwrapper[0m [36mlineno[0m=[35m189[0m [36msource_service[0m=[35messay_lifecycle_service[0m
============================= slowest 10 durations =============================
3.21s call     tests/functional/test_e2e_idempotency.py::TestE2EPipelineIdempotency::test_pipeline_with_duplicate_injection
1.83s setup    services/spellchecker_service/tests/test_redis_integration.py::test_redis_idempotency_pattern_with_testcontainer
0.20s call     tests/functional/test_e2e_idempotency.py::TestControlledIdempotencyScenarios::test_v2_cross_service_isolation
0.20s teardown services/spellchecker_service/tests/test_redis_integration.py::test_redis_idempotency_pattern_with_testcontainer
0.02s call     services/spellchecker_service/tests/test_redis_integration.py::test_redis_idempotency_pattern_with_testcontainer
0.01s call     services/spellchecker_service/tests/unit/test_kafka_consumer_integration.py::test_kafka_consumer_with_idempotency_duplicate_detection
0.01s call     services/spellchecker_service/tests/unit/test_kafka_consumer_integration.py::test_kafka_consumer_with_idempotency_first_time_processing
0.01s setup    services/spellchecker_service/tests/unit/test_kafka_consumer_integration.py::test_kafka_consumer_with_idempotency_first_time_processing

(2 durations < 0.005s hidden.  Use -vv to show these durations.)
=========================== short test summary info ============================
FAILED services/spellchecker_service/tests/unit/test_kafka_consumer_integration.py::test_kafka_consumer_with_idempotency_duplicate_detection
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
================= 1 failed, 9 passed, 1353 deselected in 6.90s =================
