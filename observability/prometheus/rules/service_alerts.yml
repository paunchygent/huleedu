groups:
- name: HuleEduServiceAlerts
  rules:
  - alert: ServiceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Service {{ $labels.job }} is down"
      description: "The Prometheus target for {{ $labels.job }} has been down for more than 1 minute."
      dashboard_url: "http://localhost:3000/d/huleedu-system-health/huleedu-system-health-overview"
      runbook_url: "http://localhost:3000/d/huleedu-service-deep-dive/huleedu-service-deep-dive?var-service={{ $labels.job }}"
      
  - alert: HighErrorRate
    expr: huleedu:http_errors_5xx:rate5m > 0.1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High 5xx error rate across HuleEdu services"
      description: "HuleEdu services are experiencing {{ $value }} 5xx errors per second over the last 5 minutes."
      dashboard_url: "http://localhost:3000/d/huleedu-system-health/huleedu-system-health-overview"
      runbook_url: "file:///app/Documentation/OPERATIONS/01-Grafana-Playbook.md#high-error-rate"

  - alert: LLMPromptCacheLowHitRate
    expr: |
      (
        sum(rate(llm_provider_cache_scope_total{provider="anthropic", scope="assignment", result="hit"}[5m]))
        /
        clamp_min(sum(rate(llm_provider_cache_scope_total{provider="anthropic", scope="assignment"}[5m])), 0.001)
      ) < 0.4
      and sum(rate(llm_provider_cache_scope_total{provider="anthropic", scope="assignment"}[5m])) > 0.1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "LLM prompt cache hit rate low (Anthropic)"
      description: "Prompt cache hit rate is {{ $value | humanizePercentage }} over 5m; review prompt segmentation or TTL configuration."
      dashboard_url: "http://localhost:3000/d/huleedu-llm-prompt-cache/llm-provider-prompt-cache"
      runbook_url: "http://localhost:3000/d/huleedu-llm-prompt-cache/llm-provider-prompt-cache"

  - alert: LLMPromptTTLOutOfOrder
    expr: increase(llm_provider_prompt_ttl_violations_total[5m]) > 0
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Prompt TTL ordering violations detected"
      description: "Prompt TTL ordering failed in the last 5m for provider {{ $labels.provider }} / model {{ $labels.model }} (stage={{ $labels.stage }})."
      dashboard_url: "http://localhost:3000/d/huleedu-llm-prompt-cache/llm-provider-prompt-cache"

- name: DistributedTracingAlerts
  rules:
  - alert: HighTraceErrorRate
    expr: |
      (sum(rate(span_errors_total[5m])) by (service_name, operation))
      / (sum(rate(span_total[5m])) by (service_name, operation)) > 0.1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High error rate in {{ $labels.service_name }} - {{ $labels.operation }}"
      description: "Operation {{ $labels.operation }} in service {{ $labels.service_name }} has {{ $value | humanizePercentage }} error rate over the last 5 minutes."
      trace_search: "http://localhost:16686/search?service={{ $labels.service_name }}&operation={{ $labels.operation }}&lookback=1h&tags=%7B%22error%22%3A%22true%22%7D"
      dashboard_url: "http://localhost:3000/d/huleedu-distributed-tracing/huleedu-distributed-tracing?var-service={{ $labels.service_name }}"
  
  - alert: StorageReferencePropagationFailure
    expr: |
      rate(els_storage_reference_failures_total[5m]) > 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Storage reference propagation failures detected"
      description: "Essay Lifecycle Service is experiencing {{ $value }} storage reference failures per second."
      dashboard_url: "http://localhost:3000/d/tier2-els/essay-lifecycle-service"
      trace_search: "http://localhost:16686/search?service=essay_lifecycle_service&lookback=15m&tags=%7B%22error%22%3A%22true%22%7D"
  
  - alert: TraceContextLoss
    expr: |
      (sum by (service_name) (rate(span_total{parent_span_id=""}[5m])))
      / (sum by (service_name) (rate(span_total[5m]))) > 0.5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Possible trace context loss in {{ $labels.service_name }}"
      description: "Service {{ $labels.service_name }} has {{ $value | humanizePercentage }} of spans without parent context, indicating possible trace propagation issues."
      dashboard_url: "http://localhost:3000/d/huleedu-distributed-tracing/huleedu-distributed-tracing?var-service={{ $labels.service_name }}"
  
  - alert: ServiceLatencyHigh
    expr: |
      histogram_quantile(0.95, sum(rate(span_duration_bucket[5m])) by (service_name, le)) > 1000
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High P95 latency for {{ $labels.service_name }}"
      description: "Service {{ $labels.service_name }} has P95 latency of {{ $value }}ms over the last 5 minutes."
      trace_search: "http://localhost:16686/search?service={{ $labels.service_name }}&lookback=1h&minDuration=1000000"
      dashboard_url: "http://localhost:3000/d/huleedu-distributed-tracing/huleedu-distributed-tracing?var-service={{ $labels.service_name }}"
  
  - alert: CircuitBreakerOpen
    expr: |
      (
        llm_provider_circuit_breaker_state == 1 or
        bos_circuit_breaker_state == 1 or
        els_circuit_breaker_state == 1 or
        cj_assessment_circuit_breaker_state == 1 or
        class_management_circuit_breaker_state == 1 or
        file_service_circuit_breaker_state == 1 or
        spellchecker_circuit_breaker_state == 1
      )
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Circuit breaker OPEN for {{ $labels.circuit_name }}"
      description: "Circuit breaker '{{ $labels.circuit_name }}' in service {{ $labels.service_name }} is OPEN, blocking all requests."
      dashboard_url: "http://localhost:3000/d/huleedu-service-deep-dive/huleedu-service-deep-dive?var-service={{ $labels.service_name }}"

- name: InfrastructureAlerts
  rules:
  - alert: KafkaExporterDown
    expr: up{job="kafka_exporter"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Kafka exporter is down"
      description: "Kafka monitoring is unavailable - exporter has been down for more than 1 minute."
      dashboard_url: "http://localhost:3000/d/huleedu-system-health/huleedu-system-health-overview"

  - alert: PostgreSQLExporterDown
    expr: up{job="postgres_exporter"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "PostgreSQL exporter is down"
      description: "PostgreSQL monitoring is unavailable - exporter has been down for more than 1 minute."
      dashboard_url: "http://localhost:3000/d/huleedu-system-health/huleedu-system-health-overview"

  - alert: RedisExporterDown
    expr: up{job="redis_exporter"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Redis exporter is down"
      description: "Redis monitoring is unavailable - exporter has been down for more than 1 minute."
      dashboard_url: "http://localhost:3000/d/huleedu-system-health/huleedu-system-health-overview"

  - alert: LowServiceAvailability
    expr: huleedu:service_availability:percent < 80
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Low overall service availability"
      description: "Overall service availability is {{ $value }}% - below 80% threshold."
      dashboard_url: "http://localhost:3000/d/huleedu-system-health/huleedu-system-health-overview"

  - alert: HighKafkaLatency
    expr: huleedu:kafka_latency:mean > 1.0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High Kafka message queue latency"
      description: "Kafka message queue latency is {{ $value }}s - higher than 1s threshold."
      dashboard_url: "http://localhost:3000/d/huleedu-system-health/huleedu-system-health-overview"

- name: DatabaseAlerts
  rules:
  - alert: DatabaseConnectionPoolExhaustion
    expr: |
      (
        (batch_orchestrator_service_database_connections_active / batch_orchestrator_service_database_connections_total) > 0.90 or
        (essay_lifecycle_service_database_connections_active / essay_lifecycle_service_database_connections_total) > 0.90 or
        (cj_assessment_service_database_connections_active / cj_assessment_service_database_connections_total) > 0.90 or
        (class_management_service_database_connections_active / class_management_service_database_connections_total) > 0.90 or
        (result_aggregator_service_database_connections_active / result_aggregator_service_database_connections_total) > 0.90 or
        (spellchecker_service_database_connections_active / spellchecker_service_database_connections_total) > 0.90
      )
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Database connection pool near exhaustion"
      description: "Database connection pool utilization is {{ $value | humanizePercentage }} for service {{ $labels.service_name }}"
      dashboard_url: "http://localhost:3000/d/huleedu-database-deep-dive/huleedu-database-deep-dive?var-service={{ $labels.service_name }}"
      runbook_url: "file:///app/Documentation/OPERATIONS/01-Grafana-Playbook.md#database-connection-pool-exhaustion"

  - alert: HighDatabaseQueryLatency
    expr: |
      (
        histogram_quantile(0.95, sum(rate(batch_orchestrator_service_database_query_duration_seconds_bucket[5m])) by (le)) > 1 or
        histogram_quantile(0.95, sum(rate(essay_lifecycle_service_database_query_duration_seconds_bucket[5m])) by (le)) > 1 or
        histogram_quantile(0.95, sum(rate(cj_assessment_service_database_query_duration_seconds_bucket[5m])) by (le)) > 1 or
        histogram_quantile(0.95, sum(rate(class_management_service_database_query_duration_seconds_bucket[5m])) by (le)) > 1 or
        histogram_quantile(0.95, sum(rate(result_aggregator_service_database_query_duration_seconds_bucket[5m])) by (le)) > 1 or
        histogram_quantile(0.95, sum(rate(spellchecker_service_database_query_duration_seconds_bucket[5m])) by (le)) > 1
      )
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High database query latency detected"
      description: "95th percentile database query duration is {{ $value }}s - higher than 1s threshold"
      dashboard_url: "http://localhost:3000/d/huleedu-database-troubleshooting/huleedu-database-troubleshooting"
      runbook_url: "file:///app/Documentation/OPERATIONS/01-Grafana-Playbook.md#high-database-query-latency"

  - alert: DatabaseConnectivityFailure
    expr: |
      (
        sum(rate(batch_orchestrator_service_database_errors_total[5m])) > 0.1 or
        sum(rate(essay_lifecycle_service_database_errors_total[5m])) > 0.1 or
        sum(rate(cj_assessment_service_database_errors_total[5m])) > 0.1 or
        sum(rate(class_management_service_database_errors_total[5m])) > 0.1 or
        sum(rate(result_aggregator_service_database_errors_total[5m])) > 0.1 or
        sum(rate(spellchecker_service_database_errors_total[5m])) > 0.1
      )
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Database connectivity failures detected"
      description: "Database error rate is {{ $value }} errors per second for service {{ $labels.service_name }}"
      dashboard_url: "http://localhost:3000/d/huleedu-database-health/huleedu-database-health-overview"
      runbook_url: "file:///app/Documentation/OPERATIONS/01-Grafana-Playbook.md#database-connectivity-failure"

  - alert: DatabaseTransactionFailureRate
    expr: |
      (
        (rate(batch_orchestrator_service_database_transaction_duration_seconds_count{result="error"}[5m]) / rate(batch_orchestrator_service_database_transaction_duration_seconds_count[5m])) > 0.05 or
        (rate(essay_lifecycle_service_database_transaction_duration_seconds_count{result="error"}[5m]) / rate(essay_lifecycle_service_database_transaction_duration_seconds_count[5m])) > 0.05 or
        (rate(cj_assessment_service_database_transaction_duration_seconds_count{result="error"}[5m]) / rate(cj_assessment_service_database_transaction_duration_seconds_count[5m])) > 0.05 or
        (rate(class_management_service_database_transaction_duration_seconds_count{result="error"}[5m]) / rate(class_management_service_database_transaction_duration_seconds_count[5m])) > 0.05 or
        (rate(result_aggregator_service_database_transaction_duration_seconds_count{result="error"}[5m]) / rate(result_aggregator_service_database_transaction_duration_seconds_count[5m])) > 0.05 or
        (rate(spellchecker_service_database_transaction_duration_seconds_count{result="error"}[5m]) / rate(spellchecker_service_database_transaction_duration_seconds_count[5m])) > 0.05
      )
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "High database transaction failure rate"
      description: "Database transaction failure rate is {{ $value | humanizePercentage }} for service {{ $labels.service_name }}"
      dashboard_url: "http://localhost:3000/d/huleedu-database-troubleshooting/huleedu-database-troubleshooting"
      runbook_url: "file:///app/Documentation/OPERATIONS/01-Grafana-Playbook.md#database-transaction-failures"

  - alert: ConnectionPoolLeak
    expr: |
      (
        increase(batch_orchestrator_service_database_connections_acquired_total[10m]) - increase(batch_orchestrator_service_database_connections_released_total[10m]) > 5 or
        increase(essay_lifecycle_service_database_connections_acquired_total[10m]) - increase(essay_lifecycle_service_database_connections_released_total[10m]) > 5 or
        increase(cj_assessment_service_database_connections_acquired_total[10m]) - increase(cj_assessment_service_database_connections_released_total[10m]) > 5 or
        increase(class_management_service_database_connections_acquired_total[10m]) - increase(class_management_service_database_connections_released_total[10m]) > 5 or
        increase(result_aggregator_service_database_connections_acquired_total[10m]) - increase(result_aggregator_service_database_connections_released_total[10m]) > 5 or
        increase(spellchecker_service_database_connections_acquired_total[10m]) - increase(spellchecker_service_database_connections_released_total[10m]) > 5
      )
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Potential database connection pool leak detected"
      description: "Connection pool leak detected - {{ $value }} more connections acquired than released over 10 minutes for service {{ $labels.service_name }}"
      dashboard_url: "http://localhost:3000/d/huleedu-database-deep-dive/huleedu-database-deep-dive?var-service={{ $labels.service_name }}"
      runbook_url: "file:///app/Documentation/OPERATIONS/01-Grafana-Playbook.md#connection-pool-leak" 
