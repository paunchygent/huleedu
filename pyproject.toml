[project]
name = "huledu-monorepo"
version = "0.2.0"
description = "HuleEdu Monorepo - Reboot to Microservices"
authors = [
    { name = "Olof Larsson", email = "paunchygent@gmail.com" },
]
readme = "README.md"
requires-python = ">=3.11"
license = {text = "MIT"}

# Minimal root dependencies - most deps are per-service or in common_core
dependencies = [
    "python-dotenv",
    "pypandoc",
    "aiohttp",
    "httpx",
    "pytest",
    "pytest-asyncio",
    "pytest-timeout",
    "pydantic",
    "pydantic-settings",
    "PyJWT",  # For test authentication
]

[tool.pdm]
distribution = false

# PDM configuration - using defaults (inherit_metadata=True is already default)

[dependency-groups]
# Tools for overall monorepo management - let PDM resolve latest compatible versions
monorepo-tools = [
    "ruff",
    "mypy",
    "pytest",
    "pytest-mock",
    "pytest-cov",
    "pytest-asyncio",
    "pytest-xdist",
    "httpx",
    "pre-commit",
    "testcontainers[postgres,kafka]",  # For PostgreSQL and Kafka integration tests
    "kafka-python",
    "respx",
]

# Install all services and common_core for unified development
dev = [
    "-e file:///${PROJECT_ROOT}/common_core",
    "-e file:///${PROJECT_ROOT}/services/libs",
    "-e file:///${PROJECT_ROOT}/services/content_service",
    "-e file:///${PROJECT_ROOT}/services/spell_checker_service",
    "-e file:///${PROJECT_ROOT}/services/batch_orchestrator_service",
    "-e file:///${PROJECT_ROOT}/services/essay_lifecycle_service",
    "-e file:///${PROJECT_ROOT}/services/file_service",
    "-e file:///${PROJECT_ROOT}/services/cj_assessment_service",
    "-e file:///${PROJECT_ROOT}/services/class_management_service",
    "-e file:///${PROJECT_ROOT}/services/api_gateway_service",
    "-e file:///${PROJECT_ROOT}/services/result_aggregator_service"
]

[tool.pdm.scripts]
# Monorepo-wide scripts
format-all = "ruff format --force-exclude ."
lint-all = "ruff check --force-exclude ."
lint-fix = "ruff check --fix --force-exclude ."
typecheck-all = "mypy --config-file pyproject.toml ."
test-all = "pytest"
test-parallel = "pytest -n auto"
test-sequential = "pytest -n 0"

# Docker convenience scripts - Development workflow
# Quick commands
dc-up = "docker compose up -d"  # Start services (uses existing images)
dc-build = "docker compose up -d --build"  # Rebuild and start services
dc-down = "docker compose down --remove-orphans"  # Stop and clean up
dc-logs = "docker compose logs -f --tail=100"  # Follow logs with last 100 lines
dc-ps = "docker compose ps"  # Show running services

# Service-specific commands (use service names as arguments)
dc-restart = "docker compose restart"  # Restart service: pdm run dc-restart api_gateway_service
dc-rebuild = "docker compose up -d --build"  # Rebuild specific service: pdm run dc-rebuild batch_orchestrator_service
dc-logs-service = "docker compose logs -f --tail=50"  # Logs for specific service: pdm run dc-logs-service content_service

# Development workflow commands
dev-up = "docker compose up -d"  # Start with volume mounts (uses override file)
dev-build = "DOCKER_BUILDKIT=1 docker compose build --parallel"  # Fast parallel build
dev-rebuild = {composite = ["docker compose down --remove-orphans", "DOCKER_BUILDKIT=1 docker compose build --parallel", "docker compose up -d"]}
dev-fresh = "docker compose build --no-cache"  # Force fresh build (when caching issues occur)

# System management
docker-reset = {composite = ["docker compose down --remove-orphans --volumes", "docker compose build", "docker compose up -d"]}  # Full reset including volumes
docker-clean = "docker system prune -af --volumes"  # Clean all unused Docker resources (use with caution!)

# Individual service development
dev-content = "pdm run -p services/content_service dev"
dev-batch = "pdm run -p services/batch_orchestrator_service dev"
dev-file = "pdm run -p services/file_service dev"
run-spellchecker = "pdm run -p services/spell_checker_service start_worker"
dev-gateway = "pdm run -p services/api_gateway_service dev"
dev-aggregator = "pdm run -p services/result_aggregator_service dev"

# Build common_core wheel
build-common-core = "pdm build -p common_core"

# Kafka infrastructure
kafka-setup-topics = "python scripts/kafka_topic_bootstrap.py"

# Observability convenience scripts
obs-up = {composite = ["docker compose -f observability/docker-compose.observability.yml up -d"]}
obs-down = {composite = ["docker compose -f observability/docker-compose.observability.yml down"]}
obs-logs = {composite = ["docker compose -f observability/docker-compose.observability.yml logs -f"]}
obs-restart = {composite = ["docker compose -f observability/docker-compose.observability.yml restart"]}

[tool.ruff]
line-length = 100
target-version = "py311"
exclude = [
    ".git",
    ".venv",
    "__pycache__",
    ".mypy_cache",
    ".pytest_cache",
    ".ruff_cache",
    ".pdm-python",
    ".pdm-build",
    "common_core/.venv",
]

[tool.ruff.lint]
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
]
ignore = [
    "E203",  # whitespace before ':' (conflicts with black)
]

[tool.ruff.format]
  quote-style = "double"
  indent-style = "space"

[tool.ruff.lint.per-file-ignores]
# Allow imports after load_dotenv() in service entry points
"services/*/app.py" = ["E402"]
"services/*/worker.py" = ["E402"]
# Union import needed for Pydantic model rebuilding (not directly used in file)
"common_core/src/common_core/__init__.py" = ["F401"]

# Note: Import restrictions would be enforced through custom linting rules
# For now, rely on type system and code review to prevent standard library logging

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
check_untyped_defs = true
explicit_package_bases = true
namespace_packages = true
exclude = [
    "common_core/src/",
    "services/libs/huleedu_service_libs/",
    "cj_essay_assessment/",
]

# Per-module settings for new microservices (stricter)
[[tool.mypy.overrides]]
module = [
    "common_core.*",
    "services.libs.*",
    "services.content_service.*",
    "services.spell_checker_service.*",
    "services.batch_orchestrator_service.*",
    "services.essay_lifecycle_service.*",
    "services.file_service.*",
    "services.cj_assessment_service.*",
    "services.class_management_service.*",
]
ignore_missing_imports = false
disallow_untyped_defs = true

# External libraries without official type stubs
[[tool.mypy.overrides]]
module = [
    "aiokafka.*",
    "aiofiles.*",
    "dishka.*",
    "quart_dishka.*",
    "httpx.*",
    "spell_logic.*",
    "diskcache.*",
    "choix.*",
    "tenacity.*",
    "sqlalchemy.*",
    "asyncpg.*",
    "testcontainers.*",
    "kafka.*", # For kafka-python library
    "redis.*",  # Redis client library
    "enums_db",       # Database enum module without type stubs
    "models_db",      # Database models module without type stubs
    "yaml.*",       # PyYAML stubs
    "pypandoc.*",   # pypandoc lacks type stubs
    "fastapi.*",
    "starlette.*",
]
ignore_missing_imports = true

# Service-local config modules and API modules
[[tool.mypy.overrides]]
module = [
    "config", 
    "worker_main", 
    "core_logic", 
    "core_logic.*",
    "event_router", 
    "event_processor",
    "protocols", 
    "di", 
    "state_store", 
    "batch_command_handlers",
    "batch_tracker",
    "implementations.*",
    "protocol_implementations.*",
    "api.*",
    "api_models",
    "models_api",
    "kafka_consumer",
    "metrics",
    "startup_setup",
    "text_processing",
    "hypercorn_config",
    "pair_generation",
    "scoring_ranking",
    "core_assessment_logic",
    "transitions.*",  # State machine library without type stubs
    "essay_state_machine",  # Local module without py.typed marker
]
ignore_missing_imports = true

[tool.pytest.ini_options]

testpaths = [
    "common_core/tests",
    "services/content_service/tests",
    "services/spell_checker_service/tests",
    "services/batch_orchestrator_service/tests",
    "services/essay_lifecycle_service/tests",
    "services/file_service/tests",
    "services/cj_assessment_service/tests",
    "services/class_management_service/tests",
    "tests"
]
pythonpath = [
    "."
]
python_files = "test_*.py *_test.py"
python_classes = "Test*"
python_functions = "test_*"
addopts = "-s -v --durations=10 --log-cli-level=INFO"
log_cli = true
log_cli_level = "INFO"
log_cli_format = "%(asctime)s [%(levelname)8s] %(name)s:%(filename)s:%(lineno)s %(message)s"
log_cli_date_format = "%Y-%m-%d %H:%M:%S"
asyncio_mode = "auto"

markers = [
    "slow: marks tests as slow running",
    "integration: marks tests requiring external services like Kafka",
    "docker: marks tests that need docker-compose setup",
    "kafka: marks tests requiring a Kafka instance",
    "e2e: marks tests as end-to-end pipeline tests",
    "functional: marks functional tests that verify cross-service behavior",
    "timeout: marks tests with specific timeout requirements",
]

filterwarnings = [
    "ignore::DeprecationWarning:pydantic.*",
    "ignore::DeprecationWarning:pkg_resources",
]

[build-system]
requires = ["pdm-backend"]
build-backend = "pdm.backend"
