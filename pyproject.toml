[project]
name = "huledu-monorepo"
version = "0.1.0"
description = "HuleEdu Monorepo - Reboot to Microservices"
authors = [
    { name = "Olof Larsson", email = "paunchygent@gmail.com" },
]
readme = "README.md"
requires-python = ">=3.11"
license = {text = "MIT"}

# Minimal root dependencies - most deps are per-service or in common_core
dependencies = [
    "python-dotenv>=1.0.0",
]

[tool.pdm]
distribution = false

[dependency-groups]
# Tools for overall monorepo management
monorepo-tools = [
    "black>=24.4.0",
    "isort>=5.13.2",
    "flake8>=7.0.0",
    "mypy>=1.9.0",
    "pytest>=8.0.0",
    "pytest-cov>=5.0.0",
    "pytest-asyncio>=0.23.0",
    "pre-commit>=3.6.0"
]

# Install all new services and common_core for unified development
dev = [
    "-e file:///${PROJECT_ROOT}/common_core",
    "-e file:///${PROJECT_ROOT}/services/libs",
    "-e file:///${PROJECT_ROOT}/services/content_service", 
    "-e file:///${PROJECT_ROOT}/services/spell_checker_service",
    "-e file:///${PROJECT_ROOT}/services/batch_service",
]

[tool.pdm.scripts]
# Monorepo-wide scripts
format-all = { composite = ["black .", "isort ."] }
lint-all = "flake8 ."
typecheck-all = "mypy --config-file pyproject.toml ."
test-all = "pytest -n auto"

# Docker convenience scripts
docker-build = "docker compose build"
docker-up = "docker compose up -d"
docker-down = "docker compose down"
docker-logs = "docker compose logs -f --tail=100"
docker-restart = {composite = ["docker compose down", "docker compose up -d --build"]}

# Individual service development
dev-content = "pdm run -p services/content_service dev"
dev-batch = "pdm run -p services/batch_service dev"
run-spellchecker = "pdm run -p services/spell_checker_service start_worker"

# Build common_core wheel
build-common-core = "pdm build -p common_core"

[tool.black]
line-length = 88
target-version = ['py311']
exclude = '''
/(
    \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | _build
  | buck-out
  | build
  | dist
  | __pypackages__ 
)/
'''

[tool.isort]
profile = "black"
multi_line_output = 3
skip_glob = ["*/.venv/*", "*/__pypackages__/*"]

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
check_untyped_defs = true
explicit_package_bases = true
exclude = [
    "common_core/src/",
    ".venv/",
    "__pypackages__/",
    ".pdm-build/"
]

# Per-module settings for new microservices (stricter)
[[tool.mypy.overrides]]
module = [
    "common_core.*",
    "services.libs.*",
    "services.content_service.*",
    "services.spell_checker_service.*",
    "services.batch_service.*"
]
ignore_missing_imports = false
disallow_untyped_defs = true

# Existing code (less strict initially)
[[tool.mypy.overrides]]
module = [
    "server_web_app.*",
    "ai_feedback_svenska.*",
    "common.*",
    "CJ_ESSAY_ASSESSMENT.*"
]
ignore_missing_imports = true
disallow_untyped_defs = false

[tool.pytest.ini_options]
testpaths = [
    "common_core/tests", 
    "services/content_service/tests",
    "services/spell_checker_service/tests",
    "services/batch_service/tests",
    "tests"
]
python_files = "test_*.py *_test.py"
python_classes = "Test*"
python_functions = "test_*"
addopts = "-s -v --durations=10 -n auto --log-cli-level=INFO" 
log_cli = true
log_cli_level = "INFO"
log_cli_format = "%(asctime)s [%(levelname)8s] %(name)s:%(filename)s:%(lineno)s %(message)s"
log_cli_date_format = "%Y-%m-%d %H:%M:%S"
asyncio_mode = "auto"

markers = [
    "slow: marks tests as slow running",
    "integration: marks tests requiring external services like Kafka",
    "docker: marks tests that need docker-compose setup",
    "kafka: marks tests requiring a Kafka instance",
]

filterwarnings = [
    "ignore::DeprecationWarning:pydantic.*",
    "ignore::DeprecationWarning:pkg_resources",
]

[build-system]
requires = ["pdm-backend"]
build-backend = "pdm.backend" 