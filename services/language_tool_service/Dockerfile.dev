# Development-optimized Dockerfile with improved layer caching
# Use this for development with volume mounts for hot-reload

FROM python:3.11-slim AS base

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PDM_USE_VENV=false \
    ENV_TYPE=docker \
    PYTHONPATH=/app \
    QUART_APP=app:app \
    QUART_ENV=development

# Install system dependencies including Java 21 (rarely change - good cache layer)
RUN apt-get update && apt-get install -y \
    --no-install-recommends \
    curl \
    wget \
    unzip \
    build-essential \
    python3-dev \
    openjdk-21-jre-headless \
    && rm -rf /var/lib/apt/lists/*

# Install PDM (rarely changes - good cache layer)
RUN pip install --no-cache-dir pdm

# Download LanguageTool (rarely changes - good cache layer)
RUN mkdir -p /app/languagetool && \
    cd /app/languagetool && \
    wget -q https://languagetool.org/download/LanguageTool-stable.zip && \
    unzip -q LanguageTool-stable.zip && \
    mv LanguageTool-*/* . && \
    rm -rf LanguageTool-* LanguageTool-stable.zip

WORKDIR /app

# ========================================
# DEPENDENCY INSTALLATION OPTIMIZATION
# ========================================

# First, copy only dependency files for better caching
# This layer will only rebuild when dependencies change
COPY libs/common_core/pyproject.toml /app/libs/common_core/pyproject.toml
COPY libs/huleedu_service_libs/pyproject.toml /app/libs/huleedu_service_libs/pyproject.toml
COPY services/language_tool_service/pyproject.toml /app/services/language_tool_service/pyproject.toml

# Generate lockfile if it doesn't exist (better than --frozen-lockfile for dev)
WORKDIR /app/services/language_tool_service
RUN pdm lock --lockfile pdm.lock.docker || echo "Lock generation failed, will install without lock"

# Now copy the source files for shared libraries
# These change more frequently but still less than service code
COPY libs/common_core/src/ /app/libs/common_core/src/
COPY libs/huleedu_service_libs/src/ /app/libs/huleedu_service_libs/src/

# Install dependencies (this layer caches well if pyproject.toml doesn't change)
# Use lockfile if it exists, otherwise install normally
RUN if [ -f "pdm.lock.docker" ]; then \
        pdm install --dev --lockfile pdm.lock.docker; \
    else \
        pdm install --dev; \
    fi

# ========================================
# DEVELOPMENT STAGE (for volume mounts)
# ========================================
FROM base AS development

# Create user first
RUN groupadd -r appuser && useradd --no-log-init -r -g appuser appuser

# Copy service code (this layer changes most frequently)
COPY services/language_tool_service/ /app/services/language_tool_service/

# Set permissions
RUN chown -R appuser:appuser /app

USER appuser
WORKDIR /app/services/language_tool_service

# Environment variables for development
ENV LANGUAGE_TOOL_SERVICE_PORT=8085 \
    LANGUAGE_TOOL_SERVICE_HOST=0.0.0.0 \
    LANGUAGE_TOOL_SERVICE_LOG_LEVEL=DEBUG

# Expose the service port
EXPOSE 8085

# Use pdm run for development with auto-reload
CMD ["pdm", "run", "dev"]

# ========================================
# PRODUCTION STAGE (for deployment)
# ========================================
FROM base AS production

# Copy service code for production build
COPY services/language_tool_service/ /app/services/language_tool_service/

# Create user and set permissions
RUN groupadd -r appuser && useradd --no-log-init -r -g appuser appuser \
    && chown -R appuser:appuser /app

USER appuser
WORKDIR /app/services/language_tool_service

# Environment variables for production
ENV LANGUAGE_TOOL_SERVICE_PORT=8085 \
    LANGUAGE_TOOL_SERVICE_HOST=0.0.0.0 \
    LANGUAGE_TOOL_SERVICE_LOG_LEVEL=INFO

# Expose the service port
EXPOSE 8085

CMD ["pdm", "run", "start"]