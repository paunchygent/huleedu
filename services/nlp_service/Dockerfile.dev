# Development-optimized Dockerfile with improved layer caching
# Use this for development with volume mounts for hot-reload

FROM python:3.11-slim AS base

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PDM_USE_VENV=false \
    ENV_TYPE=docker \
    PYTHONPATH=/app

# Install system dependencies (rarely change - good cache layer)
RUN apt-get update && apt-get install -y \
    --no-install-recommends \
    curl \
    build-essential \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install PDM (rarely changes - good cache layer)
RUN pip install --no-cache-dir pdm

WORKDIR /app

# ========================================
# DEPENDENCY INSTALLATION OPTIMIZATION
# ========================================

# First, copy only dependency files for better caching
# This layer will only rebuild when dependencies change
COPY libs/common_core/pyproject.toml /app/libs/common_core/pyproject.toml
COPY libs/huleedu_service_libs/pyproject.toml /app/libs/huleedu_service_libs/pyproject.toml
COPY libs/huleedu_nlp_shared/pyproject.toml /app/libs/huleedu_nlp_shared/pyproject.toml
COPY services/nlp_service/pyproject.toml /app/services/nlp_service/pyproject.toml

# Generate lockfile if it doesn't exist (better than --frozen-lockfile for dev)
WORKDIR /app/services/nlp_service
RUN pdm lock --lockfile pdm.lock.docker || echo "Lock generation failed, will install without lock"

# Now copy the source files for shared libraries
# These change more frequently but still less than service code
COPY libs/common_core/src/ /app/libs/common_core/src/
COPY libs/huleedu_service_libs/src/ /app/libs/huleedu_service_libs/src/
COPY libs/huleedu_nlp_shared/src/ /app/libs/huleedu_nlp_shared/src/

# Install dependencies (this layer caches well if pyproject.toml doesn't change)
# Use lockfile if it exists, otherwise install normally
RUN if [ -f "pdm.lock.docker" ]; then \
        pdm install --dev --lockfile pdm.lock.docker; \
    else \
        pdm install --dev; \
    fi

# ========================================
# DEVELOPMENT STAGE (for volume mounts)
# ========================================
FROM base AS development

# Create user first
RUN groupadd -r nlpuser && useradd --no-log-init -r -g nlpuser nlpuser

# Copy service code (this layer changes most frequently)
COPY services/nlp_service/ /app/services/nlp_service/

# Set permissions
RUN chown -R nlpuser:nlpuser /app

USER nlpuser
WORKDIR /app/services/nlp_service

# Use pdm run for development with auto-reload
CMD ["pdm", "run", "start"]

# ========================================
# PRODUCTION STAGE (for deployment)
# ========================================
FROM base AS production

# Copy service code for production build
COPY services/nlp_service/ /app/services/nlp_service/

# Create user and set permissions
RUN groupadd -r nlpuser && useradd --no-log-init -r -g nlpuser nlpuser \
    && chown -R nlpuser:nlpuser /app

USER nlpuser
WORKDIR /app/services/nlp_service

CMD ["pdm", "run", "start"]