# Docker Compose configuration for NLP Phase 2 E2E Testing
# This configuration starts actual services for TRUE end-to-end pipeline testing

networks:
  huleedu_test_network:
    driver: bridge

volumes:
  essay_lifecycle_db_test_data:
  nlp_db_test_data:
  redis_test_data:

services:
  # Infrastructure Services
  
  zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: huleedu_test_zookeeper
    networks:
      - huleedu_test_network
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000
    healthcheck:
      test: 
        - CMD-SHELL
        - "echo 'ruok' | nc localhost 2181 | grep imok"
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  kafka:
    image: bitnami/kafka:3.7
    container_name: huleedu_test_kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - huleedu_test_network
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092,EXTERNAL://0.0.0.0:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,EXTERNAL://localhost:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=1
      # Test-specific optimizations
      - KAFKA_CFG_NUM_PARTITIONS=1
      - KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=1
      - KAFKA_CFG_LOG_FLUSH_INTERVAL_MESSAGES=1
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: huleedu_test_redis
    networks:
      - huleedu_test_network
    ports:
      - "6379:6379"
    volumes:
      - redis_test_data:/data
    command: 
      - redis-server 
      - --appendonly
      - "no" 
      - --maxmemory
      - 128mb
      - --maxmemory-policy
      - allkeys-lru
      - --save
      - ""
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Database Services
  
  essay_lifecycle_db:
    image: postgres:15-alpine
    container_name: huleedu_test_essay_lifecycle_db
    networks:
      - huleedu_test_network
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=huleedu_essay_lifecycle_test
      - POSTGRES_USER=huleedu_test_user
      - POSTGRES_PASSWORD=huleedu_test_password
      - POSTGRES_INITDB_ARGS=--auth-host=trust
    volumes:
      - essay_lifecycle_db_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U huleedu_test_user -d huleedu_essay_lifecycle_test"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  nlp_db:
    image: postgres:15-alpine
    container_name: huleedu_test_nlp_db
    networks:
      - huleedu_test_network
    ports:
      - "5437:5432"
    environment:
      - POSTGRES_DB=huleedu_nlp_test
      - POSTGRES_USER=huleedu_test_user
      - POSTGRES_PASSWORD=huleedu_test_password
      - POSTGRES_INITDB_ARGS=--auth-host=trust
    volumes:
      - nlp_db_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U huleedu_test_user -d huleedu_nlp_test"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Application Services
  
  essay_lifecycle_worker:
    build:
      context: ../../../
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_test_essay_lifecycle_worker
    depends_on:
      kafka:
        condition: service_healthy
      essay_lifecycle_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_test_network
    command:
      - pdm
      - run
      - start_worker
    environment:
      # Test mode configuration
      - ENV_TYPE=test
      - ENVIRONMENT=test
      - LOG_LEVEL=DEBUG
      - DISABLE_IDEMPOTENCY=false  # Test with idempotency enabled
      
      # Kafka configuration
      - ESSAY_LIFECYCLE_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - ESSAY_LIFECYCLE_SERVICE_KAFKA_CONSUMER_GROUP=essay-lifecycle-test-consumer
      - ESSAY_LIFECYCLE_SERVICE_KAFKA_CLIENT_ID=essay-lifecycle-test-client
      
      # Database configuration
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_URL=postgresql+asyncpg://huleedu_test_user:huleedu_test_password@essay_lifecycle_db:5432/huleedu_essay_lifecycle_test
      
      # Redis configuration
      - ESSAY_LIFECYCLE_SERVICE_REDIS_URL=redis://redis:6379
      
      # Service URLs (mocked for testing)
      - ESSAY_LIFECYCLE_SERVICE_CONTENT_SERVICE_URL=http://mock-content:8000/v1/content
      - ESSAY_LIFECYCLE_SERVICE_FILE_SERVICE_URL=http://mock-file:8000/v1/files
      
      # Observability (disabled for testing)
      - OTEL_TRACES_EXPORTER=none
      - OTEL_METRICS_EXPORTER=none
      
      # Test-specific timeouts
      - KAFKA_CONSUMER_SESSION_TIMEOUT_MS=10000
      - KAFKA_CONSUMER_HEARTBEAT_INTERVAL_MS=3000
      
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import asyncio; import aiokafka; print('OK')\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s

  nlp_service:
    build:
      context: ../../../
      dockerfile: services/nlp_service/Dockerfile
    container_name: huleedu_test_nlp_service
    depends_on:
      kafka:
        condition: service_healthy
      nlp_db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - huleedu_test_network
    command:
      - pdm
      - run
      - start_worker
    environment:
      # Test mode configuration
      - ENV_TYPE=test
      - ENVIRONMENT=test
      - LOG_LEVEL=DEBUG
      
      # Kafka configuration
      - NLP_SERVICE_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - NLP_SERVICE_KAFKA_CONSUMER_GROUP=nlp-service-test-consumer
      - NLP_SERVICE_KAFKA_CLIENT_ID=nlp-service-test-client
      
      # Database configuration
      - NLP_SERVICE_DATABASE_URL=postgresql+asyncpg://huleedu_test_user:huleedu_test_password@nlp_db:5432/huleedu_nlp_test
      
      # Redis configuration
      - NLP_SERVICE_REDIS_URL=redis://redis:6379
      
      # Service URLs (mocked for testing)
      - NLP_SERVICE_CONTENT_SERVICE_URL=http://mock-content:8000/v1/content
      
      # Observability (disabled for testing)
      - OTEL_TRACES_EXPORTER=none
      - OTEL_METRICS_EXPORTER=none
      
      # Test-specific timeouts and settings
      - KAFKA_CONSUMER_SESSION_TIMEOUT_MS=10000
      - KAFKA_CONSUMER_HEARTBEAT_INTERVAL_MS=3000
      - NLP_BATCH_SIZE=10  # Smaller batches for testing
      - NLP_PROCESSING_TIMEOUT=30  # Faster timeouts for testing
      
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import asyncio; import aiokafka; print('OK')\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 45s

  # Mock Services (for dependencies that aren't part of this test)
  
  mock_content_service:
    image: nginx:alpine
    container_name: huleedu_test_mock_content
    networks:
      - huleedu_test_network
    ports:
      - "8000:80"
    command: 
      - sh
      - -c
      - |
        echo 'server {
          listen 80;
          location /v1/content/ {
            return 200 '{"content": "Mock essay content for testing", "metadata": {"word_count": 150}}';
            add_header Content-Type application/json;
          }
          location /healthz {
            return 200 'OK';
            add_header Content-Type text/plain;
          }
        }' > /etc/nginx/conf.d/default.conf &&
        nginx -g 'daemon off;'
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Test Database Migration Service - runs once and exits
  
  migration_runner:
    build:
      context: ../../../
      dockerfile: services/essay_lifecycle_service/Dockerfile
    container_name: huleedu_test_migration_runner
    depends_on:
      essay_lifecycle_db:
        condition: service_healthy
      nlp_db:
        condition: service_healthy
    networks:
      - huleedu_test_network
    command:
      - sh
      - -c
      - |
        echo 'Starting migration runner...'
        echo 'ELS Database URL: postgresql+asyncpg://huleedu_test_user:huleedu_test_password@essay_lifecycle_db:5432/huleedu_essay_lifecycle_test'
        echo 'NLP Database URL: postgresql+asyncpg://huleedu_test_user:huleedu_test_password@nlp_db:5432/huleedu_nlp_test'
        echo 'Migration runner completed'
    environment:
      - ENV_TYPE=test
      - ENVIRONMENT=test
      - ESSAY_LIFECYCLE_SERVICE_DATABASE_URL=postgresql+asyncpg://huleedu_test_user:huleedu_test_password@essay_lifecycle_db:5432/huleedu_essay_lifecycle_test
      - NLP_SERVICE_DATABASE_URL=postgresql+asyncpg://huleedu_test_user:huleedu_test_password@nlp_db:5432/huleedu_nlp_test
    restart: "no"  # Run once and exit